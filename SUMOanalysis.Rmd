---
title: "No carbohydrate accumulation for growth-limited trees"
author: R. Alexander Thompson^1^, Henry D. Adams^1^, David D. Breshears^2^, Adam D. Collins^3^, L. Turin Dickman^3^,
  Charlotte Grossiord^4,5^, Àngela Manrique‐Alba^6^, Drew M. Peltier^7^, Michael G. Ryan^8^, Amy M. Trowbridge^9^, Nate G. McDowell^10,11^
date: "07/02/2022"
output:
  word_document:
    reference_docx: ref.docx
    fig_caption: yes
documentclass: article
bibliography: /Users/alexthompson/Dropbox/PhD data/SUMO data/Paper/SUMO_nature.bib
csl: /Users/alexthompson/Dropbox/PhD data/SUMO data/Paper/nature.csl
link-citations: yes
graphics: yes
header-includes: 
  - \usepackage{float} 
  - \setlength{\parindent}{4em}
  - \setlength{\parskip}{0em}d

---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(ggplot2)

library(lubridate)
library(car)
library(ggpubr)
library(broom)
library(dplyr)
library(lme4)
library(purrr)
library(bbmle)
library(data.table)
library(xtable)
library(gridExtra)
library(stargazer)
library(sjPlot)
library(knitr)
library(wesanderson)
library(eha)
library(inflection)
library(strucchange)
library(ggsignif)
library(kableExtra)
library(nlme)
library(flextable)
library(MetBrewer)






```

``` {r functions, include = FALSE}
sem <- function(x){
  sd(x)/sqrt(length(x))
}

detach_package <- function(pkg, character.only = FALSE)
{
  if(!character.only)
  {
    pkg <- deparse(substitute(pkg))
  }
  search_item <- paste("package", pkg, sep = ":")
  while(search_item %in% search())
  {
    detach(search_item, unload = TRUE, character.only = TRUE)
  }
}
```

```{r Photosynthesis, include=FALSE,results='asis'}

photo <- read.csv("Amax.csv") %>%
  mutate(Month = substr(as.character(Date), 6, 7)) %>%
  dplyr::select(Date,Year, Month, Tree_ID, Photo, Area, Trmmol)
photo$Month <- gsub("/", "", photo$Month)
jumo <- photo %>%
  filter(!grepl("P", Tree_ID)) %>%
  mutate(Species = "JUMO")
pipo <- photo %>%
  filter(!grepl("J", Tree_ID)) %>%
  mutate(Species = "PIED")
photo2 <- rbind(jumo, pipo)
photo3 <- photo2 %>%
  dplyr::select(Date,Year, Month, Species, Tree_ID, Photo, Trmmol) %>%
  dplyr::rename(ID = "Tree_ID")
photo3$ID <- gsub("J", "", photo3$ID)
photo3$ID <- gsub("P", "", photo3$ID)
photo3$ID <- gsub("(^|[^0-9])0+", "\\1", photo3$ID, perl = TRUE)

```

```{r WP, include=FALSE,results='asis'}

WP <- read.csv("waterpotential.csv", na.strings=c("", "NA"))
jumo <- WP %>%
  filter(!grepl("P", Tree_ID)) %>%
  mutate(Species = "JUMO")
pipo <- WP %>%
  filter(!grepl("J", Tree_ID)) %>%
  mutate(Species = "PIED")
WP2 <- rbind(jumo, pipo)
WP3 <- WP2 %>%
  dplyr::select(Year, Date, Species, Tree_ID, Ypd, Ymd) %>%
  dplyr::rename(ID = "Tree_ID")
WP3$ID <- gsub("J", "", WP3$ID)
WP3$ID <- gsub("P", "", WP3$ID)
WP3$ID <- gsub("(^|[^0-9])0+", "\\1", WP3$ID, perl = TRUE)
WP3 <- WP3 %>% 
  group_by(Date, Species) %>%
  mutate(Ypd_avg = mean(Ypd)) %>%
  mutate(Ymd_avg = mean(Ymd)) %>%
  ungroup() %>%
  group_by(Year, Species) %>%
  mutate(annYpd = mean(Ypd)) %>%
  mutate(annYmd = mean(Ymd))
WP3 <- WP3 %>%
  mutate(Month = substr(as.character(Date), 6, 7))
WP3$Month <- gsub("/", "", WP3$Month)
WP3 <- WP3 %>%
  ungroup() %>%
  dplyr::select(Date,Year, Month, Species, ID, Ypd)


averages<-WP3%>%
  dplyr::filter(Year==2013 | Year==2014)%>%
  drop_na()%>%
  dplyr::group_by(Species,Year)%>%
  dplyr::mutate(mean_psi=mean(Ypd))%>%
  dplyr::mutate(sem_psi=sem(Ypd))%>%
  dplyr::select(Year,Species,mean_psi,sem_psi)%>%
  distinct()

```

```{r growth, include=FALSE,results='asis'}

growth<-read.csv("stemgrowth.csv")%>%
  dplyr::select(-Month)
weather<-read.csv("weather.csv")%>%
  dplyr::select(Date,Precip_sum)
growth<-growth%>%
  group_by(ID)%>%
  arrange(ID,Date)%>%
  drop_na()
growth$Growth<-as.numeric(growth$Growth)
growth<-growth%>%
  dplyr::group_by(ID)%>%
  mutate(growth_start=ifelse(Growth>lag(Growth),"start","end"))
growth$Month<-substr(growth$Date,6,7)
# for each tree, calculate total growth for each month and find its percentage relative to tree maximum growth!
growth<-growth%>%
  drop_na()%>%
  dplyr::mutate(growth=ifelse(growth_start=="end",0,Growth))%>%
  dplyr::select(-Growth)%>%
  dplyr::group_by(ID,Year,Month,)%>%
  dplyr::mutate(tot_growth=sum(growth))%>%
  dplyr::mutate(monthly_growth=ifelse(tot_growth<=0,0,tot_growth))%>%
  dplyr::group_by(ID)%>%
  dplyr::mutate(pct_growth=(monthly_growth/max(monthly_growth)*100))

#### individual tree approach ####
#growth<-growth%>%
 # select(Year,Month,Date,ID,Species,Growth)%>%
  #group_by(ID,Year,Month)%>%
  #mutate(monthly_growth=max(Growth)-min(Growth))%>%
  #select(Year,Month,ID,Species,monthly_growth,Growth)%>%
  #distinct()
wp<-WP3%>%
  dplyr::select(Year,Month,ID,Species,Ypd)
g_wp<-merge(growth, wp)


### doesn't growth decline throughout the season? how do we account for that? phew this is hard ###
##### % percent change approach per Mike Ryan discussion ####
#growth<-growth%>%
 # select(Year,Month,ID,Species,Growth)%>%
  #group_by(ID,Year,Month)%>%
  #mutate(monthly_growth=max(Growth)-min(Growth))%>%
  #select(-Growth)%>%
  #group_by(Species)%>%
  #mutate(max_growth=max(monthly_growth))%>%
  #mutate(pct_growth=monthly_growth/max_growth)%>%
  #distinct()

#wp<-WP3%>%
 # dplyr::select(Year,Month,ID,Species,Ypd)
#g_wp<-merge(growth, wp)
#g_wp<-merge(g_wp,treats)%>%distinct()
#write.csv(g_wp,"tree_growth.csv")

# plot pct_growth with Ypd at species level and tree level
#g_ypd<-ggplot(g_wp,aes(Ypd,pct_growth,color=Species)) + geom_point() + geom_smooth(method="lm") + facet_wrap(~ID)
#g_ypd_spp<-ggplot(g_wp,aes(Ypd,pct_growth,color=Species)) + geom_point() + geom_smooth(method="lm") + facet_wrap(~Species,scales="free")


####### DO thresholds AT SPECIES LEVEL ############
gw<-merge(growth,wp)%>%
  distinct()%>%
  dplyr::filter(ID==c(110,114,115,116,122,13,27,3,4,6))# for each individual tree merge growth and tree water potential data
# run exponential model on individual tree level data
# no the individual model...
id_plot<-ggplot(gw,aes(Ypd,pct_growth)) + geom_point() + geom_smooth(method="lm")+ facet_wrap(~ID) # plot individual tree growth and Ypd
gw_spp<-gw%>% # using individual-level data, determine species-level average pct growth and Ypd for each month
  dplyr::group_by(Year,Month,Species)%>%
  dplyr::mutate(avg_pct=mean(pct_growth))%>%
  dplyr::mutate(avg_Ypd=mean(Ypd))%>%
  mutate(Species=ifelse(Species=="JUMO","J. monosperma","P. edulis"))

# use linear model to get x-intercept
yint_lm<-gw_spp %>%
  group_by(Species) %>%
  do(data.frame(y_intercept = coef(lm(pct_growth~Ypd,.))[1]))
slope_lm<-gw_spp %>%
  group_by(Species) %>%
  do(data.frame(slope = coef(lm(pct_growth~Ypd,.))[2]))
growth_lm<-merge(slope_lm,yint_lm)%>%
  mutate(xint=-(y_intercept)/slope)%>%
  dplyr::select(Species,xint)
gw_<-merge(gw_spp,growth_lm)

# predict Ypd values at specified growth intervals for each species
library(chemCal)
p<-gw_spp%>%dplyr::filter(Species=="P. edulis")
gp_mod<-lm(pct_growth~Ypd,data=p)
pct_growth<-p$pct_growth
ynew<-c(0,10,20,30,40,50,60,70,80,90,100)
pg_pred<-t(sapply(ynew,function(pct_growth) inverse.predict(gp_mod,pct_growth)[1:2]))

j<-gw_spp%>%dplyr::filter(Species=="J. monosperma")
gj_mod<-lm(pct_growth~Ypd,data=j)
pct_growth<-j$pct_growth
ynew<-c(0,10,20,30,40,50,60,70,80,90,100)
jg_pred<-t(sapply(ynew,function(pct_growth) inverse.predict(gj_mod,pct_growth)[1:2]))

Species<-c("P. edulis","P. edulis","P. edulis","P. edulis","P. edulis","P. edulis","P. edulis","P. edulis","P. edulis","P. edulis","J. monosperma","J. monosperma","J. monosperma","J. monosperma","J. monosperma","J. monosperma","J. monosperma","J. monosperma")
interval<-c(0,10,20,30,40,50,60,70,80,90,0,10,20,30,40,50,60,70)
pred_Ypd<-c(-2.78384,-2.44825,-2.11266,-1.77707,-1.44148,-1.10589,-0.7703005,-0.4347107,-0.09912084,0,-5.013598,-4.284634,-3.55567,-2.826706,-2.097743,-1.368779,-0.6398147,0)
growth_int<-cbind(Species,interval,pred_Ypd)
growth_int<-as.data.frame(growth_int)

#gw_spp<-merge(gw_spp,growth_int)

# plot the data with intercepts


g<-data.frame(
  Species=c("J. monosperma","P. edulis"),
  lab=c("x-intercept: -5.01 MPa","x-intercept: -2.78 MPa")
)

growth_plot<-ggplot(gw_spp,aes(abs(Ypd),pct_growth,color=Species)) + geom_point() + stat_smooth(method="lm",formula=y~log(x)) + facet_wrap(~Species,scales="free") + ylab("% of Maximum Growth") + xlab("Predawn Water Potential (-MPa)") + scale_x_continuous(guide = guide_axis(check.overlap = TRUE)) +  scale_color_manual(values=wes_palette("Zissou1",n=4,type='discrete')) + theme(legend.position="none",axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(strip.text.x = element_text(
        size = 20, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + geom_text(data=g,mapping=aes(x=-Inf,y=95,label=lab),hjust=-1.0) + ylim(0,100)
```

``` {r other growth approaches, include=FALSE,results='asis'}

########## FIND THE LINE OF BEST FIT
# 1. Regressions (nonlinear and linear)
pied<-g_wp%>%filter(Species=="PIED")
jumo<-g_wp%>%filter(Species=="JUMO")
### a. linear
growth_pied<-lm(pied$pct_growth~pied$Ypd)
summary(growth_pied)
AIC(growth_pied) # 0.822 BEST MODEL FOR PIED
growth_jumo<-lm(jumo$pct_growth~jumo$Ypd)
summary(growth_jumo)
AIC(growth_jumo) # -40.2485 # BEST MODEL FOR JUMO
### b. exponential
exp_pied<-lm(pied$pct_growth~exp(pied$Ypd))
summary(exp_pied)
AIC(exp_pied) # 
exp_jumo<-lm(jumo$pct_growth~exp(jumo$Ypd))
summary(exp_jumo)
AIC(exp_jumo) # 
#### c. polynomial
poly_pied<-lm(pied$pct_growth~poly(pied$Ypd,2))
summary(poly_pied)
AIC(poly_pied) # 
poly_jumo<-lm(jumo$pct_growth~poly(jumo$Ypd,2))
summary(poly_jumo)
AIC(poly_jumo) # 
### d. logarithmic
log_pied<-lm(pied$pct_growth~log(abs(pied$Ypd)))
summary(log_pied)
AIC(log_pied) # log is line of best fit
log_jumo<-lm(jumo$pct_growth~log(abs(jumo$Ypd)))
summary(log_jumo)
AIC(log_jumo) # log is line of best fit

pied_aic<-AICtab(growth_pied,exp_pied,poly_pied,log_pied,base=TRUE,sort=TRUE,weights=TRUE) 
paic<-as.data.frame(pied_aic)%>%
  dplyr::mutate(Species="P. edulis")%>%
  dplyr::mutate(Model=c("Log","Polynomial","Negative Exponential","Linear"))%>%
  dplyr::select(Model,AIC,dAIC,df,weight,Species)
jumo_aic<-AICtab(growth_jumo,exp_jumo,poly_jumo,log_jumo,base=TRUE,sort=TRUE,weights=TRUE) 
jaic<-as.data.frame(jumo_aic)%>%
  dplyr::mutate(Species="J. monosperma")%>%
  dplyr::mutate(Model=c("Log","Negative Exponential","Polynomial","Linear"))%>%
  dplyr::select(Model,AIC,dAIC,df,weight,Species)
aic<-rbind(paic,jaic)
gaic<-flextable(aic)


# let's get rid of outliers
p.cook<-cooks.distance(lm(pct_growth~log(abs(Ypd)),data=pied))
influential <- p.cook[(p.cook > (3 * mean(p.cook, na.rm = TRUE)))]
influential
names_of_influential <- names(influential)
outliers <- pied[names_of_influential,]
piedgrowth_new <- pied %>% anti_join(outliers)
j.cook<-cooks.distance(lm(pct_growth~log(abs(Ypd)),data=jumo))
influential <- j.cook[(j.cook > (3 * mean(j.cook, na.rm = TRUE)))]
influential
names_of_influential <- names(influential)
outliers <- jumo[names_of_influential,]
jumogrowth_new <- jumo %>% anti_join(outliers)
jpg_new<-rbind(piedgrowth_new,jumogrowth_new)


# get x intercept from model of best fit
SE0<-jpg_new %>%
  group_by(Species) %>%
  do(data.frame(SE = summary(lm(pct_growth~log(abs(Ypd)),.))$coefficients[2,2]))%>%
  mutate(Method="Obs. Max")
yint_log<-jpg_new %>%
  group_by(Species) %>%
  do(data.frame(y_intercept = coef(lm(pct_growth~log(abs(Ypd)),.))[1]))
slope_log<-jpg_new %>%
  group_by(Species) %>%
  do(data.frame(slope = coef(lm(pct_growth~log(abs(Ypd)),.))[2]))
# PIED - y = 61.4 - 51.7x
# JUMO - y = 51.7 - 26.8x
growth_log<-merge(slope_log,yint_log)%>%
  mutate(xint=-(y_intercept)/slope)%>%
  mutate(xint=exp(xint))%>%
  dplyr::select(Species,xint,slope)

gw_<-merge(jpg_new,growth_log)%>%
  dplyr::mutate(newpct=ifelse(Species=="JUMO" & abs(Ypd)<6.5 & abs(Ypd)>5.5,-10,ifelse(Species=="JUMO"&abs(Ypd)>=6.5,-70,pct_growth)))%>%
  dplyr::mutate(newpsi=ifelse(Species=="JUMO" & abs(Ypd)>6.5,-6.9,Ypd))
  

glog<-growth_log%>%
  mutate(Species=ifelse(Species=="JUMO","J. monosperma", "P. edulis"),Method="Obs. Max")











######### CALCLATE INFLECTION POINT FOR THE NONLINEAR REGRESSIONS ###############
pied_inflection<-ede(abs(pied$Ypd),pied$pct_growth,index=0) # -1.85
jumo_inflection<-as.data.frame(ede(abs(jumo$Ypd),jumo$pct_growth,0)) # -3.25


library(chemCal)
p<-gw_spp%>%dplyr::filter(Species=="P. edulis")
gp_mod<-lm(pct_growth~log(abs(Ypd)),data=p)
pct_growth<-p$pct_growth
ynew<-c(0,10,20,30,40,50,60,70,80,90,100)
pg_pred<-t(sapply(ynew,function(pct_growth) inverse.predict(gp_mod,pct_growth)[1:2]))
pgdf<-as.data.frame(pg_pred)
pgdf$Prediction<-as.numeric(pgdf$Prediction)
pgdf<-pgdf%>%
  mutate(pred_Ypd=-(exp(Prediction)))%>%
  mutate(interval=c(0,10,20,30,40,50,60,70,80,90,100))%>%
  mutate(Species="P. edulis")%>%
  dplyr::select(Species,interval,pred_Ypd)

j<-gw_spp%>%dplyr::filter(Species=="J. monosperma")
gj_mod<-lm(pct_growth~log(abs(Ypd)),data=j)
pct_growth<-j$pct_growth
ynew<-c(0,10,20,30,40,50,60,70,80,90,100)
jg_pred<-t(sapply(ynew,function(pct_growth) inverse.predict(gj_mod,pct_growth)[1:2]))
jgdf<-as.data.frame(jg_pred)
jgdf$Prediction<-as.numeric(jgdf$Prediction)
jgdf<-jgdf%>%
  mutate(pred_Ypd=-(exp(Prediction)))%>%
  mutate(interval=c(0,10,20,30,40,50,60,70,80,90,100))%>%
  mutate(Species="J. monosperma")%>%
  dplyr::select(Species,interval,pred_Ypd)

growth_int<-rbind(pgdf,jgdf)
growth_int<-as.data.frame(growth_int)


#### TESTING HOW THE OTHER MODELS AFFECT THE RESULTS
# get x intercept from model of best fit
yint_ne<-gw_spp %>%
  group_by(Species) %>%
  do(data.frame(y_intercept = coef(lm(pct_growth~exp(Ypd),.))[1]))
slope_ne<-gw_spp %>%
  group_by(Species) %>%
  do(data.frame(slope = coef(lm(pct_growth~exp(Ypd),.))[2]))
growth_ne<-merge(slope_ne,yint_ne)%>%
  mutate(xint=(y_intercept)/slope)%>%
  mutate(xint=log(xint))%>%
  dplyr::select(Species,xint)%>%
  dplyr::mutate(Model="Negative Exponential")

yint_lm<-gw_spp %>%
  group_by(Species) %>%
  do(data.frame(y_intercept = coef(lm(pct_growth~Ypd,.))[1]))
slope_lm<-gw_spp %>%
  group_by(Species) %>%
  do(data.frame(slope = coef(lm(pct_growth~Ypd,.))[2]))
growth_lm<-merge(slope_lm,yint_lm)%>%
  mutate(xint=-(y_intercept)/slope)%>%
  mutate(xint=xint)%>%
  dplyr::select(Species,xint)%>%
  dplyr::mutate(Model="Linear")

pied_inflection<-as.data.frame(ede(abs(pied$Ypd),pied$pct_growth,index=0))%>%
  dplyr::select(chi)%>%
  dplyr::mutate(Species="P. edulis")%>%
  dplyr::mutate(Model="Polynomial")%>%
  dplyr::rename(xint=chi)# -1.85
jumo_inflection<-as.data.frame(ede(abs(jumo$Ypd),jumo$pct_growth,0))%>%
  dplyr::select(chi)%>%
  dplyr::mutate(Species="J. monosperma")%>%
  dplyr::mutate(Model="Polynomial")%>%
  dplyr::rename(xint=chi) # -3.25

models<-rbind(log,growth_ne,growth_lm,pied_inflection,jumo_inflection)%>%
  dplyr::mutate("X-intercept"=-abs(xint))%>%
  dplyr::select(-xint)%>%
  dplyr::mutate(Variable="Growth")

mod_tab1<-flextable(models)



###### CALCULATE GROWTH THRESHOLDS WITH BEST MODEL ABOVE ########
#exp_growth<-drm(formula=g_wp$pct_growth~g_wp$id_Ypd,curveid = g_wp$Species, fct = DRC.expoDecay())
#coef(exp_growth)

#g_wp<-g_wp%>%
 # mutate(slope=ifelse(Species=="J. monosperma",-0.1983108,-0.9131335))%>%
#  mutate(y=ifelse(Species=="J. monosperma",0.5488968,1.3137041))%>%
 # mutate(xint=y/slope)%>%
#  dplyr::select(-y,-slope)%>%
  #distinct()




######### CALCULATE INFLECTION POINT FOR THE NONLINEAR REGRESSIONS ###############
#pied_inflection<-inflection::ese(pied$Ypd,pied$pct_growth,1) # -1.17
#jumo_inflection<-ese(jumo$Ypd,jumo$pct_growth,1) # -1.23

# try to calculate thresholds when growth reaches bottom 10percentile
#ten_percent<-g_wp%>%
 # group_by(ID)%>%
  #mutate(quantile=ntile(monthly_growth,n=10))%>%
  #group_by(ID,quantile)%>%
  #mutate(quantile_Ypd=mean(Ypd))%>%
  #ungroup()%>%
  #group_by(ID)%>%
  #distinct(ID,quantile,quantile_Ypd,.keep_all = TRUE)%>%
  #filter(quantile=="10")

# try to calculate thresholds when growth reaches bottom 1percentile
#one_percent<-g_wp%>%
 # group_by(ID)%>%
  #mutate(quantile=ntile(monthly_growth,n=100))%>%
  #group_by(ID,quantile)%>%
  #mutate(quantile_Ypd=mean(Ypd))%>%
  #ungroup()%>%
  #group_by(ID)%>%
  #distinct(ID,quantile,quantile_Ypd,.keep_all = TRUE)%>%
  #filter(quantile=="1")

############ the threshold for when growth stops gets less negative as I move up the percentiles. What does this mean for NSC?


#alltrees<-ggplot(g_wp,aes(Ypd,monthly_growth)) + geom_point() + geom_vline(data=ten_percent,aes(xintercept=quantile_Ypd)) + facet_wrap("ID")


#tenpercent_plot<-ggplot(ten_percent,aes(Treatment,quantile_Ypd,fill=Species)) + geom_bar(stat="summary",position = "dodge",color="white") + ylim(0,-6) + labs(y="Average Ypd of Bottom 10th Percentile of Growth (MPa)")

#growth_ind_gwp<-one_percent%>%
 # rename("xint"=quantile_Ypd)

# bottom 5th percentile
#five_percent<-g_wp%>%
 # group_by(ID)%>%
  #mutate(quantile=ntile(monthly_growth,n=20))%>%
  #group_by(ID,quantile)%>%
  #mutate(quantile_Ypd=mean(Ypd))%>%
  #ungroup()%>%
  #group_by(ID)%>%
  #distinct(ID,quantile,quantile_Ypd,.keep_all = TRUE)%>%
  #filter(quantile=="1")
#growth_ind_gwp<-five_percent%>%
 # rename("xint"=quantile_Ypd)

# bottom 1st percentile
#one_percent<-g_wp%>%
 # group_by(ID)%>%
  #mutate(quantile=ntile(monthly_growth,n=100))%>%
  #group_by(ID,quantile)%>%
  #mutate(quantile_Ypd=mean(Ypd))%>%
  #ungroup()%>%
  #group_by(ID)%>%
  #distinct(ID,quantile,quantile_Ypd,.keep_all = TRUE)%>%
  #filter(quantile=="1")
#growth_ind_gwp<-one_percent%>%
 # rename("xint"=quantile_Ypd)

#calculate Ypd when growth <= max*0.10
#point_one<-g_wp%>%
 # group_by(ID)%>%
  #mutate(max_growth=max(monthly_growth))%>%
  #mutate(as.percent=monthly_growth/max_growth)%>%
  #distinct()%>%
  #mutate(percent_max=ifelse(as.percent<=0.10,10,90))%>% # JUMO A H never reached below 10% of max G
  #select(Species,ID,Ypd,percent_max)%>%
  #distinct()%>%
  #group_by(Species,Treatment,percent_max)%>%
  #mutate(avg_Ypd=mean(Ypd))%>%
  #distinct(Species,Treatment,percent_max,.keep_all = TRUE)%>%
  #filter(percent_max==10)



#pointone_plot<-ggplot(point_one,aes(Treatment,avg_Ypd,fill=Species)) + geom_bar(stat="summary",position = "dodge",color="white") + ylim(0,-6) + labs(y="Average Ypd at 10% of Maximum Growth (MPa)") 

# GLM method?

# quantile regression method
#library(quantreg)
#yint_quant<-g_wp %>%
 # group_by(Species,Treatment) %>%
  #do(data.frame(y_intercept = coef(rq(monthly_growth~Ypd+Species+Treatment,data=g_wp))[1]))
#slope_quant<-g_wp %>%
 # group_by(Species,Treatment) %>%
  #do(data.frame(slope = coef(rq(monthly_growth~Ypd+Species+Treatment,data=g_wp))[2]))
#growth_quant<-merge(yint_quant,slope_quant)%>%
 # mutate(xint=-(y_intercept)/slope)

#quant<-rq(monthly_growth~Ypd+Species+Treatment,tau=.5,data=g_wp,model=TRUE,method='br')

#test<-ggplot(ten_percent,aes(quantile_Ypd,quantile)) + geom_point() + geom_smooth(method="lm",color="black") + geom_smooth(method="lm",formula=y~exp(x),color="blue") + facet_wrap(Species~Treatment)

# try weibull plot
# struggling to iterate weibull model for each ID
# should I just run for each individual ID as a DF?
# BEST WAY - TRY strucchange package to find threshold a la Senf et al. 2020
#ggplot(g_wp,aes(Ypd,monthly_growth)) + geom_point() + facet_wrap(~ID)
#threshold_ID<-g_wp%>%
 # group_by(ID)%>%
  #do(data.frame(max(g_wp$Ypd[breakpoints(monthly_growth~exp(Ypd),data=.,breaks=1)$breakpoints])))%>%
  #rename("bp"=max.g_wp.Ypd.breakpoints.monthly_growth...exp.Ypd...data......)
#gwp_bp<-merge(g_wp,threshold_ID)%>%
 # select(-Growth)%>%
  #distinct()
#ID_bp<-gwp_bp%>%
 # distinct(ID,Species,bp)
#treatment_bp<-gwp_bp%>%
 # group_by(Species,Treatment)%>%
  #mutate(mean_bp=mean(bp))%>%
  #distinct()
#breakpoint_plot<-ggplot(gwp_bp,aes(Ypd,monthly_growth)) + geom_point() + geom_smooth(method="lm",formula=y~exp(x),color='red',lwd=2) + geom_vline(aes(xintercept=bp)) + facet_wrap(~ID)
#treatment_plot<-ggplot(treatment_bp,aes(Ypd,monthly_growth)) + geom_point() + geom_smooth(method="lm",formula=y~exp(x),color='red',lwd=2) + geom_vline(aes(xintercept=mean_bp)) + facet_wrap(Species~Treatment)


#test<-g_wp%>%filter(Species=="PIED") %>%filter(Treatment=="D")
#breaks<-breakpoints(monthly_growth~exp(Ypd),breaks=1,data=test)
#bps<-breaks[[1]]
#max(test$Ypd[bps])

#F_test<-Fstats(test$monthly_growth~test$Ypd)
#plot(F_test)
#plot(test$monthly_growth~test$Ypd)
#lines(breakpoints(F_test))


#gwp_list<-split(g_wp,g_wp$ID)
#library(nls2)
#pars <- expand.grid(k=seq(0.1, 5, len=10),
                    #b=seq(0.1, 1, len=10),
                    #d=seq(1, 100, len=10))
#weibull_fun<- function(data) {
 # res <- nls2(monthly_growth ~ d*((k/b) * ((abs(Ypd)/b)^(k-1)) * exp(- (abs(Ypd)/b)^k)), data=g_wp,
  #          start=pars, algorithm='brute-force')
  #predict(res)
#}
#gwp_new<- for (Ypd in gwp_list) {
  #res = weibull_fun(gwp_list)
#}


#test<-weibull_fun(gwp)
#library(purrr)
#gwp_new<-map_dfr(gwp_list, weibull_fun, .id = "ID")


#weibull<-g_wp%>%
 # group_by(ID)%>%
  #do(res=predict(nls2(monthly_growth ~ d*((k/b) * ((abs(Ypd)/b)^(k-1)) * exp(- (abs(Ypd)/b)^k)), data=g_wp,
   #         start=pars, algorithm='brute-force')))
#weibull_g_wp<-merge(g_wp,weibull)


#ggplot(weibull_g_wp, aes(x=Ypd, y=res)) +  
 # geom_line(col='red', lwd=2) + 
  #geom_point(aes(x=Ypd,y=monthly_growth), color = 'steelblue', size =2) +
  #geom_vline(aes(xintercept=(-2.03))) +
  #theme_bw() +
  #xlab("Ypd") +
  #ylab("Growth") 

#pd<-g_wp%>%filter(Species=="PIED")%>%filter(Treatment=="D")
#dat <- data.frame(x=pd$Ypd, y=pd$monthly_growth)
#dat<-dat%>%distinct()
#dat$x<-abs(dat$x)
#library(nls2)
#pars <- expand.grid(k=seq(0.1, 5, len=10),
 #                   b=seq(0.1, 1, len=10),
  #                  d=seq(1, 100, len=10))
#pars2<-expand.grid(k=seq(0.1, 5, len=10))
  
#res <- nls2(y ~ d*((k/b) * ((abs(x)/b)^(k-1)) * exp(- (abs(x)/b)^k)), data=dat,
 #           start=pars, algorithm='brute-force')
#ip<-findiplist(dat$x,dat$y,index=1) # using inflection package, gives -2.03 for PIED D
#ggplot(dat, aes(x=(-x), y=predict(res))) +  
 # geom_line(col='red', lwd=2) + 
  #geom_point(aes(x=(-x),y=y), color = 'steelblue', size =2) +
  #geom_vline(aes(xintercept=(-2.03))) +
  #theme_bw() +
  #xlab("Ypd") +
  #ylab("Growth") 
#predicted <- cbind(dat$x, predict(res))




# linear model method
#yint_ind_gwp<-g_wp %>%
 # group_by(Species) %>%
  #do(data.frame(y_intercept = coef(lm(monthly_growth~Ypd,.))[1]))
#slope_ind_gwp<-g_wp %>%
 # group_by(Species) %>%
  #do(data.frame(slope = coef(lm(monthly_growth~Ypd,.))[2]))
#growth_ind_gwp<-merge(yint_ind_gwp,slope_ind_gwp)%>%
 # mutate(xint=-(y_intercept)/slope)



#g_wp <- merge(g_wp,growth_ind_gwp)%>%
 # select(Species,Treatment,ID,xint,monthly_growth, Ypd)%>%
  #distinct()
#g_wp_for_anova<-g_wp%>%
 # mutate(type="growth")%>%
  #select(Species,Treatment,ID,xint,type)

#name_list<-g_wp%>%
 # select(ID)
##############
### plots ###
#############

#ind_tree<-ggplot(g_wp,aes(Ypd,monthly_growth))+geom_point()+geom_smooth(method="lm")+facet_wrap(~ID) # ehhhhh


# plots for Henry
#growth_plot_henry<-ggplot(g_wp,aes(Ypd,Growth)) + geom_point(aes(color=ID)) + stat_smooth(method="lm",aes(color=ID)) + xlim(0,-5) + facet_wrap(~ID) + scale_color_manual(values=wes_palette("Zissou1",n=23,type="continuous"))

#piedhd<-g_wp%>%filter(Species=="PIED")%>%filter(Treatment=="HD")%>%distinct()%>%filter(Year==2013)
#growth_plot_piedhd<-ggplot(piedhd,aes(Ypd,growth)) + geom_point(aes(color=Treatment,shape=Treatment)) + stat_smooth(method="lm",color="black") + xlim(0,-5) + facet_wrap(Treatment~Species) + scale_color_manual(values=wes_palette("Zissou1",n=5,type="continuous"))
```

```{r A intercepts, include=FALSE,results='asis'}

#waterpotential <- wp %>%
 # dplyr::select(Year, Month, Species, Ypd)%>%
  #dplyr::group_by(Species,Year,Month)%>%
  #dplyr::mutate(mean_Ypd=mean(Ypd))
#wp_photo <- merge(waterpotential, photo3)
#wp2<-wp_photo%>%
 # dplyr::filter(Photo>"0.0000")

#### % change approach per Mike Ryan conversation ####
#wp_photo_final<-wp2%>%
 # group_by(ID)%>%
  #mutate(pct_photo=Photo/max(Photo))

# plot ypd and pct_photo by tree and species
#pct_photo<-ggplot(wp_photo_final,aes(Ypd,pct_photo,color=Species)) + geom_point() + geom_smooth(method="lm") + facet_wrap(~ID)
#pct_species<-ggplot(wp_photo_final,aes(Ypd,pct_photo,color=Species)) + geom_point() + geom_smooth(method="lm") + facet_wrap(~Species,scales="free")


####### DO PERCENTAGES AT SPECIES LEVEL ############
wp_photo_final<-photo3%>%
  dplyr::filter(Photo>"0.0000")%>%
  dplyr::group_by(ID)%>%
  dplyr::mutate(max_photo=max(Photo))%>%
  dplyr::mutate(pct_photo=(Photo/max_photo)*100)%>%
  #mutate(Species=ifelse(Species=="JUMO","J. monosperma","P. edulis"))%>%
  dplyr::group_by(Species,Year,Month)%>%
  dplyr::mutate(avg_pct=mean(pct_photo))
#wp<-wp%>%
 # mutate(Species=ifelse(Species=="JUMO","J. monosperma","P. edulis"))
wp_photo<-merge(wp_photo_final,wp)%>%
  dplyr::group_by(Year,Month,Species)%>%
  dplyr::mutate(avg_Ypd=mean(Ypd))




```

``` {r photo multi model approach, include=FALSE,results='asis'}


########## FIND THE LINE OF BEST FIT


# 1. Regressions (nonlinear and linear)
pied<-wp_photo%>%filter(Species=="PIED")%>%drop_na()
jumo<-wp_photo%>%filter(Species=="JUMO")%>%drop_na()
### a. linear
photo_pied<-lm(pied$pct_photo~pied$Ypd)
summary(photo_pied)
photo_jumo<-lm(jumo$pct_photo~jumo$Ypd)
summary(photo_jumo)
### b. exponential
exp_pied<-lm(pied$pct_photo~exp(pied$Ypd))
summary(exp_pied)
exp_jumo<-lm(jumo$pct_photo~exp(jumo$Ypd))
summary(exp_jumo)
### c. polynomial
poly_pied<-lm(pied$pct_photo~poly((abs(pied$Ypd)),2))
summary(poly_pied)
poly_jumo<-lm(jumo$pct_photo~poly((abs(jumo$Ypd)),2))
summary(poly_jumo)
### d. logarithmic
log_pied<-lm(pied$pct_photo~log(abs(pied$Ypd)))
summary(log_pied)
log_jumo<-lm(jumo$pct_photo~log(abs(jumo$Ypd)))
summary(log_jumo)

pied_aic<-AICtab(photo_pied,exp_pied,poly_pied,log_pied,base=TRUE,sort=TRUE,weights=TRUE) # polynomial  model is best
paic<-as.data.frame(pied_aic)%>%
  dplyr::mutate(Species="P. edulis")%>%
  dplyr::mutate(Model=c("Polynomial","Log","Negative Exponential","Linear"))%>%
  dplyr::select(Model,AIC,dAIC,df,weight,Species)
jumo_aic<-AICtab(photo_jumo,exp_jumo,poly_jumo,log_jumo,base=TRUE,sort=TRUE,weights=TRUE) # polynomial model is best
jaic<-as.data.frame(jumo_aic)%>%
  dplyr::mutate(Species="J. monosperma")%>%
  dplyr::mutate(Model=c("Polynomial","Log","Negative Exponential","Linear"))%>%
  dplyr::select(Model,AIC,dAIC,df,weight,Species)
aic<-rbind(paic,jaic)
photoaic<-flextable(aic)



# get rid of the outliers
p.cook<-cooks.distance(lm(pct_photo~log(abs(Ypd)),data=pied))
influential <- p.cook[(p.cook > (3 * mean(p.cook, na.rm = TRUE)))]
influential
names_of_influential <- names(influential)
outliers <- pied[names_of_influential,]
piedphoto_new <- pied %>% anti_join(outliers)

j.cook<-cooks.distance(lm(pct_photo~log(abs(Ypd)),data=jumo))
influential <- j.cook[(j.cook > (3 * mean(j.cook, na.rm = TRUE)))]
influential
names_of_influential <- names(influential)
outliers <- jumo[names_of_influential,]
jumophoto_new <- jumo %>% anti_join(outliers)
jp_new<-rbind(piedphoto_new,jumophoto_new)%>%
  mutate(newpct=pct_photo)%>%
  mutate(newpsi=Ypd)


SE0<-jp_new %>%
  group_by(Species) %>%
  do(data.frame(SE = summary(lm(pct_photo~log(abs(Ypd)),.))$coefficients[2,2]))%>%
  mutate(Method="Obs. Max")
yint_log<-jp_new %>%
  group_by(Species) %>%
  do(data.frame(y_intercept = coef(lm(pct_photo~log(abs(Ypd)),.))[1]))
slope_log<-jp_new %>%
  group_by(Species) %>%
  do(data.frame(slope = coef(lm(pct_photo~log(abs(Ypd)),.))[2]))
# PIED - y = 63.7 - 51.8x
# JUMO - y = 58.6 - 33.3x
photo_log<-merge(slope_log,yint_log)%>%
  mutate(xint=-(y_intercept)/slope)%>%
  mutate(xint=exp(xint))%>%
  dplyr::select(Species,xint,slope)
#photo_<-merge(gw_spp,growth_lm)

log<-photo_log%>%
  mutate(Species=ifelse(Species=="JUMO","J. monosperma", "P. edulis"),Method="Obs. Max")




library(chemCal)
pp_mod<-lm(pct_photo~log(abs(Ypd)),data=pied)
pct_photo<-pied$pct_photo
ynew<-c(0,10,20,30,40,50,60,70,80,90,100)
pp_pred<-t(sapply(ynew,function(pct_photo) inverse.predict(pp_mod,pct_photo)[1:2]))
ppdf<-as.data.frame(pp_pred)
ppdf$Prediction<-as.numeric(ppdf$Prediction)
ppdf<-ppdf%>%
  mutate(pred_Ypd=-(exp(Prediction)))%>%
  mutate(interval=c(0,10,20,30,40,50,60,70,80,90,100))%>%
  mutate(Species="P. edulis")%>%
  dplyr::select(Species,interval,pred_Ypd)

pj_mod<-lm(pct_photo~log(abs(Ypd)),data=jumo)
pct_photo<-jumo$pct_photo
ynew<-c(0,10,20,30,40,50,60,70,80,90,100)
jp_pred<-t(sapply(ynew,function(pct_photo) inverse.predict(pj_mod,pct_photo)[1:2]))
jpdf<-as.data.frame(jp_pred)
jpdf$Prediction<-as.numeric(jpdf$Prediction)
jpdf<-jpdf%>%
  mutate(pred_Ypd=-(exp(Prediction)))%>%
  mutate(interval=c(0,10,20,30,40,50,60,70,80,90,100))%>%
  mutate(Species="J. monosperma")%>%
  dplyr::select(Species,interval,pred_Ypd)

photo_int<-rbind(ppdf,jpdf)
photo_int<-as.data.frame(photo_int)

wp_photo<-wp_photo%>%
  mutate(Species=ifelse(Species=="JUMO","J. monosperma", "P. edulis"))%>%
           merge(.,photo_int)



######### CALCULATE INFLECTION POINT FOR THE NONLINEAR REGRESSIONS ###############
#pied_inflection<-as.data.frame(inflection::ede(pied$Ypd,pied$pct_photo,1)) # -2.435
#jumo_inflection<-as.data.frame(ede(jumo$Ypd,jumo$pct_photo,1)) # -4.815

# make table to compare inflection point with intercept
#th_<-photo_poly%>%
 # dplyr::rename(Value=xint)%>%
#  dplyr::mutate(Threshold="X-intercept")
#inf<-pied_inflection%>%
#  dplyr::select(chi)%>%
#  dplyr::mutate(Species="PIED")%>%
#  dplyr::rename(Value=chi)%>%
#  dplyr::mutate(Threshold="Inflection Point")
#infj<-jumo_inflection%>%
#  dplyr::select(chi)%>%
#  dplyr::mutate(Species="JUMO")%>%
#  dplyr::rename(Value=chi)%>%
#  dplyr::mutate(Threshold="Inflection Point")%>%
 # rbind(.,inf)%>%
#  rbind(.,th_)%>%
#  dplyr::mutate(Variable="Photosynthesis")
#A_table<-flextable(infj)



#### TESTING HOW THE OTHER MODELS AFFECT THE RESULTS

yint_ne<-wp_photo %>%
  group_by(Species) %>%
  do(data.frame(y_intercept = coef(lm(pct_photo~exp(Ypd),.))[1]))
slope_ne<-wp_photo %>%
  group_by(Species) %>%
  do(data.frame(slope = coef(lm(pct_photo~exp(Ypd),.))[2]))
growth_ne<-merge(slope_ne,yint_ne)%>%
  mutate(xint=(y_intercept)/slope)%>%
  mutate(xint=log(xint))%>%
  dplyr::select(Species,xint)%>%
  dplyr::mutate(Model="Negative Exponential")

yint_lm<-wp_photo %>%
  group_by(Species) %>%
  do(data.frame(y_intercept = coef(lm(pct_photo~Ypd,.))[1]))
slope_lm<-wp_photo %>%
  group_by(Species) %>%
  do(data.frame(slope = coef(lm(pct_photo~Ypd,.))[2]))
growth_lm<-merge(slope_lm,yint_lm)%>%
  mutate(xint=-(y_intercept)/slope)%>%
  mutate(xint=xint)%>%
  dplyr::select(Species,xint)%>%
  dplyr::mutate(Model="Linear")

pied_inflection<-as.data.frame(ede(abs(pied$Ypd),pied$pct_photo,index=1))%>%
  dplyr::select(chi)%>%
  dplyr::mutate(Species="P. edulis")%>%
  dplyr::mutate(Model="Polynomial")%>%
  dplyr::rename(xint=chi)# -1.85
jumo_inflection<-as.data.frame(ede(abs(jumo$Ypd),jumo$pct_photo,0))%>%
  dplyr::select(chi)%>%
  dplyr::mutate(Species="J. monosperma")%>%
  dplyr::mutate(Model="Polynomial")%>%
  dplyr::rename(xint=chi) # -3.25

models2<-rbind(log,growth_ne,growth_lm,pied_inflection,jumo_inflection)%>%
  dplyr::mutate("X-intercept"=-abs(xint))%>%
  dplyr::select(-xint)%>%
  dplyr::mutate(Variable="Photosynthesis")

modz<-rbind(models,models2)
  
mod_tab<-flextable(modz)





########### CALCULATE PHOTOSYNTHESIS THESHOLD WITH EXP MODEL ###########
#exp_p<-drm(formula=wp_photo_final$pct_photo~wp_photo_final$mean_Ypd,curveid = wp_photo_final$Species, fct = DRC.expoDecay())
#coef(exp_p)
#wp_photo_final<-wp_photo_final%>%
 # mutate(slope=ifelse(Species=="J. monosperma",-0.4835969,-1.1708765))%>%
#  mutate(y=ifelse(Species=="J. monosperma",1.3160442,2.7829988))%>%
 # mutate(xint_photo=y/slope)%>%
  #dplyr::select(-y,-slope)%>%
  #distinct()
# exponential model doesn't calculate thresholds correctly
# results underestimate the thresholds for photosynthesis in JUMO
# using a linear model gives more realistic thresholds, so better to use this approach




  
  
############# ALL OF THIS BELOW IS FOR THRESHOLD APPROACH #################


#### What shape fits the data best?!?! ########
#m1<-lm(Photo~Ypd+Species+Treatment,data=wp_photo_final)
#m2<-lm(Photo~I(Ypd^-2)+Species+Treatment,data=wp_photo_final)
#AIC<-AICctab(m1,m2,base=TRUE,weights=TRUE,delta=TRUE,sort=TRUE)
#wp_photo_final$predictPhoto<-predict(m1,wp_photo_final)
# linear model is best fit? OK.



########## plot the linear model ##############
#photo_for_plot<-merge(wp2,name_list)
#photo_id<-ggplot(photo_for_plot,aes(Ypd,Photo)) + geom_point(aes(color=Species)) + stat_smooth(method="lm",color="black") +  facet_wrap("ID",scales="free") + scale_color_manual(values=wes_palette("Zissou1",n=2,type="continuous"))

#formula=y~I(x^-0.05) #adding this to stat_smooth gives nice curved lines


#wp_photo_final$Species<-as.factor(wp_photo_final$Species)
#wp_photo_final$Treatment<-as.factor(wp_photo_final$Treatment)
# Individaul trees
#yint_lm<-wp_photo_final %>%
 # group_by(ID) %>%
  #do(data.frame(y_intercept = coef(lm(Photo~Ypd,.))[1]))
#slope_lm<-wp_photo_final %>%
 # group_by(ID) %>%
  #do(data.frame(slope = coef(lm(Photo~Ypd,.))[2]))
#photo_lm<-merge(slope_lm,yint_lm)%>%
 # mutate(xint_photo=-(y_intercept)/slope)




#select(Treatment,Species,photo_int_plot)
#wp_photo_final<-merge(wp_photo_final,photo_lm)%>%
 # select(Species,Treatment,ID,xint_photo)
#intercepts<-merge(g_wp,wp_photo_final)%>%
  #distinct()


#wp_photo_final_for_anova<-wp_photo_final%>%
 # rename(xint="xint_photo")%>%
#  mutate(type="photo")

#intercepts_anova_data<-rbind(g_wp_for_anova,wp_photo_final_for_anova)%>%
 # distinct()%>%
#  mutate(drop=ifelse(xint>0,NA,"keep"))%>%
 # drop_na()%>%
  #select(-drop)%>%
  #rename("Limitation"=type)
```

``` {r A and G Thresholds, include=FALSE,results='asis'}


g<-gw_%>%dplyr::select(Year,Month,Species,pct_growth,Ypd,newpct,newpsi)%>%
  dplyr::rename(pct=pct_growth)%>%
  dplyr::mutate(Species=ifelse(Species=="JUMO","J. monosperma","P. edulis"))%>%
  drop_na()%>%
 dplyr::mutate(variable="Growth")
a<-jp_new%>%dplyr::select(Year,Month,Species,pct_photo,Ypd,newpct,newpsi)%>%
  dplyr::mutate(Species=ifelse(Species=="JUMO","J. monosperma","P. edulis"))%>%
  dplyr::rename(pct=pct_photo)%>%
  drop_na()%>%
  dplyr::mutate(variable="Photo")
ag<-rbind(g,a)
ag<-ag%>%
  mutate(Variable=ifelse(variable=="Photo","Photosynthesis","Growth"))%>%
  dplyr::select(-variable)%>%
  arrange(desc(Variable))%>%
  dplyr::select(-newpsi,-newpct)
ag$Ypd<-as.numeric(ag$Ypd)
temp<-ag%>%
  dplyr::filter(Month=="10")
ag<-ag%>%
  dplyr::filter(Month!="10")
ag$Month<-gsub("0","",ag$Month)
ag<-rbind(ag,temp)

g<-data.frame(
  Species=c("J. monosperma","P. edulis"),
  lab=c("Growth: y = 51.7 - 26.8log(x)* (-6.86 MPa)","Growth: y = 61.4 - 51.7log(x)* (-3.27MPa)")
)



p<-data.frame(
  Species=c("J. monosperma","P. edulis"),
  lab=c("Photosynthesis: y = 58.6 - 33.3log(x)* (-6.75 MPa)","Photosynthesis: y = 63.7 - 51.8log(x)* (-3.09 MPa)")
)

st<-data.frame(
  Species=c("J. monosperma","P. edulis"),
  Equation = c("NSC: y = -1.4x + 62.15","NSC: y = 68.5 - 9.4x"))

sig<-data.frame(
  Species=c("J. monosperma","P. edulis"),
  lab=c("P = 0.004", "P = 0.064"))
# need to add in actual p values here



#######################################################################
# PROBABLY REDUNDANT CODE, BUT LET'S ADD IN THE % MAX NSC TO FIGURE 1 #
#################FIGURE 3########################

NSC_new <- read.csv("NSC.csv")%>%
  dplyr::mutate(Month=substr(Date,6,7))%>% # read in data, make the month data useable
  drop_na()%>%
  dplyr::select(Year,Month,ID,Tissue,Starch,Tot.Sug,Tot.NSC)%>%
  distinct()%>%
  dplyr::group_by(ID,Month,Year)%>%
  # for each time point, average whole-tree NSC
  dplyr::mutate(wt_sugar=mean(Tot.Sug))%>%
  dplyr::mutate(wt_starch=mean(Starch))%>%
  dplyr::mutate(wt_NSC=mean(Tot.NSC))
  #dplyr::filter(ID!=32 |ID!=26 |ID!=23 |ID!=22 |ID!=20 |ID!=17 |ID!=14|ID!=10|ID!=8)
NSC_new$ID<-as.numeric(NSC_new$ID)

watpot <- read.csv("waterpotential.csv",   na.strings=c("", "NA"))# read in water potential data
jumo <- watpot %>%
  filter(!grepl("P", Tree_ID)) %>%
  dplyr::mutate(Species = "J. monosperma")
pipo <- watpot %>%
  filter(!grepl("J", Tree_ID)) %>%
  dplyr::mutate(Species = "P. edulis")
watpot <- rbind(jumo, pipo)%>%
    dplyr::rename(ID = "Tree_ID")%>%
    dplyr::select(-Ymd)
watpot$ID<-gsub("P", "", watpot$ID)
watpot$ID<-gsub("J", "", watpot$ID)
watpot$ID<-as.numeric(watpot$ID)
watpot <- watpot %>%
  dplyr::mutate(Month = substr(as.character(Date), 6, 7))%>%
  dplyr::select(-Date,-DOY)
watpot$Month <- as.numeric(watpot$Month)

temp<-NSC_new%>%
  dplyr::filter(Month=="10")
NSC_new<-NSC_new%>%
  dplyr::filter(Month!="10")

NSC_new$Month<-gsub("0","",NSC_new$Month)
NSC_new<-rbind(NSC_new,temp)

wp_nsc<-merge(NSC_new,watpot)%>%
  dplyr::mutate(Ypd=abs(Ypd))%>%
  dplyr::group_by(ID,Tissue)%>%
  dplyr::mutate(max=max(wt_NSC))%>%
  dplyr::mutate(pct_max=wt_NSC/max)%>%
  dplyr::group_by(Species,Ypd,Tissue)%>%
  dplyr::mutate(avg_pct=mean(pct_max)*100)

wp_sugar<-merge(NSC_new,watpot)%>%
  dplyr::mutate(Ypd=abs(Ypd))%>%
  dplyr::group_by(ID,Tissue)%>%
  dplyr::mutate(max=max(wt_sugar))%>%
  dplyr::mutate(pct_max=wt_sugar/max)%>%
  dplyr::group_by(Species,Ypd,Tissue)%>%
  dplyr::mutate(avg_pct=mean(pct_max)*100)

wp_starch<-merge(NSC_new,watpot)%>%
  dplyr::mutate(Ypd=abs(Ypd))%>%
  dplyr::group_by(ID,Tissue)%>%
  dplyr::mutate(max=max(wt_starch))%>%
  dplyr::mutate(pct_max=wt_starch/max)%>%
  dplyr::group_by(Species,Ypd,Tissue)%>%
  dplyr::mutate(avg_pct=mean(pct_max)*100)


june<-wp_nsc%>%
  #dplyr::filter(Tissue!="bole" & Tissue!="root") %>%
  dplyr::filter(Month==6)%>%
  dplyr::group_by(ID,Month,Year)%>%
  dplyr::mutate(avg_pct=mean(pct_max)*100)%>%
  dplyr::select(ID,Month,Year,Species,Ypd,pct_max)%>%
  distinct()

canopy<-wp_nsc%>%
  dplyr::filter(Tissue!="bole" & Tissue!="root")%>%
  dplyr::select(ID,Month,Year,Species,Ypd,pct_max)%>%
  distinct()

wpnsc_fin<-june%>%
  dplyr::select(Year, Month, Species, pct_max,Ypd)%>%
  dplyr::mutate(Ypd=-(Ypd))%>%
  dplyr::rename(pct=pct_max)%>%
  dplyr::mutate(Variable="NSC")

wpnsc_canopy<-canopy%>%
  ungroup()%>%
  dplyr::select(Year, Month, Species, pct_max,Ypd)%>%
  dplyr::mutate(Ypd=-(Ypd))%>%
  dplyr::mutate(pct=pct_max*100)%>%
  dplyr::mutate(Variable="NSC")%>%
  dplyr::select(-pct_max)

tissue_nsc<-ggplot(wp_nsc,aes(Ypd,pct_max)) + 
  geom_point() + 
  geom_smooth(method="lm") + 
  facet_wrap(Species~Tissue, scale="free") + theme_minimal()+ 
  ggtitle("Total NSC") +
  labs(x="Predawn Water Potential (-MPa)",y="% of Maximum NSC")

# do Tissue~NSC regressions really quick
slope_nsc<-wp_nsc %>%
  group_by(Species,Tissue) %>%
  do(data.frame(slope = coef(lm(pct_max~Ypd,data=.))[2],error=summary(lm(pct_max~Ypd,data=.))$coefficients[2, 2],sig=summary(lm(pct_max~Ypd,data=.))$coefficients[2, 4]))%>%
  mutate(Organ="NSC")


# individual tissues tell a cool but pretty simple story. 
tissue_ss<-ggplot(wp_sugar,aes(Ypd,pct_max)) + 
  geom_point() + 
  geom_smooth(method="lm") + 
  facet_wrap(Species~Tissue, scale="free") + theme_minimal()+ 
  ggtitle("Sugar")+
  labs(x="Predawn Water Potential (-MPa)",y="% of Maximum Sugar")

slope_ss<-wp_sugar %>%
  group_by(Species,Tissue) %>%
  do(data.frame(slope = coef(lm(pct_max~Ypd,data=.))[2],error=summary(lm(pct_max~Ypd,data=.))$coefficients[2, 2],sig=summary(lm(pct_max~Ypd,data=.))$coefficients[2, 4]))%>%
  mutate(Organ="Sugar")

tissue_st<-ggplot(wp_starch,aes(Ypd,pct_max)) + 
  geom_point() + 
  geom_smooth(method="lm") + 
  facet_wrap(Species~Tissue, scale="free") + theme_minimal() + 
  ggtitle("Starch")+
  labs(x="Predawn Water Potential (-MPa)",y="% of Maximum Starch")

# let's find the sample sizes
st_count<-wp_starch%>%
  group_by(Tissue,Species)%>%
  count(Species)%>%
  mutate(Organ="Starch")
nsc_count<-wp_nsc%>%
  group_by(Tissue,Species)%>%
  count(Species)%>%
  mutate(Organ="NSC")
ss_count<-wp_sugar%>%
  group_by(Tissue,Species)%>%
  count(Species)%>%
  mutate(Organ="Sugar")

allcount<-ss_count%>%
  mutate(n=paste("n=",n,sep=""),slope=0.1)

slope_st<-wp_starch %>%
  group_by(Species,Tissue) %>%
  do(data.frame(slope = coef(lm(pct_max~Ypd,data=.))[2],error=summary(lm(pct_max~Ypd,data=.))$coefficients[2, 2],sig=summary(lm(pct_max~Ypd,data=.))$coefficients[2, 4]))%>%
  mutate(Organ="Starch")

slopes<-rbind(slope_nsc,slope_ss,slope_st)%>%
  mutate(sig=ifelse(sig<0.05,"*",""))
slopes$Tissue<-as.factor(slopes$Tissue)

order<-c("root","bole","twig","leaf")



# let's make a slope plot
slope_plot<-ggplot(slopes,aes(x=slope,Tissue,fill=Organ)) +  scale_y_discrete(limits = order)+
  geom_bar(stat="summary",position = "dodge",colour="white") + geom_vline(aes(xintercept=0))+
  geom_errorbar(stat="identity",aes(xmin=slope-error, xmax=slope+error),width=.0,position=position_dodge(.9)) + geom_text(data=allcount,aes(label=n), position=position_dodge(width=0.9))  +  xlab("Slope Estimate")+ facet_wrap(~Species,scales="free_x")  +  geom_text(aes(x=ifelse(slope>0,slope+.08,slope-.08),y=Tissue,label=sig),stat="identity",position=position_dodge(1)) +
  scale_fill_manual(values=c("Starch"="#FDEA72","Sugar"="#9BE6EF","NSC"="grey")) + 
  theme(axis.text.x = element_text(angle = 0,size=20),axis.text.y=element_text(size=20),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) +  theme(text = element_text(
        size = 20, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     ), legend.position="none"
   )
  


test2<-ggplot(wp_nsc,aes(Ypd,pct_max,color=Variable)) + geom_point() + geom_smooth(method="lm",formula="y~log(x)") + facet_wrap(~Species, scale="free") + theme_minimal()
# ok, whole-tree looks pretty dang good. let's roll with that for figure 1. Maybe figure 3 includes individual tissues? 

# ADD A STARCH COLUMN TO THE TOTAL DATASET
ag_NSC<-rbind(wpnsc_fin,ag)

ag_NSC_canopy<-rbind(wpnsc_canopy,ag)




# Is this figure 1?

j_agjune<-ggplot(subset(ag_NSC,Variable=="Photosynthesis" | Variable=="Growth" & Species=="J. monosperma"),aes(x=abs(Ypd),y=pct)) + stat_smooth(method="lm",formula=y~log(x),se=TRUE,aes(x=abs(Ypd),y=pct,color=Variable),fullrange=TRUE) + stat_smooth(data=subset(ag_NSC,Variable=="NSC"& Species=="J. monosperma"),method="lm",formula=y~x,se=TRUE,aes(x=abs(Ypd),y=pct,color=Variable),fullrange=TRUE) + ylab("% of Maximum") + xlab("Predawn Water Potential (-MPa)") + scale_x_continuous(guide = guide_axis(check.overlap = TRUE),limits=c(1,7),breaks=c(1,2,3,4,5,6,7)) +  scale_color_manual(values=c("Photosynthesis"="#5b859e","Growth"="#df8d71","NSC"="grey")) + theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(text = element_text(
        size = 21, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   )   + ylim(-10,100) + geom_hline(yintercept=0,linetype="dotted") + 
  geom_text(subset(g,Species=="J. monosperma"),mapping=aes(x=1.5,y=100,label=lab),hjust=-0.2) +
geom_text(subset(p,Species=="J. monosperma"),mapping=aes(x=1.55,y=90,label=lab),hjust=-0.2)+
geom_text(subset(sig,Species=="J. monosperma"),mapping=aes(x=2.5,y=70,label=lab),hjust=-0.2)+  
geom_text(subset(st,Species=="J. monosperma"),mapping=aes(x=1.65,y=80,label=Equation),hjust=-0.2) +
  theme(text = element_text(
        size = 15, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + theme(legend.title = element_blank()) + 
  ggtitle("J. monosperma") + 
  theme(plot.title = element_text(size = 12, face = "italic",hjust=0.5,vjust=-0.2))



p_agjune<-ggplot(subset(ag_NSC,Variable=="Photosynthesis" | Variable=="Growth" & Species=="P. edulis"),aes(abs(Ypd),pct)) + scale_shape_manual(values=c(1,2)) + geom_smooth(method="lm",formula=y~log(x),se=TRUE,aes(x=abs(Ypd),y=pct,color=Variable),fullrange=TRUE) + stat_smooth(data=subset(ag_NSC,Variable=="NSC"& Species=="P. edulis"),method="lm",formula=y~x,se=TRUE,aes(x=abs(Ypd),y=pct,color=Variable),fullrange=TRUE)  +ylab("% of Maximum") + xlab("Predawn Water Potential (-MPa)") + scale_x_continuous(guide = guide_axis(check.overlap = TRUE),limits=c(1,4),breaks=c(1,2,3,4)) +  scale_color_manual(values=c("Photosynthesis"="#5b859e","Growth"="#df8d71","NSC"="grey")) + theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(text = element_text(
        size = 21, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   )   + ylim(-10,100) + geom_hline(yintercept=0,linetype="dotted") + 
  geom_text(subset(g,Species=="P. edulis"),mapping=aes(x=1.5,y=100,label=lab),hjust=-0.2) +
geom_text(subset(p,Species=="P. edulis"),mapping=aes(x=1.52,y=90,label=lab),hjust=-0.2)+
geom_text(subset(sig,Species=="P. edulis"),mapping=aes(x=2,y=70,label=lab),hjust=-0.2)+  
geom_text(subset(st,Species=="P. edulis"),mapping=aes(x=1.57,y=80,label=Equation),hjust=-0.2) + 
  theme(text = element_text(
        size = 15, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + theme(legend.title = element_blank()) + 
  ggtitle("P. edulis") + 
  theme(plot.title = element_text(size = 12, face = "italic",hjust=0.5,vjust=-0.2))


j_ag<-ggplot(subset(ag_NSC_canopy,Variable=="Photosynthesis" & Species=="J. monosperma"),aes(x=abs(Ypd),y=pct)) + stat_smooth(method="lm",formula=y~log(x),se=TRUE,aes(x=abs(Ypd),y=pct,color=Variable),fullrange=TRUE) + geom_smooth(data=subset(ag_NSC_canopy,Variable=="Growth" & Species=="J. monosperma"),method="lm",formula=y~log(x),se=TRUE,aes(x=abs(Ypd),y=pct,color=Variable),fullrange=TRUE) + stat_smooth(data=subset(ag_NSC_canopy,Variable=="NSC"& Species=="J. monosperma"),method="lm",se=TRUE,aes(x=abs(Ypd),y=pct,color=Variable),fullrange=TRUE) + ylab("% of Maximum") + xlab("Predawn Water Potential (-MPa)") + scale_x_continuous(guide = guide_axis(check.overlap = TRUE),limits=c(1,7),breaks=c(1,2,3,4,5,6,7)) +  scale_color_manual(values=c("Photosynthesis"="#5b859e","Growth"="#df8d71","NSC"="grey")) + theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(text = element_text(
        size = 21, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   )   + ylim(-10,100) + geom_hline(yintercept=0,linetype="dotted") + 
  geom_text(subset(g,Species=="J. monosperma"),mapping=aes(x=1.55,y=100,label=lab),hjust=-0.2) +
geom_text(subset(p,Species=="J. monosperma"),mapping=aes(x=1.49,y=88,label=lab),hjust=-0.2)+
geom_text(subset(sig,Species=="J. monosperma"),mapping=aes(x=1.83,y=67,label="P = 0.004"),hjust=-0.2)+  
geom_text(subset(st,Species=="J. monosperma"),mapping=aes(x=1.72,y=78,label=Equation),hjust=-0.2) +
  theme(text = element_text(
        size = 15, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + theme(legend.title = element_blank()) + 
  ggtitle("J. monosperma") + 
  theme(plot.title = element_text(size = 12, face = "italic",hjust=0.5,vjust=-0.2))



p_ag<-ggplot(subset(ag_NSC_canopy,Variable=="Photosynthesis" & Species=="P. edulis"),aes(abs(Ypd),pct)) +
  geom_smooth(method="lm",formula=y~log(x),se=TRUE,aes(x=abs(Ypd),y=pct,color=Variable),fullrange=TRUE) +  
  geom_smooth(data=subset(ag_NSC_canopy,Variable=="Growth" & Species=="P. edulis"),method="lm",formula=y~log(x),se=TRUE,aes(x=abs(Ypd),y=pct,color=Variable),fullrange=TRUE) + 
  stat_smooth(data=subset(ag_NSC_canopy,Variable=="NSC"& Species=="P. edulis"),method="lm",se=TRUE,aes(x=abs(Ypd),y=pct,color=Variable),fullrange=TRUE)  +
  ylab("% of Maximum") + 
  xlab("Predawn Water Potential (-MPa)") + 
  scale_x_continuous(guide = guide_axis(check.overlap = TRUE),limits=c(1,4),breaks=c(1,2,3,4)) +
  scale_color_manual(values=c("Photosynthesis"="#5b859e","Growth"="#df8d71","NSC"="grey")) +
  theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  
  theme(text = element_text(
        size = 21, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
  theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   )   + 
  ylim(-10,100) + geom_hline(yintercept=0,linetype="dotted") + 
  geom_text(subset(g,Species=="P. edulis"),mapping=aes(x=1.5,y=100,label=lab),hjust=-0.2) +
  geom_text(subset(p,Species=="P. edulis"),mapping=aes(x=1.47,y=86,label=lab),hjust=-0.2)+
  geom_text(subset(sig,Species=="P. edulis"),mapping=aes(x=1.64,y=66,label=lab),hjust=-0.2)+  
  geom_text(subset(st,Species=="P. edulis"),mapping=aes(x=1.59,y=76,label=Equation),hjust=-0.2) + 
  theme(text = element_text(
        size = 15, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + 
  theme(legend.title = element_blank()) + 
  ggtitle("P. edulis") + 
  theme(plot.title = element_text(size = 12, face = "italic",hjust=0.5,vjust=-0.2))


ag_plot<-ggarrange(j_ag+ rremove("xlab")+ rremove("ylab"),p_ag + rremove("ylab"),nrow=2,legend="none",labels = c("B","C"))


con<-read.csv("concept.csv")%>%
  dplyr::mutate(Parameter=ifelse(Parameter=="Storage","NSC",Parameter))

conplot<-ggplot(con,aes(psi,Value,color=Parameter)) + geom_smooth(method="lm",formula="y~poly(x,2)",se=FALSE) +
ylab("% of Maximum") + xlab("Predawn Water Potential (-MPa)") + scale_x_continuous(guide = guide_axis(check.overlap = TRUE)) +  scale_color_manual(breaks=c("Growth","Photosynthesis","NSC"), values=c("Photosynthesis"="#5b859e","Growth"="#df8d71","NSC"="grey")) + theme(axis.text.x = element_blank(),axis.ticks.x = element_blank(),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(text = element_text(size = 12, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   )   + scale_y_continuous(guide = guide_axis(check.overlap = TRUE),limits=c(-10,100),breaks=c(0,100)) + geom_hline(yintercept=0,linetype="dotted") +  theme(text = element_text(
        size = 15, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + theme(legend.title = element_blank()) + 
  ggtitle("Theoretical Responses") + 
  theme(plot.title = element_text(size = 12, face = "italic",hjust=0.5,vjust=-0.2)) 


  #annotate("text",label="1. Growth declines faster",x=1.2,y=22) + 
  #annotate("text",label="than photosynthesis",x=1.2,y=17) + 
  #annotate("text",label="2. Leading to an excess",x=3.5,y=47) + 
  #annotate("text",label="of carbohydrate supply",x=3.5,y=42) +
  #annotate("text",label="3. Carbon storage increases",x=5.5,y=82) + 
  #annotate("text",label="as photosynthesis > growth",x=5.5,y=77) + 
  #geom_segment(aes(x = 1.5, y = 25, xend = 2, yend = 30),size=0.05,
   #               arrow = arrow(length = unit(0.2, "cm")), color="black")+ 
  #geom_segment(aes(x = 2.5, y = 50, xend = 2.8, yend = 60),size=0.05,
  #                arrow = arrow(length = unit(0.2, "cm")), color="black")+ 
  #geom_segment(aes(x = 3.5, y = 81, xend = 3.1, yend = 75),size=0.05,
   #               arrow = arrow(length = unit(0.2, "cm")), color="black")

c2<-conplot + theme(legend.position="top")

legend <- cowplot::get_legend(conplot)

library(cowplot)
con2<-ggdraw(plot_grid(plot_grid(c2, legend,ncol=1, align='v')))



agplot<-ggarrange(c2,j_ag+ rremove("xlab")+ rremove("ylab"),p_ag + rremove("ylab"),ncol=1,common.legend=TRUE,labels = c("A","B","C"))  



# agplot<-annotate_figure(p=agplot1,left=textGrob("% of Maximum", rot=90, gp = gpar(cex = 1.3)),bottom=textGrob("Predawn Water Potential (-MPa)",gp = gpar(cex = 1.3)))


# supplemental figures, plots by themselves
j_a<-ggplot(subset(ag,Species=="J. monosperma" & Variable =="Photosynthesis"),aes(abs(Ypd),pct)) + geom_point(alpha=0.3,color="black") +  geom_smooth(method="lm",formula=y~log(x),se=TRUE,aes(x=abs(Ypd),y=pct),color="black",fullrange=TRUE)  + facet_wrap(~Species,scales="free") + ylab("% of Maximum") + xlab("Predawn Water Potential (-MPa)") + scale_x_continuous(guide = guide_axis(check.overlap = TRUE),limits=c(1,8),breaks=c(1,2,3,4,5,6,7,8)) +  scale_color_manual(values=wes_palette("GrandBudapest1",n=5,type='continuous')) + theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(text = element_text(
        size = 12, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   )   + ylim(-10,100) + geom_hline(yintercept=0,linetype="dotted") + geom_text(subset(p,Species=="J. monosperma"),mapping=aes(x=1.6,y=100,label=lab),hjust=-0.2) +  
  theme(text = element_text(
        size = 15, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + theme(legend.title = element_blank())

j_g<-ggplot(subset(ag,Species=="J. monosperma" & Variable =="Growth"),aes(abs(Ypd),pct)) + geom_point(alpha=0.3,color="black") +  geom_smooth(method="lm",formula=y~log(x),se=TRUE,aes(x=abs(Ypd),y=pct),color="black",fullrange=TRUE)   + facet_wrap(~Species,scales="free") + ylab("% of Maximum") + xlab("Predawn Water Potential (-MPa)") + scale_x_continuous(guide = guide_axis(check.overlap = TRUE),limits=c(1,8),breaks=c(1,2,3,4,5,6,7,8)) +  scale_color_manual(values=wes_palette("GrandBudapest1",n=5,type='continuous')) + theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(text = element_text(
        size = 12, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   )   + ylim(-10,100) + geom_hline(yintercept=0,linetype="dotted") + 
  geom_text(subset(g,Species=="J. monosperma"),mapping=aes(x=2.1,y=100,label=lab),hjust=-0.2) + 
  theme(text = element_text(
        size = 15, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + theme(legend.title = element_blank())

p_a<-ggplot(subset(ag,Species=="P. edulis" & Variable =="Photosynthesis"),aes(abs(Ypd),pct)) + geom_point(alpha=0.3,color="black") +  geom_smooth(method="lm",formula=y~log(x),se=TRUE,aes(x=abs(Ypd),y=pct),color="black",fullrange=TRUE)   + facet_wrap(~Species,scales="free") + ylab("% of Maximum") + xlab("Predawn Water Potential (-MPa)") + scale_x_continuous(guide = guide_axis(check.overlap = TRUE),limits=c(1,8),breaks=c(1,2,3,4,5,6,7,8)) +  scale_color_manual(values=wes_palette("GrandBudapest1",n=5,type='continuous')) + theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(text = element_text(
        size = 12, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   )   + ylim(-10,100) + geom_hline(yintercept=0,linetype="dotted") + 
  geom_text(subset(p,Species=="P. edulis"),mapping=aes(x=1.6,y=100,label=lab),hjust=-0.2) + 
  theme(text = element_text(
        size = 15, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + theme(legend.title = element_blank())

p_g<-ggplot(subset(ag,Species=="P. edulis" & Variable =="Growth"),aes(abs(Ypd),pct)) + geom_point(alpha=0.3,color="black") +  geom_smooth(method="lm",formula=y~log(x),se=TRUE,aes(x=abs(Ypd),y=pct),color="black",fullrange=TRUE)   + facet_wrap(~Species,scales="free") + ylab("% of Maximum") + xlab("Predawn Water Potential (-MPa)") + scale_x_continuous(guide = guide_axis(check.overlap = TRUE),limits=c(1,8),breaks=c(1,2,3,4,5,6,7,8)) +  scale_color_manual(values=wes_palette("GrandBudapest1",n=5,type='continuous')) + theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(text = element_text(
        size = 12, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   )   + ylim(-10,100) + geom_hline(yintercept=0,linetype="dotted") + 
  geom_text(subset(g,Species=="P. edulis"),mapping=aes(x=2.1,y=100,label=lab),hjust=-0.2) + 
  theme(text = element_text(
        size = 15, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + theme(legend.title = element_blank())

ind_arr<-ggarrange(j_g,j_a,p_g,p_a,ncol=2,nrow=2,labels=c("A","B","C","D"))



###########################################################
# Let's make a new figure of growth versus photosynthesis
###########################################################
asub<-ag%>%
  dplyr::filter(Variable=="Photosynthesis")%>%
  dplyr::rename(Photosynthesis=pct)%>%
  dplyr::select(-Variable)
gsub<-ag%>%
  dplyr::filter(Variable=="Growth")%>%
  dplyr::rename(Growth=pct)%>%
  dplyr::select(-Variable)
agnew<-merge(asub,gsub) %>% distinct()

# let's put a quick statistical test in here.

jtest<-lm(Photosynthesis[Species=="J. monosperma"]~Growth[Species=="J. monosperma"],agnew)
summary(jtest) # p = 0.01; R^2 = 0.05
plot(jtest)
jk<-ks.test(jtest$residuals,pnorm(c(.025,.0975))) # ok, it's normal

ptest<-lm(Photosynthesis[Species=="P. edulis"]~Growth[Species=="P. edulis"],agnew)
summary(ptest) # p = 0.9; R^2 = -0.01


a_g<-ggplot(agnew,aes(Photosynthesis,Growth,color=Species)) + geom_point() + geom_smooth(method="lm") + facet_wrap(~Species) + ylab("% of Maximum Growth") + xlab("% of Maximum Photosynthesis") + scale_color_manual(values=wes_palette("GrandBudapest1",n=2,type='discrete')) + theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(text = element_text(
        size = 12, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   )   + 
  theme(text = element_text(
        size = 15, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + theme(legend.title = element_blank(),legend.position = "none",
        plot.margin=unit(c(0.2,0.2,0.2,0.2), "cm")) 



# make time series of A and G
agnew$Month<-as.numeric(agnew$Month)
agnew$Year<-as.numeric(agnew$Year)
agnew$Date <- zoo::as.yearmon(paste(agnew$Year, agnew$Month), "%Y %m")

agnew2<-agnew%>%
  dplyr::group_by(Species,Date)%>%
  dplyr::mutate(avg_A=mean(Photosynthesis))%>%
  dplyr::mutate(sem_A=sem(Photosynthesis))%>%
  dplyr::mutate(avg_G=mean(Growth))%>%
  dplyr::mutate(sem_G=sem(Growth))

agnew2$Date<-as.factor(agnew2$Date)

count<-agnew2%>%
  distinct()%>%
  group_by(Year,Month,Species)%>%
  count(Species)

labs <- data.frame(
  Species = c("J. monosperma","P. edulis"),
    label = c("n=11","n=12"),
              Year=2012)


ag_time<-ggplot(agnew2,aes(Date,avg_A,group=Year)) + geom_point(aes(color="Photosynthesis"))+ geom_text(data=labs,x=2,y=80,aes(label=label)) + geom_errorbar(aes(ymin=avg_A-sem_A,ymax=avg_A+sem_A,color="Photosynthesis")) + facet_wrap(~Species) + geom_line(aes(color="Photosynthesis"),size=1) + geom_point(data=agnew2,aes(Date,avg_G,color="Growth")) + geom_errorbar(aes(ymin=avg_G-sem_G,ymax=avg_G+sem_G,color="Growth")) +  geom_line(data=agnew2,aes(Date,avg_G,color="Growth"),size=1) + ylab("% of Maximum") + xlab("") +  theme(axis.text.x = element_text(angle = 45,size=10,vjust=-0.0005),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(text = element_text(
        size = 12, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   )   + 
  theme(text = element_text(
        size = 15, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + theme(legend.title = element_blank(),legend.position="top") +
    scale_color_manual(values = c("Photosynthesis" = "#5b859e","Growth"="#df8d71")) + scale_x_discrete(limits=c("May 2013","Jun 2013","Jul 2013","Aug 2013","Sep 2013","","May 2014","Jun 2014","Jul 2014","Aug 2014","Sep 2014")) + geom_vline(xintercept = "",linetype="dotted") 


```

``` {r A and G Statistics, include=FALSE,results='asis'}

# Questions 1: Are G and A thresholds different? (i.e. do they stop at different times?)
ag$Species<-as.factor(ag$Species)
ag$Variable<-as.factor(ag$Variable)
ag_stat<-ag%>%
  ungroup()%>%
  dplyr::select(Species,Variable)%>%
  distinct()

hold<-data.frame(NULL)
result<-data.frame(NULL)
for (i in levels(ag$Variable)) {
  for (j in levels(ag$Species)) {
  mod<-lm(pct~log(abs(Ypd)),data=subset(ag, Species==j & Variable==i ))
  r<-summary(mod)[["r.squared"]]
  P<-round(summary(mod)$coefficients[2,4],5) 
  c<-cbind(data.frame(coef(summary(mod))),i,j)
  result<-rbind(result,c)
  rp<-cbind(r,P)
  hold<-rbind(hold,rp)
}
}
res_new<-cbind(ag_stat,hold)

result2<-result%>%
  rename(P=4,Variable=5,Species=6)%>%
  mutate(P=round(P,3))
r2<-flextable(result2)
flextable(result2) %>% save_as_docx( path = "S2.docx")

res_new<-res_new%>%
  dplyr::rename("r_squared"=r)%>%
  dplyr::rename("p-value"=P)%>%
  mutate(Comparison = "% of Maximum ~ Predawn Water Potential")%>%
  mutate("p-value"="<0.001")

terms<-as.data.frame(c("Intercept","Growth:Water Potential","Growth:Water Potential:Photosynthesis"))

pdata<-ag%>%
  filter(Species=="P. edulis")
pinon<-lm(pct~log(abs(Ypd))+log(abs(Ypd)):Variable,data=pdata)
summary(pinon) # not significant for pinon
pres<-as.data.frame(coef(summary(pinon)))%>%
  dplyr::rename("P"=4)%>%
  dplyr::mutate(P=round(P,3))
pR<-as.data.frame(summary(pinon)[['r.squared']])%>%
  dplyr::rename("Adjusted R-Squared"=1)
species<-as.data.frame(c("P. edulis","P. edulis","P. edulis"))%>%
  dplyr::rename(Species=1)
pres<-cbind(pres,pR)%>%
  cbind(terms,.,species)


jdata<-ag%>%
  filter(Species=="J. monosperma")
juniper<-lm(pct~log(abs(Ypd))+log(abs(Ypd)):Variable,data=jdata)
summary(juniper) # the lines ARE significantly different.....
jres<-as.data.frame(coef(summary(juniper)))%>%
  dplyr::rename("P"=4)%>%
  dplyr::mutate(P=round(P,3))
jR<-as.data.frame(summary(juniper)[['r.squared']])%>%
  dplyr::rename("Adjusted R-Squared"=1)
species<-as.data.frame(c("J. monosperma","J. monosperma","J. monosperma"))%>%
  dplyr::rename(Species=1)
jres<-cbind(jres,jR)%>%
  cbind(terms,.,species)

results<-rbind(pres,jres)%>%
  dplyr::rename(Terms=1)
ag_comparison<-flextable(results)


ag_var<-as.data.frame(c("P. edulis","J. monosperma","P. edulis","J. monosperma"))%>%
  dplyr::rename(Species=1)%>%
  dplyr::mutate(Variable=c("Growth","Growth","Photosynthesis","Photosynthesis"))%>%
  dplyr::mutate(r_squared=c(0.065,0.1086,0.377,0.474))%>%
  dplyr::mutate("p-value"=c("<0.05","<0.05","<0.05","<0.05"))%>%
  dplyr::mutate(Comparison=c("% Maximum ~ Predawn water potential","% Maximum ~ Predawn water potential","% Maximum ~ Predawn water potential","% Maximum ~ Predawn water potential"))
ag_var<-flextable(ag_var)



#ag_var<-kbl(res_new,align='c',table.attr = "style = \"color: black;\"")%>%
 # kable_classic(full_width = F, html_font = "Cambria")%>%
  #  kable_styling(font_size = 20)
#ag_comparison<-kbl(test,align='c',table.attr = "style = \"color: black;\"")%>%
 # kable_classic(full_width = F, html_font = "Cambria")%>%
  #  kable_styling(font_size = 20)






```

```{r NSC, include=FALSE,results='asis'}

NSC <- read.csv("NSC.csv")%>%
  mutate(Month=substr(Date,6,7)) # import NSC data and make into useable format
treats <- NSC %>%
  dplyr::select(Year, Species, ID, Treatment) # make a treatments dataframe for later



#------- ANALYZE TIME-SERIES OF NSC ------------#
ss<-NSC%>%
  dplyr::select(Year,Month,Date,Species,ID,Tissue,Tot.Sug)%>%
  dplyr::rename(conc=Tot.Sug)%>%
  mutate(component="Sugar") # making data long for each component
nsc<-NSC%>%
  dplyr::select(Year,Month,Date,Species,ID,Tissue,Tot.NSC)%>%
  dplyr::rename(conc=Tot.NSC)%>%
  mutate(component="NSC")
st<-NSC%>%
  dplyr::select(Year,Month,Date,Species,ID,Tissue,Starch)%>%
  dplyr::rename(conc=Starch)%>%
  mutate(component="Starch")
allnsc<-rbind(ss,nsc,st)%>% # combine the long datasets
  drop_na()%>% # drop empty rows
  dplyr::group_by(ID,Date,component)%>%
  dplyr::mutate(tot.con=sum(conc))%>% # sum all tissue concentrations to get total component for each tree
  dplyr::group_by(Species,Month,Year,component)%>%
  dplyr::mutate(avg_conc=mean(tot.con))%>% # find average of each component for the species
  dplyr::mutate(sem_conc=sem(tot.con))%>%
  dplyr::group_by(Species,component)%>%
  dplyr::mutate(max=max(avg_conc))%>%
  ungroup()%>%
  dplyr::mutate(pct_conc=avg_conc/max)%>% # calculate the % of maximum by component
  dplyr::select(Year,Month,Species,component,pct_conc)%>%
  distinct()%>%
  dplyr::mutate(Species=ifelse(Species=="JUMO","J. monosperma","P. edulis"))

# SUPPLEMENTARY FIGURE 1
# make time series of NSC
nsc_time<-ggplot(allnsc,aes(Month,pct_conc,color=component,group=component)) + geom_point(alpha=0.4) + geom_smooth(se=FALSE) + facet_wrap(~Species) + ylab("% of Maximum") + xlab("Date") + scale_x_discrete(guide = guide_axis(check.overlap = TRUE)) +  scale_color_manual(values=c("NSC"="black","Starch"="#FDEA72","Sugar"="#9BE6EF")) + theme(axis.text.x = element_text(angle = 45,size=12,vjust=.05),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(text = element_text(
        size = 20, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   )



#----------- LOOK AT THE RESPONSE OF WHOLE-TREE NSC TO PSI -------------#

NSC_new <- read.csv("NSC.csv")%>%
  dplyr::mutate(Month=substr(Date,6,7))%>% # read in data, make the month data useable
  drop_na()%>%
  dplyr::select(Year,Month,ID,Tissue,Starch,Tot.Sug,Tot.NSC)%>%
  distinct()%>%
  dplyr::group_by(ID,Month,Year)%>%
  # for each time point, average whole-tree NSC
  dplyr::mutate(wt_sugar=mean(Tot.Sug))%>%
  dplyr::mutate(wt_starch=mean(Starch))%>%
  dplyr::mutate(wt_NSC=mean(Tot.NSC))
  #dplyr::filter(ID!=32 |ID!=26 |ID!=23 |ID!=22 |ID!=20 |ID!=17 |ID!=14|ID!=10|ID!=8)
NSC_new$ID<-as.numeric(NSC_new$ID)

watpot <- read.csv("waterpotential.csv",   na.strings=c("", "NA"))# read in water potential data
jumo <- watpot %>%
  filter(!grepl("P", Tree_ID)) %>%
  dplyr::mutate(Species = "J. monosperma")
pipo <- watpot %>%
  filter(!grepl("J", Tree_ID)) %>%
  dplyr::mutate(Species = "P. edulis")
watpot <- rbind(jumo, pipo)%>%
    dplyr::rename(ID = "Tree_ID")%>%
    dplyr::select(-Ymd)
watpot$ID<-gsub("P", "", watpot$ID)
watpot$ID<-gsub("J", "", watpot$ID)
watpot$ID<-as.numeric(watpot$ID)
watpot <- watpot %>%
  dplyr::mutate(Month = substr(as.character(Date), 6, 7))%>%
  dplyr::select(-Date,-DOY)
watpot$Month <- as.numeric(watpot$Month)

temp<-NSC_new%>%
  dplyr::filter(Month=="10")
NSC_new<-NSC_new%>%
  dplyr::filter(Month!="10")

NSC_new$Month<-gsub("0","",NSC_new$Month)
NSC_new<-rbind(NSC_new,temp)

wp_nsc<-merge(NSC_new,watpot)%>%
  dplyr::mutate(Ypd=abs(Ypd))%>%
  dplyr::group_by(ID,Tissue)%>%
  dplyr::mutate(maxNSC=max(wt_NSC))%>%
  dplyr::mutate(maxSugar=max(wt_sugar))%>%
  dplyr::mutate(maxStarch=max(wt_starch))%>%
  dplyr::mutate(NSC=(wt_NSC/maxNSC)*100)%>%
  dplyr::mutate(Sugar=(wt_sugar/maxSugar)*100)%>%
  dplyr::mutate(Starch=(wt_starch/maxStarch)*100)

### Tissue-level analysis
tissue<-wp_nsc%>%
  ungroup()%>%
  dplyr::select(Species,Tissue,Ypd,NSC,Sugar,Starch)


# quick test plot
t<-ggplot(wp_nsc,aes(Ypd,NSC)) + 
  geom_smooth(method="lm",formula=y~log(x))+ 
  geom_smooth(method="lm",formula=y~log(x),aes(Ypd,Sugar),color="black")+ 
  geom_smooth(method="lm",formula=y~log(x),aes(Ypd,Starch),color="red")


june<-wp_nsc%>%
  #dplyr::filter(Tissue!="bole" & Tissue!="root") %>%
  dplyr::filter(Month==6)
# look at just june
tj<-ggplot(june,aes(Ypd,NSC)) + 
  geom_smooth(method="lm",formula=y~log(x))+ 
  geom_smooth(method="lm",formula=y~log(x),aes(Ypd,Sugar),color="black")+ 
  geom_smooth(method="lm",formula=y~log(x),aes(Ypd,Starch),color="red") + 
  facet_wrap(~Species,scale="free")
# same same

canopy<-wp_nsc%>%
  dplyr::filter(Tissue!="bole" & Tissue!="root")

# look at just canopy
tc<-ggplot(canopy,aes(Ypd,NSC)) + 
  geom_smooth(method="lm",formula=y~log(x))+ 
  geom_smooth(method="lm",formula=y~log(x),aes(Ypd,Sugar),color="black")+ 
  geom_smooth(method="lm",formula=y~log(x),aes(Ypd,Starch),color="red") + 
  facet_wrap(~Species,scale="free")
#looks good
```

``` {r NSC stats}
######### find best fit model for Starch in June, first ######
starch<-june%>%
  dplyr::filter(Variable=="Starch")
pied<-starch%>%
  filter(Species=="P. edulis")%>%
  drop_na()
jumo<-starch%>%
  filter(Species=="J. monosperma")%>%
  drop_na()


### a. linear
stp<-lm(pied$avg_pct~pied$Ypd)
summary(stp)
stj<-lm(jumo$avg_pct~jumo$Ypd)
summary(stj)
### b. exponential
exp_pied<-lm(pied$avg_pct~exp(pied$Ypd))
summary(exp_pied)
exp_jumo<-lm(jumo$avg_pct~exp(jumo$Ypd))
summary(exp_jumo)
### c. polynomial
poly_pied<-lm(pied$avg_pct~poly((abs(pied$Ypd)),2))
summary(poly_pied) # explains 20% of variation!
  # formula: y= 10.4 - 19.8x + 11.3x^2; significant
poly_jumo<-lm(jumo$avg_pct~poly((abs(jumo$Ypd)),2))
summary(poly_jumo) # only explains about 1.3% of variation!
# formula: y= 8.23 + 3.315x + 3.928x^2 ; not significant but second term is close!
### d. logarithmic
log_pied<-lm(pied$avg_pct~log(abs(pied$Ypd)))
summary(log_pied)
log_jumo<-lm(jumo$avg_pct~log(abs(jumo$Ypd)))
summary(log_jumo)

pied_aic<-AICtab(stp,exp_pied,poly_pied,log_pied,base=TRUE,sort=TRUE,weights=TRUE) # linear  model is best for June


paic<-as.data.frame(pied_aic)%>%
  dplyr::mutate(Species="P. edulis")%>%
  dplyr::mutate(Model=c("Linear","Polynomial","Linear-Log","Negative Exponential"))%>%
  dplyr::select(Model,AIC,dAIC,df,weight,Species)

jumo_aic<-AICtab(stj,exp_jumo,poly_jumo,log_jumo,base=TRUE,sort=TRUE,weights=TRUE) # linear-log model is best for jumo june starch

jaic<-as.data.frame(jumo_aic)%>%
  dplyr::mutate(Species="J. monosperma")%>%
  dplyr::mutate(Model=c("Linear-Log","Linear","Polynomial","Negative Exponential"))%>%
  dplyr::select(Model,AIC,dAIC,df,weight,Species)

aicstarch<-rbind(paic,jaic)%>%
  mutate(Variable="Starch")


# CHECK SUGAR
sugar<-june%>%
  dplyr::filter(Variable=="Sugar")
pied<-sugar%>%
  filter(Species=="P. edulis")%>%
  drop_na()
jumo<-sugar%>%
  filter(Species=="J. monosperma")%>%
  drop_na()
### a. linear
sup<-lm(pied$avg_pct~pied$Ypd)
summary(sup)
suj<-lm(jumo$avg_pct~jumo$Ypd)
summary(suj)
### b. exponential
exp_pied<-lm(pied$avg_pct~exp(pied$Ypd))
summary(exp_pied)
exp_jumo<-lm(jumo$avg_pct~exp(jumo$Ypd))
summary(exp_jumo)
### c. polynomial
poly_pied<-lm(pied$avg_pct~poly((abs(pied$Ypd)),2))
summary(poly_pied) # explains 1.7% of variation
# formula: y= 8.76 -5.81x + 2.08x^2; only second term is significant
poly_jumo<-lm(jumo$avg_pct~poly((abs(jumo$Ypd)),2))
summary(poly_jumo) # explains 5% of variation
# formula: y= 6.13 + 6.38x + 1.56x^2; only second term is significant
### d. logarithmic
log_pied<-lm(pied$avg_pct~log(abs(pied$Ypd)))
summary(log_pied)
log_jumo<-lm(jumo$avg_pct~log(abs(jumo$Ypd)))
summary(log_jumo)

pied_aic<-AICtab(sup,exp_pied,poly_pied,log_pied,base=TRUE,sort=TRUE,weights=TRUE) # polynomial  model is best
paic<-as.data.frame(pied_aic)%>%
  dplyr::mutate(Species="P. edulis")%>%
  dplyr::mutate(Model=c("Polynomial","Linear-Log","Linear","Negative Exponential"))%>%
  dplyr::select(Model,AIC,dAIC,df,weight,Species)

jumo_aic<-AICtab(suj,exp_jumo,poly_jumo,log_jumo,base=TRUE,sort=TRUE,weights=TRUE) # polynomial model is best
jaic<-as.data.frame(jumo_aic)%>%
  dplyr::mutate(Species="J. monosperma")%>%
  dplyr::mutate(Model=c("Polynomial","Linear","Linear-Log","Negative Exponential"))%>%
  dplyr::select(Model,AIC,dAIC,df,weight,Species)

aicss<-rbind(paic,jaic)%>%
  mutate(Variable="Sugar")


aic_junensc<-rbind(aicstarch,aicss)%>%
  dplyr::select(Species,Variable,Model,dAIC,df,weight)%>%
  dplyr::mutate(weight=round(weight,3))
aicjune_polys<-flextable(aic_junensc)




####################### now let's repeat this process for canopy data  ################
starch<-canopy%>%
  dplyr::filter(Variable=="Starch")
pied<-starch%>%
  filter(Species=="P. edulis")%>%
  drop_na()
jumo<-starch%>%
  filter(Species=="J. monosperma")%>%
  drop_na()


####################### a. linear
stp<-lm(pied$avg_pct~pied$Ypd)
summary(stp)
stj<-lm(jumo$avg_pct~jumo$Ypd)
summary(stp)
### b. exponential
exp_pied<-lm(pied$avg_pct~exp(pied$Ypd))
summary(exp_pied)
exp_jumo<-lm(jumo$avg_pct~exp(jumo$Ypd))
summary(exp_jumo)
### c. polynomial
poly_pied<-lm(pied$avg_pct~poly((abs(pied$Ypd)),2))
summary(poly_pied) # explains 20% of variation!
  # formula: y= 10.4 - 19.8x + 11.3x^2; significant
poly_jumo<-lm(jumo$avg_pct~poly((abs(jumo$Ypd)),2))
summary(poly_jumo) # only explains about 1.3% of variation!
# formula: y= 8.23 + 3.315x + 3.928x^2 ; not significant but second term is close!
### d. logarithmic
log_pied<-lm(pied$avg_pct~log(abs(pied$Ypd)))
summary(log_pied)
log_jumo<-lm(jumo$avg_pct~log(abs(jumo$Ypd)))
summary(log_jumo)

pied_aic<-AICtab(stp,exp_pied,poly_pied,log_pied,base=TRUE,sort=TRUE,weights=TRUE) # linear  model is best for canopy


paic<-as.data.frame(pied_aic)%>%
  dplyr::mutate(Species="P. edulis")%>%
  dplyr::mutate(Model=c("Linear","Polynomial","Linear-Log","Negative Exponential"))%>%
  dplyr::select(Model,AIC,dAIC,df,weight,Species)

jumo_aic<-AICtab(stj,exp_jumo,poly_jumo,log_jumo,base=TRUE,sort=TRUE,weights=TRUE) # linear-log model is best for jumo canopy starch

jaic<-as.data.frame(jumo_aic)%>%
  dplyr::mutate(Species="J. monosperma")%>%
  dplyr::mutate(Model=c("Linear-Log","Linear","Polynomial","Negative Exponential"))%>%
  dplyr::select(Model,AIC,dAIC,df,weight,Species)
aicstarch_canopy<-rbind(paic,jaic)%>%
  mutate(Variable="Starch")


################ CHECK SUGAR
sugar<-canopy%>%
  dplyr::filter(Variable=="Sugar")
pied<-sugar%>%
  filter(Species=="P. edulis")%>%
  drop_na()
jumo<-sugar%>%
  filter(Species=="J. monosperma")%>%
  drop_na()
### a. linear
sup<-lm(pied$avg_pct~pied$Ypd)
summary(sup)
suj<-lm(jumo$avg_pct~jumo$Ypd)
summary(suj)
### b. exponential
exp_pied<-lm(pied$avg_pct~exp(pied$Ypd))
summary(exp_pied)
exp_jumo<-lm(jumo$avg_pct~exp(jumo$Ypd))
summary(exp_jumo)
### c. polynomial
poly_pied<-lm(pied$avg_pct~poly((abs(pied$Ypd)),2))
summary(poly_pied) # explains 1.7% of variation
# formula: y= 8.76 -5.81x + 2.08x^2; only second term is significant
poly_jumo<-lm(jumo$avg_pct~poly((abs(jumo$Ypd)),2))
summary(poly_jumo) # explains 5% of variation
# formula: y= 6.13 + 6.38x + 1.56x^2; only second term is significant
### d. logarithmic
log_pied<-lm(pied$avg_pct~log(abs(pied$Ypd)))
summary(log_pied)
log_jumo<-lm(jumo$avg_pct~log(abs(jumo$Ypd)))
summary(log_jumo)

pied_aic<-AICtab(sup,exp_pied,poly_pied,log_pied,base=TRUE,sort=TRUE,weights=TRUE) # linear  model is best
paic<-as.data.frame(pied_aic)%>%
  dplyr::mutate(Species="P. edulis")%>%
  dplyr::mutate(Model=c("Linear","Linear-Log","Polynomial","Negative Exponential"))%>%
  dplyr::select(Model,AIC,dAIC,df,weight,Species)

jumo_aic<-AICtab(suj,exp_jumo,poly_jumo,log_jumo,base=TRUE,sort=TRUE,weights=TRUE) # polynomial model is best
jaic<-as.data.frame(jumo_aic)%>%
  dplyr::mutate(Species="J. monosperma")%>%
  dplyr::mutate(Model=c("Polynomial","Linear","Linear-Log","Negative Exponential"))%>%
  dplyr::select(Model,AIC,dAIC,df,weight,Species)
aicss_canopy<-rbind(paic,jaic)%>%
  mutate(Variable="Sugar")

aic_canopynsc<-rbind(aicstarch_canopy,aicss_canopy)%>%
  dplyr::select(Species,Variable,Model,dAIC,df,weight)%>%
  dplyr::mutate(weight=round(weight,3))
aiccanopy_polys<-flextable(aic_canopynsc)



# total NSC regressions
jn<-canopy%>%
  filter(Species=="J. monosperma")
jnmod<-lm(NSC~Ypd,data=jn)
summary(jnmod) # significant; r-squared = 0.009
#y = -1.4x + 62.15

pn<-canopy%>%
  filter(Species=="P. edulis")
pnmod<-lm(NSC~Ypd,data=pn)
summary(pnmod) # significant, r-squared = 0.009
# y = -10.12x + 75.37
```


``` {r NSC figures}
# ADD UPDATED TABLES TO SUPPLEMENTARY
# ADD CANOPY FIGURES TO SUPPLEMENTARY
# DO IT ALL AGAIN FOR INDIVIDUAL TISSUES?
########### JUNE FIGS #########
june<-june%>%
  ungroup()%>%
  dplyr::select(Species,Ypd,NSC,Sugar,Starch)%>%
  pivot_longer(cols=c(NSC,Sugar,Starch),names_to="Variable",values_to="pct_max")

jumo_nsc<-ggplot(subset(june,Species=="J. monosperma"),aes(Ypd,pct_max,color=Variable)) + geom_point(alpha=0.5) + geom_smooth(method="lm",formula=y~log(x),se=TRUE) + ylab("% of Maximum") + xlab("Predawn Water Potential (-MPa)") + scale_x_continuous(guide = guide_axis(check.overlap = TRUE),limits=c(1,8),breaks=c(1,2,3,4,5,6,7,8)) + scale_y_continuous(limits=c(0,125),breaks=c(0,10,20,30,40,50,60,70,80,90,100)) + scale_color_manual(values=c("Starch"="#FDEA72","Sugar"="#9BE6EF"))  + theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(strip.text.x = element_text(
        size = 20, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + labs(color="Component")+  theme(text = element_text(
        size = 15, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + labs(title="J. monosperma")+
  annotate("text",x=3,y=120,label="Sugar: y = 0.59 + 2.81x* - 0.25x²") +
  annotate("text",x=3,y=115,label="Starch: y = 0.042 + 0.08x*")+ theme(legend.title = element_blank())


pied_nsc<-ggplot(subset(june,Species=="P. edulis"),aes(Ypd,pct_max,color=Variable)) + 
  geom_point(alpha=0.5) + 
  geom_smooth(method="lm",formula=y~log(x),se=TRUE) + 
  ylab("% of Maximum") + 
  xlab("Predawn Water Potential (-MPa)") + scale_x_continuous(guide = guide_axis(check.overlap = TRUE),limits=c(1,3.5),breaks=c(1,2,3))  + scale_y_continuous(limits=c(0,125),breaks=c(0,10,20,30,40,50,60,70,80,90,100)) +  scale_color_manual(values=c("Starch"="#FDEA72","Sugar"="#9BE6EF"))  + 
  theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(strip.text.x = element_text(
        size = 20, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + labs(color="Component")+  theme(text = element_text(
        size = 15, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + labs(title="P. edulis")+
  annotate("text",x=2,y=120,label="Sugar: y = 0.69 + 0.36x* + 0.03x²")+
  annotate("text",x=2,y=115,label="Starch: y = 0.65 + 0.02x*")+ theme(legend.title = element_blank())


############ canopy figs ##########
c2<-canopy%>%
  ungroup()%>%
  dplyr::select(Species,ID,Ypd,NSC,Sugar,Starch)%>%
  pivot_longer(cols=c(NSC,Sugar,Starch),names_to="Variable",values_to="avg_pct")


jumo_nsccanopy<-ggplot(subset(c2,Species=="J. monosperma"),aes(Ypd,avg_pct,color=Variable)) + geom_point(alpha=0.5) + 
  geom_smooth(data=subset(c2,Species=="J. monosperma" & Variable =="NSC"),aes(Ypd,avg_pct,color=Variable),method="lm",se=TRUE) + 
  geom_smooth(data=subset(c2,Species=="J. monosperma" & Variable =="Sugar"),aes(Ypd,avg_pct,color=Variable),method="lm",formula=y~poly(x,2),se=TRUE) + 
  geom_smooth(data=subset(c2,Species=="J. monosperma" & Variable =="Starch"),aes(Ypd,avg_pct,color=Variable),method="lm",formula=y~log(x),se=TRUE) + 
  ylab("% of Maximum") + xlab("Predawn Water Potential (-MPa)") + scale_x_continuous(guide = guide_axis(check.overlap = TRUE),limits=c(1,8),breaks=c(1,2,3,4,5,6,7,8)) + scale_y_continuous(limits=c(0,125),breaks=c(0,10,20,30,40,50,60,70,80,90,100)) +
scale_color_manual(values=c("Starch"="#FDEA72","Sugar"="#9BE6EF","NSC"="grey")) + theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(strip.text.x = element_text(
        size = 20, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + labs(color="Component")+  theme(text = element_text(
        size = 20, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + labs(title="J. monosperma")+
  annotate("text",x=4.3,y=108,size=5,label="Sugar: y = 60.59 + 274.9x* - 39.64x²") +
  annotate("text",x=4,y=114,size=5,label="Starch: y = 45.64 - 10.04*log(x)") +
  annotate("text",x=3,y=120,size=5,label="NSC: y = 53.8 + 1.2*x") + 
  theme(legend.title = element_blank())

pied_nsccanopy<-ggplot(subset(c2,Species=="P. edulis"),aes(Ypd,avg_pct,color=Variable)) + 
  geom_point(alpha=0.5) + 
  geom_smooth(data=subset(c2,Species=="P. edulis" & Variable=="NSC"),aes(Ypd,avg_pct,color=Variable),method="lm",se=TRUE) + 
  geom_smooth(data=subset(c2,Species=="P. edulis" & Variable=="Sugar"),aes(Ypd,avg_pct,color=Variable),method="lm",se=TRUE) +
  geom_smooth(data=subset(c2,Species=="P. edulis"& Variable=="Starch"),aes(Ypd,avg_pct,color=Variable), method="lm",se=TRUE) + 
  ylab("% of Maximum") + 
  xlab("Predawn Water Potential (-MPa)") + scale_x_continuous(guide = guide_axis(check.overlap = TRUE),limits=c(1,3.5),breaks=c(1,2,3))  + scale_y_continuous(limits=c(0,125),breaks=c(0,10,20,30,40,50,60,70,80,90,100)) +  scale_color_manual(values=c("Starch"="#FDEA72","Sugar"="#9BE6EF","NSC"="grey")) + 
  theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(strip.text.x = element_text(
        size = 20, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + labs(color="Component")+  theme(text = element_text(
        size = 20, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + labs(title="P. edulis")+
  annotate("text",x=2,y=108,size=5,label="Sugar: y = 0.66 + 1.94x*")+
  annotate("text",x=2,y=114,size=5,label="Starch: y = 55.77 - 14.91x") + 
  annotate("text",x=2,y=120,size=5,label="NSC: y = 68.5 - 9.4*x") + 
  theme(legend.title = element_blank())











NSC_1<-NSC%>%
 drop_na()%>%
  dplyr::select(Year,Month,ID,Species,Tot.NSC,Starch,Tot.Sug,Tissue)%>% # select only columns i need
  dplyr::group_by(Year,Month,ID)%>% # group by time / tree for next analysis
  dplyr::mutate(tot.NSC=sum(Tot.NSC))%>% # calculate tree-level total nsc at each time-point
  dplyr::mutate(tot.ss=sum(Tot.Sug))%>% # calculate tree-level total sugar at each time-point
  dplyr::mutate(tot.st=sum(Starch))%>% # calculate tree-level total starch at each time-point
  dplyr::group_by(ID)%>%
  dplyr::mutate(max_NSC=max(tot.NSC))%>% # find the maximum of each NSC component
 dplyr:: mutate(max_sug=max(tot.ss))%>%
  dplyr::mutate(max_starch=max(tot.st))%>%
  ungroup()%>%
  dplyr::mutate(pct_NSC=tot.NSC/max_NSC)%>% # calculate % of max for each component
  dplyr::mutate(pct_sug=tot.ss/max_sug)%>%
  dplyr::mutate(pct_starch=tot.st/max_starch)

NSC1<-NSC_1%>% # make new DF for psi analysis
  dplyr::select(-Tot.NSC,-Tot.Sug,-Starch,-max_NSC,-max_sug,-max_starch,-tot.NSC,-tot.ss,-tot.st,-Tissue)%>%
  drop_na()%>%
  dplyr::mutate(Species=ifelse(Species=="JUMO","J. monosperma","P. edulis"))%>%
  distinct()
NSC1$Month<-as.numeric(NSC1$Month)
wp<-wp%>%
  mutate(Species=ifelse(Species=="JUMO","J. monosperma","P. edulis"))
NSC2<-merge(NSC1,wp) # combine WP and NSC data

# start prepping data for season plot with psi analysis
nsc<-NSC2%>% # make df for each component one by one
  dplyr::select(Year,Month,Species,ID,pct_NSC,Ypd)%>%
  dplyr::rename(pct=pct_NSC)%>% # make a "master" column to make DF long
  drop_na()%>%
  dplyr::mutate(Component="NSC") # create column that describes what component it is
sug<-NSC2%>%dplyr::select(Year,Month,Species,ID,pct_sug,Ypd)%>% #same as above for Sugar and Starch
  dplyr::rename(pct=pct_sug)%>%
  drop_na()%>%
  dplyr::mutate(Component="Sugar")
st<-NSC2%>%dplyr::select(Year,Month,Species,ID,pct_starch,Ypd)%>%
  dplyr::rename(pct=pct_starch)%>%
  drop_na()%>%
  dplyr::mutate(Component="Starch")
mv<-rbind(nsc,sug,st) # stack the dataframes above and make new master NSC data
mv$Ypd<-as.numeric(mv$Ypd)

# FIGURE 3A
# make NSC Ypd figures - IGNORING SEASON FOR NOW
#j_szn<-ggplot(subset(mv,Species=="J. monosperma"),aes(abs(Ypd),pct,color=Component)) +  geom_smooth(method="gam",formula=y~s(log(x),bs="cs",k=1),se=TRUE) +  facet_wrap(~Species,scales="free") + ylab("% of Maximum") +  xlab("Predawn Water Potential (-MPa)") + scale_x_continuous(guide = guide_axis(check.overlap = TRUE),limits=c(1,6),breaks=c(1,2,3,4,5,6)) +  scale_color_manual(values=wes_palette("Zissou1",n=3,type='continuous')) + theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
#panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(strip.text.x = element_text(
     #   size = 20, face = "italic"),
     #   panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
#panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
  # strip.background = element_rect(
   #  color="white", fill="white", size=1.5, linetype="solid"
   #  )
  # ) 

#p_szn<-ggplot(subset(mv,Species=="P. edulis"),aes(abs(Ypd),pct,color=Component)) +  geom_smooth(method="gam",formula=y~s(log(x),bs="cs",k=1),se=TRUE) +  facet_wrap(~Species,scales="free") + ylab("% of Maximum") + xlab("Predawn Water Potential (-MPa)") + scale_x_continuous(guide = guide_axis(check.overlap = TRUE),limits=c(1,3),breaks=c(1,2,3)) +  scale_color_manual(values=wes_palette("Zissou1",n=3,type='continuous')) + theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
#panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(strip.text.x = element_text(
    #    size = 20, face = "italic"),
     #   panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
#panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
  # strip.background = element_rect(
    # color="white", fill="white", size=1.5, linetype="solid"
    # )
  # ) 


#---------------- Make NSC DF for NSC @ Status Tissue-level analysis ----------------------#
# Note: use mixed effects model for these stats, with poly(month) variable
NSC_1.A<-NSC_1%>%
  group_by(ID,Tissue)%>% # group at the tree and tissue level
  mutate(max_NSC=max(Tot.NSC))%>% # find maximum for each component
  mutate(max_sug=max(Tot.Sug))%>%
  mutate(max_starch=max(Starch))%>%
  ungroup()%>%
  dplyr::mutate(pct_NSC=Tot.NSC/max_NSC)%>% # calculate % of max for each component for each tree
  dplyr::mutate(pct_sug=Tot.Sug/max_sug)%>%
  dplyr::mutate(pct_starch=Starch/max_starch)%>%
  dplyr::select(-Tot.NSC,-Tot.Sug,-Starch,-max_NSC,-max_sug,-max_starch,-tot.NSC,-tot.ss,-tot.st)%>%
  drop_na()%>%
  mutate(Species=ifelse(Species=="JUMO","J. monosperma","P. edulis"))


```

``` {r NSC growth, include=FALSE,warning=FALSE,results='asis'}

# bring in growth data, filter for just variables I need
g_new<-growth%>%
  dplyr::select(Year,Month,Species,ID,pct_growth)%>%
  distinct()%>%
  mutate(Species=ifelse(Species=="JUMO","J. monosperma","P. edulis"))


# find pct NSC at tree-level
#------- JUNE ------------#
ssnew_june<-NSC%>%
  dplyr::select(Year,Month,Date,Species,ID,Tissue,Tot.Sug)%>%
  dplyr::rename(conc=Tot.Sug)%>%
  mutate(component="Sugar")%>% # making data long for each component
  #dplyr::filter(Tissue!="bole" & Tissue!="root")
  dplyr::filter(Month=="06")

stnew_june<-NSC%>%
  dplyr::select(Year,Month,Date,Species,ID,Tissue,Starch)%>%
  dplyr::rename(conc=Starch)%>%
  mutate(component="Starch")%>%
  #dplyr::filter(Tissue!="bole" & Tissue!="root")
  dplyr::filter(Month=="06")

nsc_june<-rbind(ssnew_june,stnew_june)%>% # combine the long datasets
  drop_na()%>% # drop empty rows
  dplyr::group_by(ID,Date,component)%>%
  dplyr::mutate(avg_conc=mean(conc))%>% # average all tissue concentrations to get total component for each tree
  ungroup()%>%
  dplyr::group_by(ID,component)%>%
  dplyr::mutate(max=max(avg_conc))%>%
  ungroup()%>%
  dplyr::mutate(pct_conc=(avg_conc/max)*100)%>% # calculate the % of maximum by component
  dplyr::select(Year,Month,Species,ID,Tissue,component,pct_conc)%>%
  distinct()%>%
  dplyr::mutate(Species=ifelse(Species=="JUMO","J. monosperma","P. edulis"))

# combine growth and NSC datasets
ng<-merge(g_new,nsc_june)%>%
  dplyr::mutate(pct_growth=ifelse(pct_growth==0,0.000001,pct_growth))
ng$Species<-as.factor(ng$Species)
ng$component<-as.factor(ng$component)



# first, let's find the line of best fit for each data subset

#####-------JUNE ANALYSIS-------######
pied<-ng%>%filter(Species=="P. edulis"&component=="Starch")%>%drop_na()
jumo<-ng%>%filter(Species=="J. monosperma"&component=="Starch")%>%drop_na()
### a. linear
stp<-lm(pied$pct_conc~pied$pct_growth)
summary(stp)
stj<-lm(jumo$pct_conc~jumo$pct_growth)
summary(stj)
### b. exponential
exp_pied<-lm(pied$pct_conc~exp(pied$pct_growth))
summary(exp_pied)
exp_jumo<-lm(jumo$pct_conc~exp(jumo$pct_growth))
summary(exp_jumo)
### c. polynomial
poly_pied<-lm(pied$pct_conc~poly((abs(pied$pct_growth)),2))
summary(poly_pied) # explains 20% of variation!
  # formula: y= 10.4 - 19.8x + 11.3x^2; significant
poly_jumo<-lm(jumo$pct_conc~poly((abs(jumo$pct_growth)),2))
summary(poly_jumo) # only explains about 1.3% of variation!
# formula: y= 8.23 + 3.315x + 3.928x^2 ; not significant but second term is close!
### d. logarithmic
log_pied<-lm(pied$pct_conc~log(abs(pied$pct_growth)))
summary(log_pied)
log_jumo<-lm(jumo$pct_conc~log(abs(jumo$pct_growth)))
summary(log_jumo)

pied_aic<-AICtab(stp,exp_pied,poly_pied,log_pied,base=TRUE,sort=TRUE,weights=TRUE) # polynomial  model is best
paic<-as.data.frame(pied_aic)%>%
  dplyr::mutate(Species="P. edulis")%>%
  dplyr::mutate(Model=c("Polynomial","Linear-Log","Linear","Negative Exponential"))%>%
  dplyr::select(Model,AIC,dAIC,df,weight,Species)

jumo_aic<-AICtab(stj,exp_jumo,poly_jumo,log_jumo,base=TRUE,sort=TRUE,weights=TRUE) # neg exp model is best
jaic<-as.data.frame(jumo_aic)%>%
  dplyr::mutate(Species="J. monosperma")%>%
  dplyr::mutate(Model=c("Negative Exponential","Linear","Polynomial","Linear-Log"))%>%
  dplyr::select(Model,AIC,dAIC,df,weight,Species)
aicstarch<-rbind(paic,jaic)%>%
  mutate(Variable="Starch")

# CHECK SUGAR
pied<-ng%>%filter(Species=="P. edulis"&component=="Sugar")%>%drop_na()
jumo<-ng%>%filter(Species=="J. monosperma"&component=="Sugar")%>%drop_na()
### a. linear
sup<-lm(pied$pct_conc~pied$pct_growth)
summary(sup)
suj<-lm(jumo$pct_conc~jumo$pct_growth)
summary(suj)
### b. exponential
exp_pied<-lm(pied$pct_conc~exp(pied$pct_growth))
summary(exp_pied)
exp_jumo<-lm(jumo$pct_conc~exp(jumo$pct_growth))
summary(exp_jumo)
### c. polynomial
poly_pied<-lm(pied$pct_conc~poly((abs(pied$pct_growth)),2))
summary(poly_pied) # explains 1.7% of variation
# formula: y= 8.76 -5.81x + 2.08x^2; only second term is significant
poly_jumo<-lm(jumo$pct_conc~poly((abs(jumo$pct_growth)),2))
summary(poly_jumo) # explains 5% of variation
# formula: y= 6.13 + 6.38x + 1.56x^2; only second term is significant
### d. logarithmic
log_pied<-lm(pied$pct_conc~log(abs(pied$pct_growth)))
summary(log_pied)
log_jumo<-lm(jumo$pct_conc~log(abs(jumo$pct_growth)))
summary(log_jumo)

pied_aic<-AICtab(sup,exp_pied,poly_pied,log_pied,base=TRUE,sort=TRUE,weights=TRUE) # linear  model is best
paic<-as.data.frame(pied_aic)%>%
  dplyr::mutate(Species="P. edulis")%>%
  dplyr::mutate(Model=c("Linear","Polynomial","Negative Exponential","Linear-Log"))%>%
  dplyr::select(Model,AIC,dAIC,df,weight,Species)

jumo_aic<-AICtab(suj,exp_jumo,poly_jumo,log_jumo,base=TRUE,sort=TRUE,weights=TRUE) # log model is best
jaic<-as.data.frame(jumo_aic)%>%
  dplyr::mutate(Species="J. monosperma")%>%
  dplyr::mutate(Model=c("Linear-Log","Polynomial","Negative Exponential","Linear"))%>%
  dplyr::select(Model,AIC,dAIC,df,weight,Species)
aicss<-rbind(paic,jaic)%>%
  mutate(Variable="Sugar")


june_aic<-rbind(aicstarch,aicss)%>%
  dplyr::select(Species,Variable,Model,dAIC,df,weight)%>%
  dplyr::mutate(weight=round(weight,3))
june_aic<-flextable(june_aic)






result<-ng%>%
  dplyr::select(Species,component)%>%
  distinct()%>%
  arrange(component)
  

rs<-data.frame(NULL)
hold<-data.frame(NULL)
for (i in levels(ng$component)) {
  for (j in levels(ng$Species)) {
  temp<-arrange(ng,Species,component)
  mod<-lm(pct_conc~pct_growth,data=subset(temp, Species==j & component==i ))
  r<-summary(mod)[["r.squared"]]
  P<-summary(mod)$coefficients[2,4] 
  c<-cbind(data.frame(coef(summary(mod))),i,j)
  rs<-rbind(rs,c)
  rp<-cbind(r,P)
  hold<-rbind(hold,rp)
  
}
}
res_new<-cbind(result,hold)
res_new<-res_new%>%dplyr::rename("r_squared"=r)%>%dplyr::rename("p-value"=P)

ng_kabjune<-flextable(res_new)
#ng_kab<-kbl(res_new,align='c',table.attr = "style = \"color: black;\"")%>%
 # kable_classic(full_width = F, html_font = "Cambria")%>%
  #kable_styling(font_size = 20)


rs2<-rs%>%
  rename(P=4,Component=5,Species=6)%>%
  mutate(P=round(P,3))
r2<-flextable(rs2)
flextable(rs2) %>% save_as_docx( path = "S9.docx")






#---------CANOPY-------------#
ssnew_canopy<-NSC%>%
  dplyr::select(Year,Month,Date,Species,ID,Tissue,Tot.Sug)%>%
  dplyr::rename(conc=Tot.Sug)%>%
  mutate(component="Sugar")%>% # making data long for each component
  #dplyr::filter(Tissue!="bole" & Tissue!="root")
  dplyr::filter(Tissue!="bole" & Tissue!="root")

stnew_canopy<-NSC%>%
  dplyr::select(Year,Month,Date,Species,ID,Tissue,Starch)%>%
  dplyr::rename(conc=Starch)%>%
  mutate(component="Starch")%>%
  #dplyr::filter(Tissue!="bole" & Tissue!="root")
  dplyr::filter(Tissue!="bole" & Tissue!="root")

N_canopy<-NSC%>%
  dplyr::select(Year,Month,Date,Species,ID,Tissue,Tot.NSC)%>%
  dplyr::rename(conc=Tot.NSC)%>%
  mutate(component="NSC")%>%
  #dplyr::filter(Tissue!="bole" & Tissue!="root")
  dplyr::filter(Tissue!="bole" & Tissue!="root")

nsc_canopy<-rbind(N_canopy,ssnew_canopy,stnew_canopy)%>% # combine the long datasets
  drop_na()%>% # drop empty rows
  dplyr::group_by(ID,Date,component)%>%
  dplyr::mutate(avg_conc=mean(conc))%>% # average all tissue concentrations to get total component for each tree
  ungroup()%>%
  dplyr::group_by(ID,component)%>%
  dplyr::mutate(max=max(avg_conc))%>%
  ungroup()%>%
  dplyr::mutate(pct_conc=(avg_conc/max)*100)%>% # calculate the % of maximum by component
  dplyr::select(Year,Month,Species,ID,component,pct_conc)%>%
  distinct()%>%
  dplyr::mutate(Species=ifelse(Species=="JUMO","J. monosperma","P. edulis"))

# combine growth and NSC datasets
ngcanopy<-merge(g_new,nsc_canopy)%>%
  dplyr::mutate(pct_growth=ifelse(pct_growth==0,0.000001,pct_growth))
ngcanopy$Species<-as.factor(ngcanopy$Species)
ngcanopy$component<-as.factor(ngcanopy$component)

# find best fit model for CANOPY NSC 
pied<-ngcanopy%>%filter(Species=="P. edulis"&component=="Starch")%>%drop_na()
jumo<-ngcanopy%>%filter(Species=="J. monosperma"&component=="Starch")%>%drop_na()
### a. linear
stp<-lm(pied$pct_conc~pied$pct_growth)
summary(stp)
stj<-lm(jumo$pct_conc~jumo$pct_growth)
summary(stj)
### b. exponential
exp_pied<-lm(pied$pct_conc~exp(pied$pct_growth))
summary(exp_pied)
exp_jumo<-lm(jumo$pct_conc~exp(jumo$pct_growth))
summary(exp_jumo)
### c. polynomial
poly_pied<-lm(pied$pct_conc~poly((abs(pied$pct_growth)),2))
summary(poly_pied) # explains 20% of variation!
  # formula: y= 10.4 - 19.8x + 11.3x^2; significant
poly_jumo<-lm(jumo$pct_conc~poly((abs(jumo$pct_growth)),2))
summary(poly_jumo) # only explains about 1.3% of variation!
# formula: y= 8.23 + 3.315x + 3.928x^2 ; not significant but second term is close!
### d. logarithmic
log_pied<-lm(pied$pct_conc~log(abs(pied$pct_growth)))
summary(log_pied)
log_jumo<-lm(jumo$pct_conc~log(abs(jumo$pct_growth)))
summary(log_jumo)

pied_aic<-AICtab(stp,exp_pied,poly_pied,log_pied,base=TRUE,sort=TRUE,weights=TRUE) # polynomial  model is best
paic_canopy<-as.data.frame(pied_aic)%>%
  dplyr::mutate(Species="P. edulis")%>%
  dplyr::mutate(Model=c("Polynomial","Linear-Log","Linear","Negative Exponential"))%>%
  dplyr::select(Model,AIC,dAIC,df,weight,Species)

jumo_aic<-AICtab(stj,exp_jumo,poly_jumo,log_jumo,base=TRUE,sort=TRUE,weights=TRUE) # linear model is best
jaic_canopy<-as.data.frame(jumo_aic)%>%
  dplyr::mutate(Species="J. monosperma")%>%
  dplyr::mutate(Model=c("Linear","Negative Exponential","Linear-Log","Polynomial"))%>%
  dplyr::select(Model,AIC,dAIC,df,weight,Species)
aicstarch_canopy<-rbind(paic_canopy,jaic_canopy)%>%
  mutate(Variable="Starch")

# CHECK SUGAR
pied<-ngcanopy%>%filter(Species=="P. edulis"&component=="Sugar")%>%drop_na()
jumo<-ngcanopy%>%filter(Species=="J. monosperma"&component=="Sugar")%>%drop_na()
### a. linear
sup<-lm(pied$pct_conc~pied$pct_growth)
summary(sup)
suj<-lm(jumo$pct_conc~jumo$pct_growth)
summary(suj)
### b. exponential
exp_pied<-lm(pied$pct_conc~exp(pied$pct_growth))
summary(exp_pied)
exp_jumo<-lm(jumo$pct_conc~exp(jumo$pct_growth))
summary(exp_jumo)
### c. polynomial
poly_pied<-lm(pied$pct_conc~poly((abs(pied$pct_growth)),2))
summary(poly_pied) # explains 1.7% of variation
# formula: y= 8.76 -5.81x + 2.08x^2; only second term is significant
poly_jumo<-lm(jumo$pct_conc~poly((abs(jumo$pct_growth)),2))
summary(poly_jumo) # explains 5% of variation
# formula: y= 6.13 + 6.38x + 1.56x^2; only second term is significant
### d. logarithmic
log_pied<-lm(pied$pct_conc~log(abs(pied$pct_growth)))
summary(log_pied)
log_jumo<-lm(jumo$pct_conc~log(abs(jumo$pct_growth)))
summary(log_jumo)

pied_aic<-AICtab(sup,exp_pied,poly_pied,log_pied,base=TRUE,sort=TRUE,weights=TRUE) # negative exp  model is best
paic_canopy<-as.data.frame(pied_aic)%>%
  dplyr::mutate(Species="P. edulis")%>%
  dplyr::mutate(Model=c("Polynomial","Negative Exponential","Linear-Log","Linear"))%>%
  dplyr::select(Model,AIC,dAIC,df,weight,Species)

jumo_aic<-AICtab(suj,exp_jumo,poly_jumo,log_jumo,base=TRUE,sort=TRUE,weights=TRUE) # log model is best
jaic_canopy<-as.data.frame(jumo_aic)%>%
  dplyr::mutate(Species="J. monosperma")%>%
  dplyr::mutate(Model=c("Linear-Log","Polynomial","Linear","Negative Exponential"))%>%
  dplyr::select(Model,AIC,dAIC,df,weight,Species)
aicss_canopy<-rbind(paic_canopy,jaic_canopy)%>%
  mutate(Variable="Sugar")

canopy_aic<-rbind(aicstarch_canopy,aicss_canopy)%>%
  dplyr::select(Species,Variable,Model,dAIC,df,weight)%>%
  dplyr::mutate(weight=round(weight,3))
canopy_aic<-flextable(canopy_aic)

result_canopy<-ngcanopy%>%
  dplyr::select(Species,component)%>%
  distinct()%>%
  arrange(component)

p<-ngcanopy%>%
  filter(Species=="P. edulis",component=="NSC")
pnsc<-lm(pct_conc~log(pct_growth),data=p)

j<-ngcanopy%>%
  filter(Species=="J. monosperma",component=="NSC")
jnsc<-lm(pct_conc~log(pct_growth),data=j)
  

result<-data.frame(NULL)
hold<-data.frame(NULL)
for (i in levels(ngcanopy$component)) {
  for (j in levels(ngcanopy$Species)) {
  temp<-arrange(ngcanopy,Species,component)
  mod<-lm(pct_conc~pct_growth,data=subset(temp, Species==j & component==i ))
  r<-summary(mod)[["r.squared"]]
  P<-summary(mod)$coefficients[2,4] 
  c<-cbind(data.frame(coef(summary(mod))),i,j)
  result<-rbind(result,c)
  rp<-cbind(r,P)
  hold<-rbind(hold,rp)
  
}
}
res_new<-cbind(result_canopy,hold)
res_new<-res_new%>%dplyr::rename("r_squared"=r)%>%dplyr::rename("p-value"=P)

ngcanopy_kab<-flextable(res_new)
#ng_kab<-kbl(res_new,align='c',table.attr = "style = \"color: black;\"")%>%
 # kable_classic(full_width = F, html_font = "Cambria")%>%
  #kable_styling(font_size = 20)

result2<-result%>%
  rename(P=4,Component=5,Species=6)%>%
  mutate(P=round(P,3))
r2<-flextable(result2)
flextable(result2) %>% save_as_docx( path = "S7.docx")






# plot growth and nsc
jgn_plot<-ggplot(subset(ng,Species=="J. monosperma"),aes(pct_growth,pct_conc,color=component)) +
  geom_point(alpha=0.5) + 
  geom_smooth(data=subset(ng,Species=="J. monosperma" & component=="Sugar"), method="lm", formula=y~log(x), se=TRUE) +
  geom_smooth(data=subset(ng,Species=="J. monosperma"&component=="Starch"),method="lm",formula=y~exp(-x),se=TRUE) + 
  ylab("% of Maximum") + xlab("% of Maximum Growth") + scale_y_continuous(limits = c(0,115),breaks=c(0,10,20,30,40,50,60,70,80,90,100)) +
  scale_x_continuous(guide = guide_axis(check.overlap = TRUE)) +  scale_color_manual(values=c("Starch"="#FDEA72","Sugar"="#9BE6EF")) + 
  theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  
  theme(text = element_text(
        size = 15, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
  theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + labs(title="J. monosperma") +
  annotate("text",x=40,y=110,label="Sugar: y = 54.4 - 1.74log(x)*")+
  annotate("text",x=40,y=105,label="Starch: y = 56.1 - 1.09e-42x (n.s.)")+ 
  theme(legend.title = element_blank())

#+ geom_text(mapping=aes(x=Inf,y=Inf,label=jlab), color="black",size=3) + geom_text(mapping=aes(x=85,y=97,label="p = 0.64, 0.54, 0.80"), color="black",size=3)


pgn_plot<-ggplot(subset(ng,Species=="P. edulis"),aes(pct_growth,pct_conc,color=component)) +
  geom_point(alpha=0.5) +
  geom_smooth(data=subset(ng, Species=="P. edulis" & component=="Sugar"), method="lm", se=TRUE) +
  geom_smooth(data=subset(ng,Species=="P. edulis"&component=="Starch"),method="lm",formula=y~poly(x,2),se=TRUE) + 
  ylab("% of Maximum") + 
  xlab("% of Maximum Growth") + 
  scale_y_continuous(limits = c(0,115),breaks=c(0,10,20,30,40,50,60,70,80,90,100)) +
  scale_x_continuous(guide = guide_axis(check.overlap = TRUE)) +
scale_color_manual(values=c("Starch"="#FDEA72","Sugar"="#9BE6EF")) + 
  theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  
  theme(text = element_text(
        size = 15, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + 
  labs(title="P. edulis") +
  annotate("text",x=40,y=110,label="Sugar: y = 86.7 - 0.26x (n.s.)")+
  annotate("text",x=40,y=105,label="Starch: y = 62.12 + 93.85x* - 68.78x²")+ 
  theme(legend.title = element_blank())

#+ geom_text(mapping=aes(x=80,y=100,label="R = 0.32, 0.45, 0.003"), color="black",size=3) + geom_text(mapping=aes(x=85,y=97,label="p = <0.01, <0.01, 0.75"), color="black",size=3)





# plot growth and nsc
jgn_plotcanopy<-ggplot(subset(ngcanopy,Species=="J. monosperma"),aes(pct_growth,pct_conc,color=component)) +
  geom_point(alpha=0.5) + 
  geom_smooth(data=subset(ngcanopy,Species=="J. monosperma" & component=="NSC"), method="lm", formula=y~log(x), se=TRUE) +
  geom_smooth(data=subset(ngcanopy,Species=="J. monosperma" & component=="Sugar"), method="lm", formula=y~log(x), se=TRUE) +
  geom_smooth(data=subset(ngcanopy,Species=="J. monosperma"&component=="Starch"),method="lm",se=TRUE) +
  ylab("% of Maximum") + xlab("% of Maximum Growth") + scale_y_continuous(limits = c(0,115),breaks=c(0,10,20,30,40,50,60,70,80,90,100)) +
  scale_x_continuous(guide = guide_axis(check.overlap = TRUE)) +  scale_color_manual(values=c("Starch"="#FDEA72","Sugar"="#9BE6EF","NSC"="grey"))  + 
  theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  
  theme(text = element_text(
        size = 20, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
  theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + labs(title="J. monosperma") +
  annotate("text",x=42,y=115,size=5,label="Sugar: y = 48.72 - 1.14log(x)*")+
  annotate("text",x=40,y=109,size=5,label="Starch: y = 32.50 + 0.07x")+ 
  annotate("text",x=50,y=103,size=5,label="NSC: y = 46.42 - log(0.58)x (n.s.)")+ 
  theme(legend.title = element_blank())

#+ geom_text(mapping=aes(x=Inf,y=Inf,label=jlab), color="black",size=3) + geom_text(mapping=aes(x=85,y=97,label="p = 0.64, 0.54, 0.80"), color="black",size=3)


pgn_plotcanopy<-ggplot(subset(ngcanopy,Species=="P. edulis"),aes(pct_growth,pct_conc,color=component)) +
  geom_point(alpha=0.5) +
  geom_smooth(data=subset(ngcanopy, Species=="P. edulis" & component=="NSC"), method="lm",formula=y~exp(-x), se=TRUE) +
  geom_smooth(data=subset(ngcanopy, Species=="P. edulis" & component=="Sugar"), method="lm",formula=y~exp(-x), se=TRUE) +
  geom_smooth(data=subset(ngcanopy,Species=="P. edulis"&component=="Starch"),method="lm",formula=y~poly(x,2),se=TRUE) + 
  ylab("% of Maximum") + 
  xlab("% of Maximum Growth") + 
  scale_y_continuous(limits = c(0,115),breaks=c(0,10,20,30,40,50,60,70,80,90,100)) +
  scale_x_continuous(guide = guide_axis(check.overlap = TRUE)) +
scale_color_manual(values=c("Starch"="#FDEA72","Sugar"="#9BE6EF","NSC"="grey"))  + 
  theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  
  theme(text = element_text(
        size = 20, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + 
  labs(title="P. edulis") +
  annotate("text",x=40,y=115,size=5,label="Sugar: y = 67.41 - 1.032e-42x")+
  annotate("text",x=48,y=109,size=5,label="Starch: y = 37.38 + 117.71x* - 39.82x²")+
  annotate("text",x=40,y=103,size=5,label="NSC: y = 54.95 + log(1.59x)*")+ 
  theme(legend.title = element_blank())




# let's do some within tissue figure making
sugar<-NSC%>%
  dplyr::select(Year,Month,Date,Species,ID,Tissue,Tot.Sug)%>%
  dplyr::rename(conc=Tot.Sug)%>%
  mutate(component="Sugar")

starch<-NSC%>%
  dplyr::select(Year,Month,Date,Species,ID,Tissue,Starch)%>%
  dplyr::rename(conc=Starch)%>%
  mutate(component="Starch")

total<-NSC%>%
  dplyr::select(Year,Month,Date,Species,ID,Tissue,Tot.NSC)%>%
  dplyr::rename(conc=Tot.NSC)%>%
  mutate(component="NSC")

nsc<-rbind(sugar,starch,total)%>% # combine the long datasets
  drop_na()%>% # drop empty rows
  dplyr::group_by(ID,Date,component,Tissue)%>%
  dplyr::mutate(avg_conc=mean(conc))%>% # average all tissue concentrations to get total component for each tree
  ungroup()%>%
  dplyr::group_by(ID,component,Tissue)%>%
  dplyr::mutate(max=max(avg_conc))%>%
  ungroup()%>%
  dplyr::mutate(pct_conc=(avg_conc/max)*100)%>% # calculate the % of maximum by component
  dplyr::select(Year,Month,Species,ID,Tissue,component,pct_conc)%>%
  distinct()%>%
  dplyr::mutate(Species=ifelse(Species=="JUMO","J. monosperma","P. edulis"))

# combine growth and NSC datasets
ng<-merge(g_new,nsc)%>%
  dplyr::mutate(pct_growth=ifelse(pct_growth==0,0.000001,pct_growth))
ng$Species<-as.factor(ng$Species)
ng$component<-as.factor(ng$component)
ng$Tissue<-as.factor(ng$Tissue)

# let's do the tissue-specific regressions now

tissue_nsc<-ggplot(subset(ng,component=="NSC"),aes(pct_growth,pct_conc)) + 
  geom_point() + 
  geom_smooth(method="lm") + 
  facet_wrap(Species~Tissue, scale="free") + theme_minimal()+ 
  ggtitle("Total NSC") +
  labs(x="% of Maximum Growth",y="% of Maximum NSC")
#ggsave("nsc_growth.png",tissue_nsc,height=10,width=10,bg="white")

# do Tissue~NSC regressions really quick
slope_nsc<-ng %>%
  filter(component=="NSC")%>%
  group_by(Species,Tissue) %>%
  do(data.frame(slope = coef(lm(pct_conc~pct_growth,data=.))[2],error=summary(lm(pct_conc~pct_growth,data=.))$coefficients[2, 2],sig=summary(lm(pct_conc~pct_growth,data=.))$coefficients[2, 4]))%>%
  mutate(Organ="NSC")


# individual tissues tell a cool but pretty simple story. 
tissue_ss<-ggplot(subset(ng,component=="Sugar"),aes(pct_growth,pct_conc)) + 
  geom_point() + 
  geom_smooth(method="lm") + 
  facet_wrap(Species~Tissue, scale="free") + theme_minimal()+ 
  ggtitle("Sugar")+
  labs(x="% of Maximum Growth",y="% of Maximum Sugar")
#ggsave("sugar_growth.png",tissue_ss,height=10,width=10,bg="white")

slope_ss<-ng %>%
  filter(component=="Sugar")%>%
  group_by(Species,Tissue) %>%
  do(data.frame(slope = coef(lm(pct_conc~pct_growth,data=.))[2],error=summary(lm(pct_conc~pct_growth,data=.))$coefficients[2, 2],sig=summary(lm(pct_conc~pct_growth,data=.))$coefficients[2, 4]))%>%
  mutate(Organ="Sugar")

tissue_st<-ggplot(subset(ng,component=="Starch"),aes(pct_growth,pct_conc)) + 
  geom_point() + 
  geom_smooth(method="lm") + 
  facet_wrap(Species~Tissue, scale="free") + theme_minimal()+ 
  ggtitle("Starch")+
  labs(x="% of Maximum Growth",y="% of Maximum Sugar")
ggsave("starch_growth.png",tissue_st,height=10,width=10,bg="white")

slope_st<-ng %>%
  filter(component=="Starch")%>%
  group_by(Species,Tissue) %>%
  do(data.frame(slope = coef(lm(pct_conc~pct_growth,data=.))[2],error=summary(lm(pct_conc~pct_growth,data=.))$coefficients[2, 2],sig=summary(lm(pct_conc~pct_growth,data=.))$coefficients[2, 4]))%>%
  mutate(Organ="Starch")

slopes<-rbind(slope_nsc,slope_ss,slope_st)%>%
  mutate(sig2=ifelse(sig<0.05,"*",""),slope=-1*slope)
slopes$Tissue<-as.factor(slopes$Tissue)
order<-c("root","bole","twig","leaf")


count<-ng%>%
  group_by(Tissue,Species,component)%>%
  count(Species)%>%
  mutate(n=paste("n=",n,sep=""))%>%
  filter(component=="Sugar")%>%
  mutate(slope=-.2)%>%
  rename(Organ=component)



# let's make a slope plot
slope_plot2<-ggplot(slopes,aes(x=slope,Tissue,fill=Organ)) + scale_y_discrete(limits = order) + scale_x_continuous(labels = c(-1,-0.5,0,0.5,1), breaks = c(-1,-0.5,0,0.5,1)) +
  geom_bar(stat="summary",position = "dodge",colour="white") + geom_vline(aes(xintercept=0))+
  geom_errorbar(stat="identity",aes(xmin=slope-error, xmax=slope+error),width=.0,position=position_dodge(.9)) + geom_text(data=count,aes(label=n), position=position_dodge(width=0.9))  +  xlab("Slope Estimate")+ facet_wrap(~Species,scales="free_x")  +  geom_text(data=slopes,aes(x=ifelse(slope>0,slope+.3,slope-.3),y=Tissue,label=sig2),stat="identity",position=position_dodge(1)) +
  scale_fill_manual(values=c("Starch"="#FDEA72","Sugar"="#9BE6EF","NSC"="grey")) + 
  theme(axis.text.x = element_text(angle = 0,size=20),axis.text.y=element_text(size=20),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) +  theme(text = element_text(
        size = 20, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     ), legend.position="none"
   ) 
  

```

```{r Ypd, include=FALSE,results='asis'}
longterm<-read.csv("longterm_PWP.csv")%>%
  dplyr::mutate(Species=ifelse(Species=="JUMO","J. monosperma","P. edulis"))
longterm$Date<-as.Date(longterm$Date)
#longterm$Date<-as.numeric(longterm$Date)
longterm$Study<-"MDB"
library(lubridate)
longterm$Month<-month(as.Date(longterm$Date, format="%Y/%m/%d"))
longterm2<-longterm%>%
  select(Year,Month,Species,ID,Ypd,Study)
wp$Study<-"SUMO"
wpnew<-wp%>%
  select(Year,Month,Species,ID,Ypd,Study)%>%
  mutate(Species=ifelse(Species=="JUMO","J. monosperma","P. edulis"))
wp_lg<-rbind(longterm2,wpnew)
wp_lg<-wp_lg%>%
  unite(Date,Month,Year,sep="/1/",remove=FALSE)
wp_lg$Date<-as.Date(wp_lg$Date, format="%m/%d/%Y")
wp_lg<-wp_lg%>%
  mutate(A=ifelse(Species=="J. monosperma", -6.75, -3.09))%>%
  mutate(G=ifelse(Species=="J. monosperma", -6.86, -3.27))%>%
# let's apply the A and G vs Ypd formula to this data and instead show how percentages vary through time
  mutate(A_pred=ifelse(Species=="J. monosperma",58.6-33.3*log(abs(Ypd)),63.7-51.8*log(abs(Ypd))))%>%
  mutate(G_pred=ifelse(Species=="J. monosperma",51.7-26.8*log(abs(Ypd)),61.4-51.7*log(abs(Ypd))))


samples<-wp_lg%>%
  filter(Study=="MDB")%>%
  group_by(Species,Month,Year,Study)%>%
  mutate(n=n_distinct(ID))%>%
  ungroup()%>%
  dplyr::select(Species,Month,Year,n)%>%
  distinct(Species,Year,n)

p<-samples%>%
  filter(Species=="P. edulis")

j<-samples%>%
  filter(Species=="J. monosperma")


longterm_Ypd_OLD<-ggplot(wp_lg,aes(Date,Ypd,color=Species,group=ID)) + geom_line(size=0.2) + scale_x_date(date_breaks = "1 year",date_labels = "%Y") +
facet_grid(Species~Study,scales="free",space="free_x",switch="y")  + theme(strip.text.x = element_text(
        size = 12, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   )+ xlab("") + scale_color_manual(values=wes_palette("GrandBudapest1",n=2,type='discrete'))+ guides(color="none") + theme(axis.text.x = element_text(angle = 90, vjust=0.5,size=11),axis.text.y = element_text(size=12)) + theme(strip.text = element_text(face = "italic")) + labs(y=expression(psi[pd]~(MPa)))+ geom_hline(aes(yintercept=A),linetype="solid") + geom_hline(aes(yintercept=G),linetype="dashed") 




longterm_Ypd_SUMO<-ggplot(subset(wp_lg,Study=="SUMO"),aes(Date,A_pred,group=ID)) + geom_line(color="#5b859e",size=0.2) + geom_line(aes(y=G_pred),color="#df8d71",size=0.2,alpha=0.5) + scale_x_date(date_breaks = "1 year",date_labels = "%Y") +
facet_grid(~Species,scales="free",space="free_x",switch="y")  + theme(strip.text.x = element_text(
        size = 12, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   )+ xlab("") + scale_color_manual(breaks=c("Growth","Photosynthesis"), values=c("Photosynthesis"="#5b859e","Growth"="#df8d71"))+ guides(color="none") + theme(axis.text.x = element_text(angle = 90, vjust=0.5,size=11),axis.text.y = element_text(size=12)) + theme(strip.text = element_text(face = "italic")) + labs(y="% of Maximum")+  geom_hline(aes(yintercept=0),linetype="solid") 

longterm_Ypd_MDB<-ggplot(subset(wp_lg,Study=="MDB"),aes(Date,A_pred,group=ID)) + geom_line(color="#5b859e",size=0.2) + geom_line(aes(y=G_pred),color="#df8d71",size=0.2,alpha=0.5) + scale_x_date(date_breaks = "1 year",date_labels = "%Y") +
facet_grid(~Species,scales="free",space="free_x",switch="y")  + theme(strip.text.x = element_text(
        size = 12, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   )+ xlab("") + scale_color_manual(breaks=c("Growth","Photosynthesis"), values=c("Photosynthesis"="#5b859e","Growth"="#df8d71"))+ guides(color="none") + theme(axis.text.x = element_text(angle = 90, vjust=0.5,size=11),axis.text.y = element_text(size=12)) + theme(strip.text = element_text(face = "italic")) + labs(y="% of Maximum")+  geom_hline(aes(yintercept=0),linetype="solid") 

library(grid)
lt = ggplot_gtable(ggplot_build(longterm_Ypd))
library(gtable)
gtable_show_layout(lt)
lt$widths[8] = 1.5*lt$widths[8]
lt$widths[6] = 0.7*lt$widths[6]
grid.draw(lt)
```

```{r pct Days in Status, include=FALSE,results='asis'}

days <- read.csv("days.csv")
days$Date<-as.Date(days$Date) # make sure Dates are read as Dates
dates<-WP%>%
  dplyr::select(Year,Date)%>%
  mutate(Month = substr(as.character(Date), 6, 7)) # create a dates DF for merging later
dates$Date<-as.Date(dates$Date) # make sure Dates are read as Dates
DOS<-merge(dates,days)%>%
  dplyr::select(-Date) # combine the dates and days DFs so we know what dates are what day of study
wp$Year<-as.numeric(wp$Year) # again making sure variables are being read properly
wp$Month<-as.numeric(wp$Month) # again making sure variables are being read properly
DOS$Year<-as.numeric(DOS$Year) # again making sure variables are being read properly
DOS$Month<-as.numeric(DOS$Month) # again making sure variables are being read properly
water_potential<-merge(DOS,wp)%>%distinct()
  #dplyr::mutate(Species=ifelse(Species=="JUMO","J. monosperma","P. edulis"))# combine day of study with water potential, so we can classify what DOS trees were at a given psi


# calculate the % of the study at different pct_growth intervals for SUMO
growth_int$pred_Ypd<-as.numeric(growth_int$pred_Ypd) # make sure psi values are read as numeric
water_potential<-water_potential%>%
  mutate(ID=ifelse(ID=="nate",1000,ID)) # give JNATE a numeric ID
water_potential$ID<-as.numeric(water_potential$ID) # set all IDs to numeric
g_days<-merge(water_potential,growth_int)%>% # combine growth interval thresholds w/ psi data
  #dplyr::filter(ID!="nate")%>%
  #dplyr::filter(ID!=9)%>%
  dplyr::mutate(Status=ifelse(Ypd<=pred_Ypd,interval,NA))%>% # determine when trees are below the growth threshold
  drop_na()%>%
  dplyr::arrange(ID,DOS)%>% # order trees by DOS
  dplyr::group_by(ID,DOS)%>%
  dplyr::mutate(Status=min(interval))%>% # select only the lowest threshold that trees fall below
  distinct(ID,DOS,.keep_all = TRUE)%>%
  dplyr::group_by(ID) %>%
  dplyr::mutate(days_status= DOS - lag(DOS, default = DOS[1]))%>% # find how many days between measurement periods
  dplyr::arrange(ID, DOS) %>%
  transform(days_status = lead(days_status))%>% # move days column forward one
  drop_na()%>%
  dplyr::group_by(ID, Status) %>%
  dplyr::mutate(total_days_status = sum(days_status)) %>% # find total number of days below each threshold
  arrange(ID,Status,DOS)%>%
  group_by(ID,Status)%>%
  dplyr::select(Species, Year, Month, ID, DOS, Status, total_days_status, Ypd) %>% 
  distinct(ID,total_days_status, .keep_all = TRUE)%>%
  dplyr::mutate(pct_study=total_days_status/1625)%>% # define DOS as percentage of total days
  distinct(Year,ID,Status,total_days_status, .keep_all = TRUE)%>%
  dplyr::group_by(Species,Status)%>%
  dplyr::mutate(avg_pct=mean(pct_study)*100)%>% # find species level median value, since data is not normal
  dplyr::mutate(sem_pct=sem(pct_study))%>% # find standard error
  dplyr::select(Species,Status,pct_study,avg_pct,sem_pct)%>%
  dplyr::mutate(Variable="Growth")%>% # create variable column
  mutate(Site="SUMO")




#gstat_plot<-ggplot(g_days,aes(Status,avg_pct,color=Status)) + geom_point() + facet_wrap(~Species)

# calculate % of study at pct_growth intervals for MDB
days_recon<-read.csv("days_reconstruction.csv")
days_recon$Date<-as.Date(days_recon$Date,"%Y-%m-%d")
longterm<-read.csv("longterm_PWP.csv")%>%
  dplyr::mutate(Species=ifelse(Species=="JUMO","J. monosperma","P. edulis"))
longterm$Date<-as.Date(longterm$Date)

lg<-merge(longterm,days_recon)

lg_days<-merge(lg,growth_int)%>% # combine growth interval thresholds w/ psi data
  #dplyr::filter(ID!="nate")%>%
  #dplyr::filter(ID!=9)%>%
  dplyr::mutate(Status=ifelse(Ypd<=pred_Ypd,interval,NA))%>% # determine when trees are below the growth threshold
  drop_na()%>%
  dplyr::arrange(ID,DOS)%>% # order trees by DOS
  dplyr::group_by(ID,DOS)%>%
  dplyr::mutate(Status=min(interval))%>% # select only the lowest threshold that trees fall below
  distinct(ID,DOS,.keep_all = TRUE)%>%
  dplyr::group_by(ID) %>%
  dplyr::mutate(days_status= DOS - lag(DOS, default = DOS[1]))%>% # find how many days between measurement periods
  dplyr::arrange(ID, DOS) %>%
  transform(days_status = lead(days_status))%>% # move days column forward one
  drop_na()%>%
  dplyr::group_by(ID, Status) %>%
  dplyr::mutate(total_days_status = sum(days_status)) %>% # find total number of days below each threshold
  arrange(ID,Status,DOS)%>%
  group_by(ID,Status)%>%
  dplyr::select(Species, Year, Date, ID, DOS, Status, total_days_status, Ypd) %>% 
  distinct(ID,total_days_status, .keep_all = TRUE)%>%
  dplyr::mutate(pct_study=total_days_status/8932)%>% # define DOS as percentage of total days
  distinct(Year,ID,Status,total_days_status, .keep_all = TRUE)%>%
  dplyr::group_by(Species,Status)%>%
  dplyr::mutate(avg_pct=mean(pct_study)*100)%>% # find species level median value, since data is not normal
  dplyr::mutate(sem_pct=sem(pct_study))%>% # find standard error
  dplyr::select(Species,Status,pct_study,avg_pct,sem_pct)%>%
  dplyr::mutate(Variable="Growth")%>% # create variable column
  mutate(Site="MDB")


# NOW REPEAT THE ABOVE FOR PHOTOSYNTHESIS
# first for SUMO

photo_int$pred_Ypd<-as.numeric(photo_int$pred_Ypd)
p_days<-merge(water_potential,photo_int)%>%
  #dplyr::filter(ID!="nate")%>%
  #dplyr::filter(ID!=9)%>%
  dplyr::mutate(Status=ifelse(Ypd<=pred_Ypd,interval,NA))%>%
  drop_na()%>%
  dplyr::arrange(ID,DOS)%>%
  dplyr::group_by(ID,DOS)%>%
  dplyr::mutate(Status=min(interval))%>%
  distinct(ID,DOS,.keep_all = TRUE)%>%
  dplyr::group_by(ID) %>%
  dplyr::mutate(days_status= DOS - lag(DOS, default = DOS[1]))%>%
  dplyr::arrange(ID, DOS) %>%
  transform(days_status = lead(days_status))%>%
  drop_na()%>%
  dplyr::group_by(ID, Status) %>%
  dplyr::mutate(total_days_status = sum(days_status)) %>%
  arrange(ID,Status,DOS)%>%
  group_by(ID,Status)%>%
  dplyr::select(Species, Year, Month, ID, DOS, Status, total_days_status, Ypd) %>%
  distinct(ID,total_days_status, .keep_all = TRUE)%>%
  dplyr::mutate(pct_study=total_days_status/1625)%>%
 distinct(Year,ID,Status,total_days_status, .keep_all = TRUE)%>%
  dplyr::group_by(Species,Status)%>%
  dplyr::mutate(avg_pct=mean(pct_study)*100)%>%
  dplyr::mutate(sem_pct=sem(pct_study))%>%
  dplyr::select(Species,Status,pct_study,avg_pct,sem_pct)%>%
  dplyr::mutate(Variable="Photosynthesis")%>% # create variable column
  mutate(Site="SUMO")

# again for MDB
photo_int$pred_Ypd<-as.numeric(photo_int$pred_Ypd)
lp_days<-merge(lg,photo_int)%>%
  #dplyr::filter(ID!="nate")%>%
  #dplyr::filter(ID!=9)%>%
  dplyr::mutate(Status=ifelse(Ypd<=pred_Ypd,interval,NA))%>%
  drop_na()%>%
  dplyr::arrange(ID,DOS)%>%
  dplyr::group_by(ID,DOS)%>%
  dplyr::mutate(Status=min(interval))%>%
  distinct(ID,DOS,.keep_all = TRUE)%>%
  dplyr::group_by(ID) %>%
  dplyr::mutate(days_status= DOS - lag(DOS, default = DOS[1]))%>%
  dplyr::arrange(ID, DOS) %>%
  transform(days_status = lead(days_status))%>%
  drop_na()%>%
  dplyr::group_by(ID, Status) %>%
  dplyr::mutate(total_days_status = sum(days_status)) %>%
  arrange(ID,Status,DOS)%>%
  group_by(ID,Status)%>%
  dplyr::select(Species, Year, Date, ID, DOS, Status, total_days_status, Ypd) %>%
  distinct(ID,total_days_status, .keep_all = TRUE)%>%
  dplyr::mutate(pct_study=total_days_status/8932)%>%
  distinct(Year,ID,Status,total_days_status, .keep_all = TRUE)%>%
  dplyr::group_by(Species,Status)%>%
  dplyr::mutate(avg_pct=mean(pct_study)*100)%>% # find species level median value, since data is not normal
  dplyr::mutate(sem_pct=sem(pct_study))%>%
  dplyr::select(Species,Status,pct_study,avg_pct,sem_pct)%>%
  dplyr::mutate(Variable="Photosynthesis")%>% # create variable column
  mutate(Site="MDB")

#pstat_plot<-ggplot(p_days,aes(Status,avg_pct,color=Status)) + geom_point() + facet_wrap(~Species)
  

# combine the growth and photosynthesis limitation datasets
pg_limit<-rbind(g_days,p_days,lg_days,lp_days)
ksdf<-read.csv("ksdf.csv")%>%
  dplyr::select(-X)
pg_limit<-merge(pg_limit,ksdf)
 # mutate(Range=ifelse(avg_pct<=10, "0-10",ifelse(avg_pct<=25,"10-25",ifelse(avg_pct<=50, "25-50",ifelse(avg_pct>50,"50+",NA)))))
pg_limit$Status<-as.numeric(pg_limit$Status)
pg_limit$SV<-paste(pg_limit$Species,pg_limit$Variable,sep=", ")
pg_limit<-pg_limit%>%distinct()


##### line and point plot for SUMO

pg_lin<-ggplot(pg_limit,aes(Status,avg_pct,color=SV,shape=SV,group=SV)) + geom_text(data=subset(pg_limit,Species=="J. monosperma"),aes(x=39,y=22,label=paste(Species,round(P.value,3),sep=": p = ")),check_overlap = TRUE,color="black")+ geom_text(data=subset(pg_limit,Species=="P. edulis"),aes(x=39,y=20,label=paste(Species,round(P.value,3),sep=": p = ")),check_overlap = TRUE,color="black") + geom_point(size=3) + geom_line() + xlab("% of Maximum") + ylab("Average % of Time") + geom_errorbar(stat="identity",aes(ymin=avg_pct-sem_pct, ymax=avg_pct+sem_pct), width=.0,position=position_dodge(.9)) + scale_x_continuous(guide = guide_axis(check.overlap = TRUE),breaks=c(0,10,20,30,40,50,60,70,80,90,100))  +  scale_color_manual(name="Species & Variable",labels=c("J. monosperma, Growth","J. monosperma, Photosynthesis","P. edulis, Growth","P. edulis, Photosynthesis"),values=met.brewer("Isfahan2",4,type='discrete')) + scale_shape_manual(name="Species & Variable",labels=c("J. monosperma, Growth","J. monosperma, Photosynthesis","P. edulis, Growth","P. edulis, Photosynthesis"),values=c(21,24,21,24)) + theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(text = element_text(
        size = 12, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   )  + facet_wrap(~Site,scale="fixed") + theme(legend.title = element_blank())

test<-ggplot(pg_limit,aes(Status,med_pct,color=Species)) + geom_point() + facet_wrap(Site~Variable) 



```

```{r pct days Statistics, include=FALSE,results='asis'}

# essentially we have distributions of data
# I want to test if, for each species, growth and photosynthesis follow the same distribution
#psumo<-pg_limit%>%filter(Species=="P. edulis" & Site=="SUMO")
#jsumo<-pg_limit%>%filter(Species=="J. monosperma"& Site=="SUMO")
#pmdb<-pg_limit%>%filter(Species=="P. edulis" & Site=="MDB")
#jmdb<-pg_limit%>%filter(Species=="J. monosperma"& Site=="MDB")

#jks<-ks.test(jsumo$pct_study[jsumo$Variable=="Growth"],jsumo$pct_study[jsumo$Variable=="Photosynthesis"])
# p = 0.068 not significantly different at SUMO  but very close!!
#pks<-ks.test(psumo$pct_study[psumo$Variable=="Growth"],psumo$pct_study[psumo$Variable=="Photosynthesis"])
# p = 0.798 not significantly different at SUMO
#jksmdb<-ks.test(jmdb$pct_study[jmdb$Variable=="Growth"],jmdb$pct_study[jmdb$Variable=="Photosynthesis"])
# p = 0.86 definitely not significantly different at MDB
#pksmdb<-ks.test(pmdb$pct_study[pmdb$Variable=="Growth"],pmdb$pct_study[pmdb$Variable=="Photosynthesis"])
# p = 0.83 not significantly different at MDB

#ks_df<-NULL%>%
  #as.data.frame()%>%
  #rbind(jks[["statistic"]],pks[["statistic"]],jksmdb[["statistic"]],pksmdb[["statistic"]])%>%
  #cbind(rbind(jks[["p.value"]],pks[["p.value"]],jksmdb[["p.value"]],pksmdb[["p.value"]]))%>%
  #cbind(c("J. monosperma","P. edulis","J. monosperma","P. edulis"))%>%
  #cbind(c("SUMO","SUMO","MDB","MDB"))%>%
  #dplyr::rename(D=1,"P-value"=2,Species=3,Site=4)
#write.csv(ks_df,"ksdf.csv")
ksdf<-read.csv("ksdf.csv")%>%
  dplyr::select(-X)
ks<-flextable(ksdf) %>% set_caption("Kolmogorov-Smirnov Test Results")

```

``` {r MV, include=FALSE,results='asis'}
# carbon dynamics are coupled, so try PCA 
############# let's try this PCA thing again ################
photo<-wp_photo%>%
  dplyr::select(Species,Year,Month,ID,pct_photo,Ypd)%>%
  dplyr::mutate(Ypd=abs(Ypd))
photo$Month<-gsub("0","",photo$Month)
photo$Month<-as.numeric(photo$Month)
new_growth<-gw_spp%>%
  dplyr::select(Species,Year,Month,ID,pct_growth)
new_growth$Month<-gsub("0","",new_growth$Month)
new_growth$Month<-as.numeric(new_growth$Month)
st<-wp_starch%>%
  ungroup()%>%
  dplyr::select(Species,Year,Month,ID,avg_pct)%>%
  dplyr::rename(Starch=avg_pct)%>%
  ungroup()
su<-wp_sugar%>%
  ungroup()%>%
  dplyr::select(Species,Year,Month,ID,avg_pct)%>%
  dplyr::rename(Sugar=avg_pct)%>%
  ungroup()
NSC3<-merge(st,su)


NSC3<-canopy%>%
  dplyr::select()
pca_df1<-merge(NSC3,photo)%>%
  distinct()
pca_df<-merge(pca_df1,new_growth)%>%
  distinct()%>%
  dplyr::rename("\u03A8 (predawn)"=Ypd,Photosynthesis=pct_photo,Growth=pct_growth)

theta1 <- acos( sum(pca_df$Growth*pca_df$Photosynthesis) / ( sqrt(sum(pca_df$Growth * pca_df$Growth)) * sqrt(sum(pca_df$Photosynthesis * pca_df$Photosynthesis)) ) ) # angle is 0.89. functionally orthogonal!

theta2 <- acos( sum(pca_df$Growth*pca_df$Starch) / ( sqrt(sum(pca_df$Growth * pca_df$Growth)) * sqrt(sum(pca_df$Starch * pca_df$Starch)) ) ) # angle is 0.89. functionally orthogonal!

theta3 <- acos( sum(pca_df$Photosynthesis*pca_df$Starch) / ( sqrt(sum(pca_df$Photosynthesis * pca_df$Photosynthesis)) * sqrt(sum(pca_df$Starch * pca_df$Starch)) ) ) # angle is 0.89. functionally orthogonal!


# run PCA
#pca_corr <- pca_df[5:10]*100
#scale.df<-scale(pca_corr)
#cov<-cov(scale.df)
#corr<-cov2cor(cov)
pca<-prcomp(pca_df[5:9],center=TRUE,scale.=TRUE)
summary(pca) # PC1 AND PC2 explain 85% of variance
pca
pca_sum<-unclass(summary(pca))$importance
pca_sum<-as.data.frame(pca_sum)
pca_sum<-pca_sum%>%
  add_rownames()
pca_tab<-as.data.frame(pca$rotation)
pca_tab<-pca_tab%>%
  add_rownames()
pca_kab<-flextable(pca_tab)
#pca_kab<-kbl(pca_tab)%>%
 #  kable_classic() %>%
  # kable_styling(bootstrap_options = "striped", font_size = 20)
pca_imp<-flextable(pca_sum)
#pca_imp<-kbl(pca_sum)%>%
 #   kable_classic() %>%
  #  kable_styling(bootstrap_options = "striped", font_size = 20)
# MAIN TAKEAWAY FROM THE PAPER: HIGH RESILIENCE OF SEMI-ARID CONIFERS TO DROUGHT - growth and photosynthesis limitations are rare. An increase in drought intensity (i.e. experimental drought, climate change) increases the relative occurrence of limitations to growth and photosynthesis relative to their maximum (i.e. trees spend more time with reduced rates of A and G) but absolute limitation infrequently occurred. In the context of drought legacy effects, this suggests conifers in semi-arid ecosystems might be more resilient to climate change than previously expected.

# PC1 describes an axis with declining water potentials, more photosynthesis, and less NSC. This could be a water availability axis - photosynthesis tends toward levels of higher water availability while water potentials drop as water availaility drops. As a result NSC decreases and growth limitation processes beging.
# PC2 describes an axis where carbon storage increases under less negative water potentials, but only when growth increases. This is likely an axis that describes seasonal variation whereby carbon storage increases during phenological maximums (see figure S1) sugar starts to decline (increases in winter for freezing, etc.) and photosynthesis marginally increases. 

# I think the main takeaway from all of these analyses is that sink/source limitation have a minimal effect on NSC in these trees. Sink and source limitation happen at very similar water potentials and decline in tandem, making sink limitation alone quite rare. Source limitation was also quite infrequent at SUMO, reducing the opportunity to observe a significant drop in NSC. Overall, it appears that changes in carbon storage are overwhelmed by seasonal effects, with increases in NSC occurring with phenological timing (i.e. June growth and June NSC increase). The principal component that describes a drop in water potential (PC5) and a slight decline in NSC and starch explained less than 3% of the variation in the data. The only principal component that shows a drop in NSC with a drop in growth was PC6, where a negligible contribution of water potential was associated with a large drop in total NSC, but an increase in starch and sugar content. This suggests overall carbon limitation, but this process was not really observed in our data. 
library(ggbiplot)
#species<-c("P. edulis","J. monosperma")




# PCA 1: ALL VARIABLES


pca12_plot<-ggbiplot::ggbiplot(pca,ellipse=TRUE,var.axes = TRUE,varname.size=4,alpha=0.3) + ylab("PC2 (27.58%)") +  xlab("PC1 (47.15%)") + scale_x_continuous(guide = guide_axis(check.overlap = TRUE),limits=c(-3,3),breaks=c(-3,-2,-1,0,1,2,3)) + scale_y_continuous(guide = guide_axis(check.overlap = TRUE),limits=c(-2.5,2.5),breaks=c(-2.5,-2,-1,0,1,2,2.5)) + theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(text = element_text(
        size = 20, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + guides(fill=guide_legend(title="Species"))+ 
  theme(legend.title = element_blank()) + 
  annotate("text",x=-1.7,y=-1.3,label="High Photosynthesis", size=5,alpha=0.5) + 
  annotate("text",x=-1.7,y=-1.7,label="High Growth", size=5,alpha=0.5) +
  annotate("text",x=1.7,y=1.7,label="Co-limitation of Growth", size=5,alpha=0.5) + 
  annotate("text",x=1.7,y=1.3,label="& Photosynthesis", size=5,alpha=0.5) + 
  annotate("text",x=1.7,y=-1.3,label="Low Photosynthesis", size=5,alpha=0.5) + 
  annotate("text",x=1.7,y=-1.7,label="High Growth", size=5,alpha=0.5) +
  annotate("text",x=-1.7,y=1.7,label="High Photosynthesis", size=5,alpha=0.5) + 
  annotate("text",x=-1.7,y=1.3,label="Low Growth", size=5,alpha=0.5) + 
  geom_segment(aes(x=-Inf,xend=Inf,y=0,yend=0),linetype="dashed") +
  geom_segment(aes(x=0,xend=0,y=-Inf,yend=Inf),linetype="dashed") 

pc1<-pca_tab%>%
  dplyr::select(rowname,PC1)%>%
  dplyr::rename(Value=PC1)%>%
  dplyr::mutate(Variable="PC1")
pc2<-pca_tab%>%
  dplyr::select(rowname,PC2)%>%
  dplyr::rename(Value=PC2)%>%
  dplyr::mutate(Variable="PC2")
pc3<-pca_tab%>%
  dplyr::select(rowname,PC3)%>%
  dplyr::rename(Value=PC3)%>%
  dplyr::mutate(Variable="PC3")
pc4<-pca_tab%>%
  dplyr::select(rowname,PC4)%>%
  dplyr::rename(Value=PC4)%>%
  dplyr::mutate(Variable="PC4")
pc5<-pca_tab%>%
  dplyr::select(rowname,PC5)%>%
  dplyr::rename(Value=PC5)%>%
  dplyr::mutate(Variable="PC5")
pc<-rbind(pc1,pc2,pc3,pc4,pc5)


pca_heat<-ggplot(pc,aes(Variable,rowname)) + geom_tile(aes(fill=Value)) + geom_text(aes(label=round(Value,2))) + ylab("") +  xlab("Principal Component")  + theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(text = element_text(
        size = 20, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + guides(fill=guide_legend(title="Species"))+ 
  theme(legend.title = element_blank(),legend.text=element_text(size=12),
        plot.margin=unit(c(0.2,1,0.5,-0.5), "cm")) +
  scale_fill_gradientn(colours=hcl.colors(10,"Spectral"),guide="colourbar") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 10))






pc1<-pca_sum%>%
  dplyr::filter(rowname=="Proportion of Variance")%>%
  dplyr::select(rowname,PC1)%>%
  dplyr::rename(Value=PC1)%>%
  dplyr::mutate(Variable="PC1")
pc2<-pca_sum%>%
    dplyr::filter(rowname=="Proportion of Variance")%>%
  dplyr::select(rowname,PC2)%>%
  dplyr::rename(Value=PC2)%>%
  dplyr::mutate(Variable="PC2")
pc3<-pca_sum%>%
    dplyr::filter(rowname=="Proportion of Variance")%>%
  dplyr::select(rowname,PC3)%>%
  dplyr::rename(Value=PC3)%>%
  dplyr::mutate(Variable="PC3")
pc4<-pca_sum%>%
    dplyr::filter(rowname=="Proportion of Variance")%>%
  dplyr::select(rowname,PC4)%>%
  dplyr::rename(Value=PC4)%>%
  dplyr::mutate(Variable="PC4")
pc5<-pca_sum%>%
    dplyr::filter(rowname=="Proportion of Variance")%>%
  dplyr::select(rowname,PC5)%>%
  dplyr::rename(Value=PC5)%>%
  dplyr::mutate(Variable="PC5")
screepc<-rbind(pc1,pc2,pc3,pc4,pc5)
  
scree<-ggplot(screepc,aes(Variable,Value,group=rowname)) + 
  geom_bar(stat="identity",color="black",fill="white") + 
  xlab("") +
  ylab("% of Variance") + theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(text = element_text(
        size = 12, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + guides(fill=guide_legend(title="Species"))+ 
  theme(legend.title = element_blank(),
        axis.text.x=element_blank(),
        plot.margin=unit(c(1,1,-0.1,1), "cm"))




#########-------JUNE PCA---------###########
st<-june%>%
  dplyr::filter(Variable=="Starch")%>%
  dplyr::rename(Starch=pct_max)%>%
  ungroup()%>%
  dplyr::select(-Variable)
su<-june%>%
  dplyr::filter(Variable=="Sugar")%>%
  dplyr::rename(Sugar=pct_max)%>%
  ungroup()%>%
  dplyr::select(-Variable)
NSC3<-merge(st,su)
pca_df1<-merge(NSC3,photo)%>%
  distinct()
pca_df<-merge(pca_df1,new_growth)%>%
  distinct()%>%
  dplyr::rename("\u03A8 (predawn)"=Ypd,Photosynthesis=pct_photo,Growth=pct_growth)

theta1 <- acos( sum(pca_df$Growth*pca_df$Photosynthesis) / ( sqrt(sum(pca_df$Growth * pca_df$Growth)) * sqrt(sum(pca_df$Photosynthesis * pca_df$Photosynthesis)) ) ) # angle is 0.65 in June!


# run PCA
#pca_corr <- pca_df[5:10]*100
#scale.df<-scale(pca_corr)
#cov<-cov(scale.df)
#corr<-cov2cor(cov)
pca<-prcomp(pca_df[5:9],center=TRUE,scale.=TRUE)
summary(pca) # PC1 AND PC2 explain 85% of variance
pca
pca_sum<-unclass(summary(pca))$importance
pca_sum<-as.data.frame(pca_sum)
pca_sum<-pca_sum%>%
  add_rownames()
pca_tab<-as.data.frame(pca$rotation)
pca_tab<-pca_tab%>%
  add_rownames()
pca_kabjune<-flextable(pca_tab)
#pca_kab<-kbl(pca_tab)%>%
 #  kable_classic() %>%
  # kable_styling(bootstrap_options = "striped", font_size = 20)
pca_impjune<-flextable(pca_sum)



pca12_plotjune<-ggbiplot::ggbiplot(pca,ellipse=TRUE,var.axes = TRUE,varname.size=4,alpha=0.3) + ylab("PC2 (25.99%)") +  xlab("PC1 (59.97%)") + scale_x_continuous(guide = guide_axis(check.overlap = TRUE),limits=c(-3,3),breaks=c(-3,-2,-1,0,1,2,3)) + scale_y_continuous(guide = guide_axis(check.overlap = TRUE),limits=c(-2.5,2.5),breaks=c(-2.5,-2,-1,0,1,2,2.5)) + theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(text = element_text(
        size = 20, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + guides(fill=guide_legend(title="Species"))+ 
  theme(legend.title = element_blank()) + 
  geom_segment(aes(x=-Inf,xend=Inf,y=0,yend=0),linetype="dashed") +
  geom_segment(aes(x=0,xend=0,y=-Inf,yend=Inf),linetype="dashed") 

pc1<-pca_tab%>%
  dplyr::select(rowname,PC1)%>%
  dplyr::rename(Value=PC1)%>%
  dplyr::mutate(Variable="PC1")
pc2<-pca_tab%>%
  dplyr::select(rowname,PC2)%>%
  dplyr::rename(Value=PC2)%>%
  dplyr::mutate(Variable="PC2")
pc3<-pca_tab%>%
  dplyr::select(rowname,PC3)%>%
  dplyr::rename(Value=PC3)%>%
  dplyr::mutate(Variable="PC3")
pc4<-pca_tab%>%
  dplyr::select(rowname,PC4)%>%
  dplyr::rename(Value=PC4)%>%
  dplyr::mutate(Variable="PC4")
pc5<-pca_tab%>%
  dplyr::select(rowname,PC5)%>%
  dplyr::rename(Value=PC5)%>%
  dplyr::mutate(Variable="PC5")
pc<-rbind(pc1,pc2,pc3,pc4,pc5)


pca_heatjune<-ggplot(pc,aes(Variable,rowname)) + geom_tile(aes(fill=Value)) + geom_text(aes(label=round(Value,2))) + ylab("") +  xlab("Principal Component")  + theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(text = element_text(
        size = 20, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + guides(fill=guide_legend(title="Species"))+ 
  theme(legend.title = element_blank(),legend.text=element_text(size=12),
        plot.margin=unit(c(0.2,1,0.5,-0.5), "cm")) +
  scale_fill_gradientn(colours=hcl.colors(10,"Spectral"),guide="colourbar") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 10))






pc1<-pca_sum%>%
  dplyr::filter(rowname=="Proportion of Variance")%>%
  dplyr::select(rowname,PC1)%>%
  dplyr::rename(Value=PC1)%>%
  dplyr::mutate(Variable="PC1")
pc2<-pca_sum%>%
    dplyr::filter(rowname=="Proportion of Variance")%>%
  dplyr::select(rowname,PC2)%>%
  dplyr::rename(Value=PC2)%>%
  dplyr::mutate(Variable="PC2")
pc3<-pca_sum%>%
    dplyr::filter(rowname=="Proportion of Variance")%>%
  dplyr::select(rowname,PC3)%>%
  dplyr::rename(Value=PC3)%>%
  dplyr::mutate(Variable="PC3")
pc4<-pca_sum%>%
    dplyr::filter(rowname=="Proportion of Variance")%>%
  dplyr::select(rowname,PC4)%>%
  dplyr::rename(Value=PC4)%>%
  dplyr::mutate(Variable="PC4")
pc5<-pca_sum%>%
    dplyr::filter(rowname=="Proportion of Variance")%>%
  dplyr::select(rowname,PC5)%>%
  dplyr::rename(Value=PC5)%>%
  dplyr::mutate(Variable="PC5")
screepc<-rbind(pc1,pc2,pc3,pc4,pc5)
  
scree_june<-ggplot(screepc,aes(Variable,Value,group=rowname)) + 
  geom_bar(stat="identity",color="black",fill="white") + 
  xlab("") +
  ylab("% of Variance") + theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(text = element_text(
        size = 12, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + guides(fill=guide_legend(title="Species"))+ 
  theme(legend.title = element_blank(),
        axis.text.x=element_blank(),
        plot.margin=unit(c(1,1,-0.1,1), "cm"))











# PCA 2: PHOTO, GROWTH, PSI
photo<-wp_photo%>%
  dplyr::select(Species,Year,Month,ID,pct_photo,Ypd)%>%
  dplyr::mutate(Ypd=abs(Ypd))
photo$Month<-gsub("0","",photo$Month)
photo$Month<-as.numeric(photo$Month)
new_growth<-gw_spp%>%
  dplyr::select(Species,Year,Month,ID,pct_growth)
new_growth$Month<-gsub("0","",new_growth$Month)
new_growth$Month<-as.numeric(new_growth$Month)
pca_df2<-merge(new_growth,photo)%>%
  distinct()%>%
  dplyr::rename("\u03A8 (predawn)"=Ypd,Photosynthesis=pct_photo,Growth=pct_growth)

theta <- acos( sum(pca_df2$Growth*pca_df2$Photosynthesis) / ( sqrt(sum(pca_df2$Growth * pca_df2$Growth)) * sqrt(sum(pca_df2$Photosynthesis * pca_df2$Photosynthesis)) ) ) 
# 0.89 again!!!

pca2<-prcomp(pca_df2[5:7],center=TRUE,scale.=TRUE)
summary(pca2) # PC1 AND PC2 explain 85% of variance
pca2

pca12_plot2<-ggbiplot::ggbiplot(pca2,ellipse=TRUE,var.axes = TRUE,varname.size=4,alpha=0.3)

# PCA 3: Growth, CANOPY SUGAR, STARCH, PSI
st<-canopy%>%
  dplyr::filter(Variable=="Starch")%>%
  dplyr::rename(Starch=avg_pct)%>%
  ungroup()%>%
  dplyr::select(-Variable)
su<-canopy%>%
  dplyr::filter(Variable=="Sugar")%>%
  dplyr::rename(Sugar=avg_pct)%>%
  ungroup()%>%
  dplyr::select(-Variable)
NSC3<-merge(st,su)%>%
  drop_na()
gsp<-merge(NSC3,new_growth)
pca3<-prcomp(gsp[5:8],center=TRUE,scale.=TRUE)
summary(pca3) # PC1 AND PC2 explain 85% of variance
pca3

pca12_plot3<-ggbiplot::ggbiplot(pca3,ellipse=TRUE,var.axes = TRUE,varname.size=4,alpha=0.3)

# PCA 4: JUNE SUGAR, STARCH, PSI, growth
st<-june%>%
  dplyr::filter(Variable=="Starch")%>%
  dplyr::rename(Starch=avg_pct)%>%
  ungroup()%>%
  dplyr::select(-Variable)
su<-june%>%
  dplyr::filter(Variable=="Sugar")%>%
  dplyr::rename(Sugar=avg_pct)%>%
  ungroup()%>%
  dplyr::select(-Variable)
NSC4<-merge(st,su)%>%
  drop_na()%>%
  distinct()
gsp2<-merge(NSC4,new_growth)

pca4<-prcomp(gsp2[5:8],center=TRUE,scale.=TRUE)
summary(pca4) # PC1 AND PC2 explain 85% of variance
pca4

pca12_plot4<-ggbiplot::ggbiplot(pca4,ellipse=TRUE,var.axes = TRUE,varname.size=4,alpha=0.3)


# then, construct models that show the relative change in these variables with WP (multivariate approach, PCA?)
#gg_NSC1<-gg_NSC%>%drop_na()%>%select(-pct_sug,-pct_starch)
#nsc.pca <- prcomp(gg_NSC1[,6:9], center = TRUE,scale. = TRUE)
#summary(nsc.pca) # PC1 and PC2 explain 72% of variation
#nsc.pca 
# PC1 has higher NSC, lower photosynthesis, lower growth, more negative Ypd
# PC2 has lower NSC, declining Ypd, higher photo, and lower growth
#library(ggbiplot)
#species<-gg_NSC$Species
#nsc_biplot<-ggbiplot(nsc.pca,ellipse=TRUE)

#gg_SUG<-gg_NSC%>%drop_na()%>%select(-pct_NSC,-pct_starch)
#sug.pca<-prcomp(gg_SUG[,6:9], center = TRUE,scale. = TRUE)
#summary(sug.pca) # PC1 & PC2 explain 71% of variation
#sug.pca # PC1 defined by lower sugar, higher psi, photo and growth
# PC2 defined by higher sugar, psi, photo, lower growth
#sug_biplot<-ggbiplot(sug.pca,ellipse=TRUE)
  

#gg_ST<-gg_NSC%>%drop_na()%>%select(-pct_NSC,-pct_sug)
#st.pca<-prcomp(gg_ST[,6:9], center = TRUE,scale. = TRUE)
#summary(st.pca) # PC1 & PC2 explain 74% of variation
#st.pca # PC1 defined by higher starch, declining psi, photo, growth
# PC2 defined by lower starch, psi, and growth, with increasing photosynthesis
#st_biplot<-ggbiplot(st.pca,ellipse=TRUE)

#gg_nsc<-gg_NSC%>%select(-pct_NSC)%>%drop_na()
#sugst.pca<-prcomp(gg_nsc[6:10],center=TRUE,scale.=TRUE)
#summary(sugst.pca) # PC1 and PC2 explain 65% of variation
#sugst_biplot<-ggbiplot(sugst.pca,groups=gg_nsc$Species,ellipse=TRUE)


```

SENSITIVITY ANALYSES START HERE


``` {r A sensitivity analysis + 10}
### PHOTOSYNTHESIS
wp_photo_final<-photo3%>%
  dplyr::filter(Photo>"0.0000")%>%
  dplyr::group_by(ID)%>%
  dplyr::mutate(max_photo=max(Photo)+0.10*max(Photo))%>%
  dplyr::mutate(pct_photo=(Photo/max_photo)*100)%>%
  #mutate(Species=ifelse(Species=="JUMO","J. monosperma","P. edulis"))%>%
  dplyr::group_by(Species,Year,Month)%>%
  dplyr::mutate(avg_pct=mean(pct_photo))


#wp<-wp%>%
 # mutate(Species=ifelse(Species=="JUMO","J. monosperma","P. edulis"))
wp_photo<-merge(wp_photo_final,wp)%>%
  dplyr::group_by(Year,Month,Species)%>%
  dplyr::mutate(avg_Ypd=mean(Ypd))

wp10<-wp_photo%>%
  mutate(Method="+10%")

pied<-wp_photo%>%filter(Species=="PIED")%>%drop_na()
jumo<-wp_photo%>%filter(Species=="JUMO")%>%drop_na()

# get rid of the outliers
p.cook<-cooks.distance(lm(pct_photo~log(abs(Ypd)),data=pied))
influential <- p.cook[(p.cook > (3 * mean(p.cook, na.rm = TRUE)))]
influential
names_of_influential <- names(influential)
outliers <- pied[names_of_influential,]
piedphoto_new <- pied %>% anti_join(outliers)

j.cook<-cooks.distance(lm(pct_photo~log(abs(Ypd)),data=jumo))
influential <- j.cook[(j.cook > (3 * mean(j.cook, na.rm = TRUE)))]
influential
names_of_influential <- names(influential)
outliers <- jumo[names_of_influential,]
jumophoto_new <- jumo %>% anti_join(outliers)
jp_new<-rbind(piedphoto_new,jumophoto_new)%>%
  mutate(newpct=pct_photo)%>%
  mutate(newpsi=Ypd)


SE10<-jp_new %>%
  group_by(Species) %>%
  do(data.frame(SE = summary(lm(pct_photo~log(abs(Ypd)),.))$coefficients[2,2]))%>%
  mutate(Method="+10%")
  
yint_log<-jp_new %>%
  group_by(Species) %>%
  do(data.frame(y_intercept = coef(lm(pct_photo~log(abs(Ypd)),.))[1]))
slope_log<-jp_new %>%
  group_by(Species) %>%
  do(data.frame(slope = coef(lm(pct_photo~log(abs(Ypd)),.))[2]))
# PIED - y = 63.7 - 51.8x
# JUMO - y = 58.6 - 33.3x
photo_log<-merge(slope_log,yint_log)%>%
  mutate(xint=-(y_intercept)/slope)%>%
  mutate(xint=exp(xint))%>%
  dplyr::select(Species,xint,slope)
#photo_<-merge(gw_spp,growth_lm)

log10<-photo_log%>%
  mutate(Species=ifelse(Species=="JUMO","J. monosperma", "P. edulis"),Method="+10%")



```

``` {r A sensitivity analysis - 10}
### PHOTOSYNTHESIS
wp_photo_final<-photo3%>%
  dplyr::filter(Photo>"0.0000")%>%
  dplyr::group_by(ID)%>%
  dplyr::mutate(max_photo=max(Photo)-0.10*max(Photo))%>%
  dplyr::mutate(pct_photo=(Photo/max_photo)*100)%>%
  #mutate(Species=ifelse(Species=="JUMO","J. monosperma","P. edulis"))%>%
  dplyr::group_by(Species,Year,Month)%>%
  dplyr::mutate(avg_pct=mean(pct_photo))
#wp<-wp%>%
 # mutate(Species=ifelse(Species=="JUMO","J. monosperma","P. edulis"))
wp_photo<-merge(wp_photo_final,wp)%>%
  dplyr::group_by(Year,Month,Species)%>%
  dplyr::mutate(avg_Ypd=mean(Ypd))

wpm10<-wp_photo%>%
  mutate(Method="-10%")

pied<-wp_photo%>%filter(Species=="PIED")%>%drop_na()
jumo<-wp_photo%>%filter(Species=="JUMO")%>%drop_na()

# get rid of the outliers
p.cook<-cooks.distance(lm(pct_photo~log(abs(Ypd)),data=pied))
influential <- p.cook[(p.cook > (3 * mean(p.cook, na.rm = TRUE)))]
influential
names_of_influential <- names(influential)
outliers <- pied[names_of_influential,]
piedphoto_new <- pied %>% anti_join(outliers)

j.cook<-cooks.distance(lm(pct_photo~log(abs(Ypd)),data=jumo))
influential <- j.cook[(j.cook > (3 * mean(j.cook, na.rm = TRUE)))]
influential
names_of_influential <- names(influential)
outliers <- jumo[names_of_influential,]
jumophoto_new <- jumo %>% anti_join(outliers)
jp_new<-rbind(piedphoto_new,jumophoto_new)%>%
  mutate(newpct=pct_photo)%>%
  mutate(newpsi=Ypd)


SEm10<-jp_new %>%
  group_by(Species) %>%
  do(data.frame(SE = summary(lm(pct_photo~log(abs(Ypd)),.))$coefficients[2,2]))%>%
  mutate(Method="-10%")
yint_log<-jp_new %>%
  group_by(Species) %>%
  do(data.frame(y_intercept = coef(lm(pct_photo~log(abs(Ypd)),.))[1]))
slope_log<-jp_new %>%
  group_by(Species) %>%
  do(data.frame(slope = coef(lm(pct_photo~log(abs(Ypd)),.))[2]))
# PIED - y = 63.7 - 51.8x
# JUMO - y = 58.6 - 33.3x
photo_log<-merge(slope_log,yint_log)%>%
  mutate(xint=-(y_intercept)/slope)%>%
  mutate(xint=exp(xint))%>%
  dplyr::select(Species,xint,slope)
#photo_<-merge(gw_spp,growth_lm)

log_minus_10<-photo_log%>%
  mutate(Species=ifelse(Species=="JUMO","J. monosperma", "P. edulis"),Method="-10%")

```

``` {r A sensitivity analysis + 25}
### PHOTOSYNTHESIS
wp_photo_final<-photo3%>%
  dplyr::filter(Photo>"0.0000")%>%
  dplyr::group_by(ID)%>%
  dplyr::mutate(max_photo=max(Photo)+0.25*max(Photo))%>%
  dplyr::mutate(pct_photo=(Photo/max_photo)*100)%>%
  #mutate(Species=ifelse(Species=="JUMO","J. monosperma","P. edulis"))%>%
  dplyr::group_by(Species,Year,Month)%>%
  dplyr::mutate(avg_pct=mean(pct_photo))
#wp<-wp%>%
 # mutate(Species=ifelse(Species=="JUMO","J. monosperma","P. edulis"))
wp_photo<-merge(wp_photo_final,wp)%>%
  dplyr::group_by(Year,Month,Species)%>%
  dplyr::mutate(avg_Ypd=mean(Ypd))

wp25<-wp_photo%>%
  mutate(Method="+25%")

pied<-wp_photo%>%filter(Species=="PIED")%>%drop_na()
jumo<-wp_photo%>%filter(Species=="JUMO")%>%drop_na()

# get rid of the outliers
p.cook<-cooks.distance(lm(pct_photo~log(abs(Ypd)),data=pied))
influential <- p.cook[(p.cook > (3 * mean(p.cook, na.rm = TRUE)))]
influential
names_of_influential <- names(influential)
outliers <- pied[names_of_influential,]
piedphoto_new <- pied %>% anti_join(outliers)

j.cook<-cooks.distance(lm(pct_photo~log(abs(Ypd)),data=jumo))
influential <- j.cook[(j.cook > (3 * mean(j.cook, na.rm = TRUE)))]
influential
names_of_influential <- names(influential)
outliers <- jumo[names_of_influential,]
jumophoto_new <- jumo %>% anti_join(outliers)
jp_new<-rbind(piedphoto_new,jumophoto_new)%>%
  mutate(newpct=pct_photo)%>%
  mutate(newpsi=Ypd)


SE25<-jp_new %>%
  group_by(Species) %>%
  do(data.frame(SE = summary(lm(pct_photo~log(abs(Ypd)),.))$coefficients[2,2]))%>%
  mutate(Method="+25%")
yint_log<-jp_new %>%
  group_by(Species) %>%
  do(data.frame(y_intercept = coef(lm(pct_photo~log(abs(Ypd)),.))[1]))
slope_log<-jp_new %>%
  group_by(Species) %>%
  do(data.frame(slope = coef(lm(pct_photo~log(abs(Ypd)),.))[2]))
# PIED - y = 63.7 - 51.8x
# JUMO - y = 58.6 - 33.3x
photo_log<-merge(slope_log,yint_log)%>%
  mutate(xint=-(y_intercept)/slope)%>%
  mutate(xint=exp(xint))%>%
  dplyr::select(Species,xint,slope)
#photo_<-merge(gw_spp,growth_lm)

log25<-photo_log%>%
  mutate(Species=ifelse(Species=="JUMO","J. monosperma", "P. edulis"),Method="+25%")

```

``` {r A sensitivity analysis - 25}
### PHOTOSYNTHESIS
wp_photo_final<-photo3%>%
  dplyr::filter(Photo>"0.0000")%>%
  dplyr::group_by(ID)%>%
  dplyr::mutate(max_photo=max(Photo)-0.25*max(Photo))%>%
  dplyr::mutate(pct_photo=(Photo/max_photo)*100)%>%
  #mutate(Species=ifelse(Species=="JUMO","J. monosperma","P. edulis"))%>%
  dplyr::group_by(Species,Year,Month)%>%
  dplyr::mutate(avg_pct=mean(pct_photo))
#wp<-wp%>%
 # mutate(Species=ifelse(Species=="JUMO","J. monosperma","P. edulis"))
wp_photo<-merge(wp_photo_final,wp)%>%
  dplyr::group_by(Year,Month,Species)%>%
  dplyr::mutate(avg_Ypd=mean(Ypd))

wpm25<-wp_photo%>%
  mutate(Method="-25%")

wp_all<-rbind(wp10,wpm10,wp25,wpm25)%>%
  ungroup()%>%
  dplyr::select(Species,pct_photo,Ypd,Method)%>%
  mutate(Variable="Photosynthesis")%>%
  rename(pct=pct_photo)

pied<-wp_photo%>%filter(Species=="PIED")%>%drop_na()
jumo<-wp_photo%>%filter(Species=="JUMO")%>%drop_na()

# get rid of the outliers
p.cook<-cooks.distance(lm(pct_photo~log(abs(Ypd)),data=pied))
influential <- p.cook[(p.cook > (3 * mean(p.cook, na.rm = TRUE)))]
influential
names_of_influential <- names(influential)
outliers <- pied[names_of_influential,]
piedphoto_new <- pied %>% anti_join(outliers)

j.cook<-cooks.distance(lm(pct_photo~log(abs(Ypd)),data=jumo))
influential <- j.cook[(j.cook > (3 * mean(j.cook, na.rm = TRUE)))]
influential
names_of_influential <- names(influential)
outliers <- jumo[names_of_influential,]
jumophoto_new <- jumo %>% anti_join(outliers)
jp_new<-rbind(piedphoto_new,jumophoto_new)%>%
  mutate(newpct=pct_photo)%>%
  mutate(newpsi=Ypd)


SEm25<-jp_new %>%
  group_by(Species) %>%
  do(data.frame(SE = summary(lm(pct_photo~log(abs(Ypd)),.))$coefficients[2,2]))%>%
  mutate(Method="-25%")
yint_log<-jp_new %>%
  group_by(Species) %>%
  do(data.frame(y_intercept = coef(lm(pct_photo~log(abs(Ypd)),.))[1]))
slope_log<-jp_new %>%
  group_by(Species) %>%
  do(data.frame(slope = coef(lm(pct_photo~log(abs(Ypd)),.))[2]))
# PIED - y = 63.7 - 51.8x
# JUMO - y = 58.6 - 33.3x
photo_log<-merge(slope_log,yint_log)%>%
  mutate(xint=-(y_intercept)/slope)%>%
  mutate(xint=exp(xint))%>%
  dplyr::select(Species,xint,slope)
#photo_<-merge(gw_spp,growth_lm)

log_minus_25<-photo_log%>%
  mutate(Species=ifelse(Species=="JUMO","J. monosperma", "P. edulis"),Method="-25%")

se<-rbind(SE0,SE10,SEm10,SE25,SEm25)

# now combine all the results
asensitivity<-rbind(log,log10,log_minus_10,log25,log_minus_25)
as<-asensitivity%>%
  group_by(Species)%>%
  mutate(xint_con=0)%>%
  mutate(con_max=abs(slope-slope[Method=="Obs. Max"]))%>%
  mutate(con_10=abs(slope-slope[Method=="+10%"]))%>%
  mutate(con_25=abs(slope-slope[Method=="+25%"]))%>%
  mutate(con_minus_10=abs(slope-slope[Method=="-10%"]))%>%
  mutate(con_minus_25=abs(slope-slope[Method=="-25%"]))%>%
  merge(.,se)%>%
  mutate(z_max=ifelse(con_max/sqrt(SE+SE[Method=="Obs. Max"])>=1.645,"(*)","(n.s.)"))%>%
  mutate(con_max=paste(round(con_max,3),z_max))%>%
  mutate(z_10=ifelse(con_10/sqrt(SE+SE[Method=="+10%"])>=1.645,"(*)","(n.s.)"))%>%
  mutate(con_10=paste(round(con_10,3),z_10))%>%
  mutate(z_25=ifelse(con_25/sqrt(SE+SE[Method=="+25%"])>=1.645,"(*)","(n.s.)"))%>%
  mutate(con_25=paste(round(con_25,3),z_25))%>%
  mutate(z_minus_10=ifelse(con_minus_10/sqrt(SE+SE[Method=="-10%"])>=1.645,"(*)","(n.s.)"))%>%
  mutate(con_minus_10=paste(round(con_minus_10,3),z_minus_10))%>%
  mutate(z_minus_25=ifelse(con_minus_25/sqrt(SE+SE[Method=="-25%"])>=1.645,"(*)","(n.s.)"))%>%
  mutate(con_minus_25=paste(round(con_minus_25,3),z_minus_25))%>%
  dplyr::select(-z_max,-z_10,-z_25,-z_minus_10,-z_minus_25,-SE)%>%
  arrange(Species,Method)

p<-as%>%
  filter(Species=="P. edulis")%>%
  ungroup()%>%
  dplyr::select(Species,Method,con_max,con_10,con_25,con_minus_10,con_minus_25)%>%
  dplyr::rename("Obs. Max"=con_max,"+10%"=con_10,"+25%"=con_25,"-10%"=con_minus_10,"-25%"=con_minus_25)%>%
   arrange(match(Method, c("Obs. Max","+10%","+25%","-10%","-25%")))
j<-as%>%
  filter(Species=="J. monosperma")%>%
  ungroup()%>%
  dplyr::select(Species,Method,con_max,con_10,con_25,con_minus_10,con_minus_25)%>%
  dplyr::rename("Obs. Max"=con_max,"+10%"=con_10,"+25%"=con_25,"-10%"=con_minus_10,"-25%"=con_minus_25)%>%
   arrange(match(Method, c("Obs. Max","+10%","+25%","-10%","-25%")))
pj_Aslopes<-rbind(p,j)
# EVERYTHING IS DIFFERENT FROM EVERYTHING ELSE



```

``` {r G sensitivity analysis + 10}
growth<-read.csv("stemgrowth.csv")%>%
  dplyr::select(-Month)
weather<-read.csv("weather.csv")%>%
  dplyr::select(Date,Precip_sum)
growth<-growth%>%
  group_by(ID)%>%
  arrange(ID,Date)%>%
  drop_na()
growth$Growth<-as.numeric(growth$Growth)
growth<-growth%>%
  dplyr::group_by(ID)%>%
  mutate(growth_start=ifelse(Growth>lag(Growth),"start","end"))
growth$Month<-substr(growth$Date,6,7)

growth<-growth%>%
  drop_na()%>%
  dplyr::mutate(growth=ifelse(growth_start=="end",0,Growth))%>%
  dplyr::select(-Growth)%>%
  dplyr::group_by(ID,Year,Month,)%>%
  dplyr::mutate(tot_growth=sum(growth))%>%
  dplyr::mutate(monthly_growth=ifelse(tot_growth<=0,0,tot_growth))%>%
  dplyr::group_by(ID)%>%
  dplyr::mutate(max_growth=max(monthly_growth)+0.10*max(monthly_growth),pct_growth=(monthly_growth/max_growth*100))


wp<-WP3%>%
  dplyr::select(Year,Month,ID,Species,Ypd)
g_wp<-merge(growth, wp)

g10<-g_wp%>%
  mutate(Method="+10%")

pied<-g_wp%>%filter(Species=="PIED")
jumo<-g_wp%>%filter(Species=="JUMO")


p.cook<-cooks.distance(lm(pct_growth~log(abs(Ypd)),data=pied))
influential <- p.cook[(p.cook > (3 * mean(p.cook, na.rm = TRUE)))]
influential
names_of_influential <- names(influential)
outliers <- pied[names_of_influential,]
piedgrowth_new <- pied %>% anti_join(outliers)
j.cook<-cooks.distance(lm(pct_growth~log(abs(Ypd)),data=jumo))
influential <- j.cook[(j.cook > (3 * mean(j.cook, na.rm = TRUE)))]
influential
names_of_influential <- names(influential)
outliers <- jumo[names_of_influential,]
jumogrowth_new <- jumo %>% anti_join(outliers)
jpg_new<-rbind(piedgrowth_new,jumogrowth_new)




SE10<-jpg_new %>%
  group_by(Species) %>%
  do(data.frame(SE = summary(lm(pct_growth~log(abs(Ypd)),.))$coefficients[2,2]))%>%
  mutate(Method="+10%")
  
yint_log<-jpg_new %>%
  group_by(Species) %>%
  do(data.frame(y_intercept = coef(lm(pct_growth~log(abs(Ypd)),.))[1]))
slope_log<-jpg_new %>%
  group_by(Species) %>%
  do(data.frame(slope = coef(lm(pct_growth~log(abs(Ypd)),.))[2]))
# PIED - y = 63.7 - 51.8x
# JUMO - y = 58.6 - 33.3x
growth_log<-merge(slope_log,yint_log)%>%
  mutate(xint=-(y_intercept)/slope)%>%
  mutate(xint=exp(xint))%>%
  dplyr::select(Species,xint,slope)
#photo_<-merge(gw_spp,growth_lm)

glog10<-growth_log%>%
  mutate(Species=ifelse(Species=="JUMO","J. monosperma", "P. edulis"),Method="+10%")


```

``` {r G sensitivity analysis - 10}
growth<-read.csv("stemgrowth.csv")%>%
  dplyr::select(-Month)
weather<-read.csv("weather.csv")%>%
  dplyr::select(Date,Precip_sum)
growth<-growth%>%
  group_by(ID)%>%
  arrange(ID,Date)%>%
  drop_na()
growth$Growth<-as.numeric(growth$Growth)
growth<-growth%>%
  dplyr::group_by(ID)%>%
  mutate(growth_start=ifelse(Growth>lag(Growth),"start","end"))
growth$Month<-substr(growth$Date,6,7)

growth<-growth%>%
  drop_na()%>%
  dplyr::mutate(growth=ifelse(growth_start=="end",0,Growth))%>%
  dplyr::select(-Growth)%>%
  dplyr::group_by(ID,Year,Month,)%>%
  dplyr::mutate(tot_growth=sum(growth))%>%
  dplyr::mutate(monthly_growth=ifelse(tot_growth<=0,0,tot_growth))%>%
  dplyr::group_by(ID)%>%
  dplyr::mutate(max_growth=max(monthly_growth)-0.10*max(monthly_growth),pct_growth=(monthly_growth/max_growth*100))



wp<-WP3%>%
  dplyr::select(Year,Month,ID,Species,Ypd)
g_wp<-merge(growth, wp)

gm10<-g_wp%>%
  mutate(Method="-10%")

pied<-g_wp%>%filter(Species=="PIED")
jumo<-g_wp%>%filter(Species=="JUMO")


p.cook<-cooks.distance(lm(pct_growth~log(abs(Ypd)),data=pied))
influential <- p.cook[(p.cook > (3 * mean(p.cook, na.rm = TRUE)))]
influential
names_of_influential <- names(influential)
outliers <- pied[names_of_influential,]
piedgrowth_new <- pied %>% anti_join(outliers)
j.cook<-cooks.distance(lm(pct_growth~log(abs(Ypd)),data=jumo))
influential <- j.cook[(j.cook > (3 * mean(j.cook, na.rm = TRUE)))]
influential
names_of_influential <- names(influential)
outliers <- jumo[names_of_influential,]
jumogrowth_new <- jumo %>% anti_join(outliers)
jpg_new<-rbind(piedgrowth_new,jumogrowth_new)




SEm10<-jpg_new %>%
  group_by(Species) %>%
  do(data.frame(SE = summary(lm(pct_growth~log(abs(Ypd)),.))$coefficients[2,2]))%>%
  mutate(Method="-10%")
  
yint_log<-jpg_new %>%
  group_by(Species) %>%
  do(data.frame(y_intercept = coef(lm(pct_growth~log(abs(Ypd)),.))[1]))
slope_log<-jpg_new %>%
  group_by(Species) %>%
  do(data.frame(slope = coef(lm(pct_growth~log(abs(Ypd)),.))[2]))
# PIED - y = 63.7 - 51.8x
# JUMO - y = 58.6 - 33.3x
growth_log<-merge(slope_log,yint_log)%>%
  mutate(xint=-(y_intercept)/slope)%>%
  mutate(xint=exp(xint))%>%
  dplyr::select(Species,xint,slope)
#photo_<-merge(gw_spp,growth_lm)

glog_minus_10<-growth_log%>%
  mutate(Species=ifelse(Species=="JUMO","J. monosperma", "P. edulis"),Method="-10%")


```

``` {r G sensitivity analysis + 25}
growth<-read.csv("stemgrowth.csv")%>%
  dplyr::select(-Month)
weather<-read.csv("weather.csv")%>%
  dplyr::select(Date,Precip_sum)
growth<-growth%>%
  group_by(ID)%>%
  arrange(ID,Date)%>%
  drop_na()
growth$Growth<-as.numeric(growth$Growth)
growth<-growth%>%
  dplyr::group_by(ID)%>%
  mutate(growth_start=ifelse(Growth>lag(Growth),"start","end"))
growth$Month<-substr(growth$Date,6,7)

growth<-growth%>%
  drop_na()%>%
  dplyr::mutate(growth=ifelse(growth_start=="end",0,Growth))%>%
  dplyr::select(-Growth)%>%
  dplyr::group_by(ID,Year,Month,)%>%
  dplyr::mutate(tot_growth=sum(growth))%>%
  dplyr::mutate(monthly_growth=ifelse(tot_growth<=0,0,tot_growth))%>%
  dplyr::group_by(ID)%>%
  dplyr::mutate(max_growth=max(monthly_growth)+0.25*max(monthly_growth),pct_growth=(monthly_growth/max_growth*100))



wp<-WP3%>%
  dplyr::select(Year,Month,ID,Species,Ypd)
g_wp<-merge(growth, wp)

g25<-g_wp%>%
  mutate(Method="+25%")

pied<-g_wp%>%filter(Species=="PIED")
jumo<-g_wp%>%filter(Species=="JUMO")


p.cook<-cooks.distance(lm(pct_growth~log(abs(Ypd)),data=pied))
influential <- p.cook[(p.cook > (3 * mean(p.cook, na.rm = TRUE)))]
influential
names_of_influential <- names(influential)
outliers <- pied[names_of_influential,]
piedgrowth_new <- pied %>% anti_join(outliers)
j.cook<-cooks.distance(lm(pct_growth~log(abs(Ypd)),data=jumo))
influential <- j.cook[(j.cook > (3 * mean(j.cook, na.rm = TRUE)))]
influential
names_of_influential <- names(influential)
outliers <- jumo[names_of_influential,]
jumogrowth_new <- jumo %>% anti_join(outliers)
jpg_new<-rbind(piedgrowth_new,jumogrowth_new)




SE25<-jpg_new %>%
  group_by(Species) %>%
  do(data.frame(SE = summary(lm(pct_growth~log(abs(Ypd)),.))$coefficients[2,2]))%>%
  mutate(Method="+25%")
  
yint_log<-jpg_new %>%
  group_by(Species) %>%
  do(data.frame(y_intercept = coef(lm(pct_growth~log(abs(Ypd)),.))[1]))
slope_log<-jpg_new %>%
  group_by(Species) %>%
  do(data.frame(slope = coef(lm(pct_growth~log(abs(Ypd)),.))[2]))
# PIED - y = 63.7 - 51.8x
# JUMO - y = 58.6 - 33.3x
growth_log<-merge(slope_log,yint_log)%>%
  mutate(xint=-(y_intercept)/slope)%>%
  mutate(xint=exp(xint))%>%
  dplyr::select(Species,xint,slope)
#photo_<-merge(gw_spp,growth_lm)

glog25<-growth_log%>%
  mutate(Species=ifelse(Species=="JUMO","J. monosperma", "P. edulis"),Method="+25%")


```

``` {r G sensitivity analysis - 25}
growth<-read.csv("stemgrowth.csv")%>%
  dplyr::select(-Month)
weather<-read.csv("weather.csv")%>%
  dplyr::select(Date,Precip_sum)
growth<-growth%>%
  group_by(ID)%>%
  arrange(ID,Date)%>%
  drop_na()
growth$Growth<-as.numeric(growth$Growth)
growth<-growth%>%
  dplyr::group_by(ID)%>%
  mutate(growth_start=ifelse(Growth>lag(Growth),"start","end"))
growth$Month<-substr(growth$Date,6,7)

growth<-growth%>%
  drop_na()%>%
  dplyr::mutate(growth=ifelse(growth_start=="end",0,Growth))%>%
  dplyr::select(-Growth)%>%
  dplyr::group_by(ID,Year,Month,)%>%
  dplyr::mutate(tot_growth=sum(growth))%>%
  dplyr::mutate(monthly_growth=ifelse(tot_growth<=0,0,tot_growth))%>%
  dplyr::group_by(ID)%>%
  dplyr::mutate(max_growth=max(monthly_growth)-0.25*max(monthly_growth),pct_growth=(monthly_growth/max_growth*100))



wp<-WP3%>%
  dplyr::select(Year,Month,ID,Species,Ypd)
g_wp<-merge(growth, wp)

gm25<-g_wp%>%
  mutate(Method="-25%")

g_all<-rbind(g10,gm10,g25,gm25)%>%
  dplyr::select(Species,pct_growth,Ypd,Method)%>%
  mutate(Variable="Growth")%>%
  rename(pct=pct_growth)

pied<-g_wp%>%filter(Species=="PIED")
jumo<-g_wp%>%filter(Species=="JUMO")


p.cook<-cooks.distance(lm(pct_growth~log(abs(Ypd)),data=pied))
influential <- p.cook[(p.cook > (3 * mean(p.cook, na.rm = TRUE)))]
influential
names_of_influential <- names(influential)
outliers <- pied[names_of_influential,]
piedgrowth_new <- pied %>% anti_join(outliers)
j.cook<-cooks.distance(lm(pct_growth~log(abs(Ypd)),data=jumo))
influential <- j.cook[(j.cook > (3 * mean(j.cook, na.rm = TRUE)))]
influential
names_of_influential <- names(influential)
outliers <- jumo[names_of_influential,]
jumogrowth_new <- jumo %>% anti_join(outliers)
jpg_new<-rbind(piedgrowth_new,jumogrowth_new)




SEm25<-jpg_new %>%
  group_by(Species) %>%
  do(data.frame(SE = summary(lm(pct_growth~log(abs(Ypd)),.))$coefficients[2,2]))%>%
  mutate(Method="-25%")
  
yint_log<-jpg_new %>%
  group_by(Species) %>%
  do(data.frame(y_intercept = coef(lm(pct_growth~log(abs(Ypd)),.))[1]))
slope_log<-jpg_new %>%
  group_by(Species) %>%
  do(data.frame(slope = coef(lm(pct_growth~log(abs(Ypd)),.))[2]))
# PIED - y = 63.7 - 51.8x
# JUMO - y = 58.6 - 33.3x
growth_log<-merge(slope_log,yint_log)%>%
  mutate(xint=-(y_intercept)/slope)%>%
  mutate(xint=exp(xint))%>%
  dplyr::select(Species,xint,slope)
#photo_<-merge(gw_spp,growth_lm)

glog_minus_25<-growth_log%>%
  mutate(Species=ifelse(Species=="JUMO","J. monosperma", "P. edulis"),Method="-25%")


gse<-rbind(SE0,SE10,SE25,SEm10,SEm25)%>%
  mutate(Species=ifelse(Species=="JUMO","J. monosperma", "P. edulis"))
# now combine all the results
gsensitivity<-rbind(glog,glog10,glog_minus_10,glog25,glog_minus_25)

gs<-gsensitivity%>%
  group_by(Species)%>%
  mutate(xint_con=0)%>%
  mutate(con_max=abs(slope-slope[Method=="Obs. Max"]))%>%
  mutate(con_10=abs(slope-slope[Method=="+10%"]))%>%
  mutate(con_25=abs(slope-slope[Method=="+25%"]))%>%
  mutate(con_minus_10=abs(slope-slope[Method=="-10%"]))%>%
  mutate(con_minus_25=abs(slope-slope[Method=="-25%"]))%>%
  merge(.,gse)%>%
  mutate(z_max=ifelse(con_max/sqrt(SE+SE[Method=="Obs. Max"])>=1.645,"(*)","(n.s.)"))%>%
  mutate(con_max=paste(round(con_max,3),z_max))%>%
  mutate(z_10=ifelse(con_10/sqrt(SE+SE[Method=="+10%"])>=1.645,"(*)","(n.s.)"))%>%
  mutate(con_10=paste(round(con_10,3),z_10))%>%
  mutate(z_25=ifelse(con_25/sqrt(SE+SE[Method=="+25%"])>=1.645,"(*)","(n.s.)"))%>%
  mutate(con_25=paste(round(con_25,3),z_25))%>%
  mutate(z_minus_10=ifelse(con_minus_10/sqrt(SE+SE[Method=="-10%"])>=1.645,"(*)","(n.s.)"))%>%
  mutate(con_minus_10=paste(round(con_minus_10,3),z_minus_10))%>%
  mutate(z_minus_25=ifelse(con_minus_25/sqrt(SE+SE[Method=="-25%"])>=1.645,"(*)","(n.s.)"))%>%
  mutate(con_minus_25=paste(round(con_minus_25,3),z_minus_25))%>%
  dplyr::select(-z_max,-z_10,-z_25,-z_minus_10,-z_minus_25,-SE)%>%
  arrange(Species,Method)

p<-gs%>%
  filter(Species=="P. edulis")%>%
  ungroup()%>%
  dplyr::select(Species,Method,con_max,con_10,con_25,con_minus_10,con_minus_25)%>%
  dplyr::rename("Obs. Max"=con_max,"+10%"=con_10,"+25%"=con_25,"-10%"=con_minus_10,"-25%"=con_minus_25)%>%
   arrange(match(Method, c("Obs. Max","+10%","+25%","-10%","-25%")))
j<-gs%>%
  filter(Species=="J. monosperma")%>%
  ungroup()%>%
  dplyr::select(Species,Method,con_max,con_10,con_25,con_minus_10,con_minus_25)%>%
  dplyr::rename("Obs. Max"=con_max,"+10%"=con_10,"+25%"=con_25,"-10%"=con_minus_10,"-25%"=con_minus_25)%>%
   arrange(match(Method, c("Obs. Max","+10%","+25%","-10%","-25%")))
pj_Gslopes<-rbind(p,j)
# SIGNIFICANTLY DIFFERENT ALWAYS, EXCEPT OBS. MAX VS +10%


```

``` {r compare G and A sensitivity}
gs<-gsensitivity%>%
  mutate(Variable="Growth")
as<-asensitivity%>%
  mutate(Variable="Photosynthesis")
gas<-rbind(gs,as)

gse<-gse%>%
  mutate(Variable="Growth")
ase<-se%>%
  mutate(Species=ifelse(Species=="JUMO","J. monosperma","P. edulis"),Variable="Photosynthesis")
sem<-rbind(gse,ase)

gas_res<-gas%>%
  group_by(Method,Species)%>%
  mutate(xint_con=0)%>%
  mutate(contrast=abs(slope-slope[Variable=="Photosynthesis"]))%>%
  merge(.,sem)%>%
  mutate(z=ifelse(contrast/sqrt(SE+SE[Variable=="Photosynthesis"])>=1.645,"(*)","(n.s.)"))%>%
  mutate(contrast=paste(round(contrast,3),z))%>%
  dplyr::select(-z,-SE)%>%
  arrange(Species,Method)

tabsa1<-theme_vanilla(flextable(gas_res)) 



```

``` {r NSC sensitivity analysis}
# +-0
wp_nsc_0<-merge(NSC_new,watpot)%>%
  dplyr::mutate(Ypd=abs(Ypd))%>%
  dplyr::group_by(ID,Tissue)%>%
  dplyr::mutate(maxNSC=max(wt_NSC)+(max(wt_NSC)))%>%
  dplyr::mutate(maxSugar=max(wt_sugar)+(max(wt_sugar)))%>%
  dplyr::mutate(maxStarch=max(wt_starch)+(max(wt_starch)))%>%
  dplyr::mutate(NSC=(wt_NSC/maxNSC)*100)%>%
  dplyr::mutate(Sugar=(wt_sugar/maxSugar)*100)%>%
  dplyr::mutate(Starch=(wt_starch/maxStarch)*100,Method="Obs. Max")%>%
  dplyr::filter(Tissue!="bole" & Tissue!="root")

# + 10
wp_nsc_10<-merge(NSC_new,watpot)%>%
  dplyr::mutate(Ypd=abs(Ypd))%>%
  dplyr::group_by(ID,Tissue)%>%
  dplyr::mutate(maxNSC=max(wt_NSC)+(0.1*max(wt_NSC)))%>%
  dplyr::mutate(maxSugar=max(wt_sugar)+(0.1*max(wt_sugar)))%>%
  dplyr::mutate(maxStarch=max(wt_starch)+(0.1*max(wt_starch)))%>%
  dplyr::mutate(NSC=(wt_NSC/maxNSC)*100)%>%
  dplyr::mutate(Sugar=(wt_sugar/maxSugar)*100)%>%
  dplyr::mutate(Starch=(wt_starch/maxStarch)*100,Method="+10%")%>%
  dplyr::filter(Tissue!="bole" & Tissue!="root")


# - 10
wp_nsc_m10<-merge(NSC_new,watpot)%>%
  dplyr::mutate(Ypd=abs(Ypd))%>%
  dplyr::group_by(ID,Tissue)%>%
  dplyr::mutate(maxNSC=max(wt_NSC)-(0.1*max(wt_NSC)))%>%
  dplyr::mutate(maxSugar=max(wt_sugar)-(0.1*max(wt_sugar)))%>%
  dplyr::mutate(maxStarch=max(wt_starch)-(0.1*max(wt_starch)))%>%
  dplyr::mutate(NSC=(wt_NSC/maxNSC)*100)%>%
  dplyr::mutate(Sugar=(wt_sugar/maxSugar)*100)%>%
  dplyr::mutate(Starch=(wt_starch/maxStarch)*100,Method="-10%")%>%
  dplyr::filter(Tissue!="bole" & Tissue!="root")

# + 25
wp_nsc_25<-merge(NSC_new,watpot)%>%
  dplyr::mutate(Ypd=abs(Ypd))%>%
  dplyr::group_by(ID,Tissue)%>%
  dplyr::mutate(maxNSC=max(wt_NSC)+(0.25*max(wt_NSC)))%>%
  dplyr::mutate(maxSugar=max(wt_sugar)+(0.25*max(wt_sugar)))%>%
  dplyr::mutate(maxStarch=max(wt_starch)+(0.25*max(wt_starch)))%>%
  dplyr::mutate(NSC=(wt_NSC/maxNSC)*100)%>%
  dplyr::mutate(Sugar=(wt_sugar/maxSugar)*100)%>%
  dplyr::mutate(Starch=(wt_starch/maxStarch)*100,Method="+25%")%>%
  dplyr::filter(Tissue!="bole" & Tissue!="root")

# -25
wp_nsc_m25<-merge(NSC_new,watpot)%>%
  dplyr::mutate(Ypd=abs(Ypd))%>%
  dplyr::group_by(ID,Tissue)%>%
  dplyr::mutate(maxNSC=max(wt_NSC)-(0.25*max(wt_NSC)))%>%
  dplyr::mutate(maxSugar=max(wt_sugar)-(0.25*max(wt_sugar)))%>%
  dplyr::mutate(maxStarch=max(wt_starch)-(0.25*max(wt_starch)))%>%
  dplyr::mutate(NSC=(wt_NSC/maxNSC)*100)%>%
  dplyr::mutate(Sugar=(wt_sugar/maxSugar)*100)%>%
  dplyr::mutate(Starch=(wt_starch/maxStarch)*100,Method="-25%")%>%
  dplyr::filter(Tissue!="bole" & Tissue!="root")

wp_fin<-rbind(wp_nsc_0,wp_nsc_10,wp_nsc_m10,wp_nsc_25,wp_nsc_m25)%>%
  ungroup()%>%
  dplyr::select(Species,Ypd,NSC,Sugar,Starch,Method)%>%
  pivot_longer(cols=c('NSC','Sugar','Starch'),names_to="Variable",values_to="pct")# make the data long to make regressions easier
wp_fin$Species<-as.factor(wp_fin$Species)
wp_fin$Method<-as.factor(wp_fin$Method)
wp_fin$Variable<-as.factor(wp_fin$Variable)


SE<-wp_fin %>%
  group_by(Species,Method,Variable) %>%
  do(data.frame(SE = summary(lm(pct~log(abs(Ypd)),.))$coefficients[2,2]))
yint_nsc<-wp_fin %>%
  group_by(Species,Method,Variable) %>%
  do(data.frame(y_intercept = coef(lm(pct~log(abs(Ypd)),.))[1]))
slope_nsc<-wp_fin %>%
  group_by(Species,Method,Variable) %>%
  do(data.frame(slope = coef(lm(pct~log(abs(Ypd)),.))[2]))
nsc_s<-merge(slope_nsc,yint_nsc)%>%
  merge(.,SE)%>%
  mutate(xint=-(y_intercept)/slope)%>%
  mutate(xint=exp(xint))%>%
  dplyr::select(Species,Method,Variable,xint,slope,SE)
# so again, x-intercepts remain unchanged, slopes are different

# let's test if the slopes are significantly different 
nsc_SA<-nsc_s%>%
  mutate(xint_con=0)%>%
  group_by(Species,Variable)%>%
  mutate("0"=abs(slope-slope[Method=="Obs. Max"]))%>%
  mutate("+10"=abs(slope-slope[Method=="+10%"]))%>%
  mutate("-10"=abs(slope-slope[Method=="-10%"]))%>%
  mutate("+25"=abs(slope-slope[Method=="+25%"]))%>%
  mutate("-25"=abs(slope-slope[Method=="-25%"]))%>%
  pivot_longer(cols=c("0","+10","-10","+25","-25"), names_to="Comparison",values_to="Contrast")%>%
  group_by(Species,Variable,Comparison)%>%
  mutate(z=ifelse(Contrast/sqrt(SE+SE[Comparison!=Method])>=1.645,"(*)","(n.s.)"))%>%
  mutate(Contrast=paste(round(Contrast,3),z))%>%
  dplyr::select(-z,-SE,-xint,-xint_con)

tabsa3<-theme_vanilla(flextable(nsc_SA))
```

``` {r NSC sensitivity Figures}
nsc10<-wp_nsc_10%>%
  ungroup()%>%
  dplyr::select(Species,Ypd,NSC,Sugar,Starch)%>%
  pivot_longer(cols=c(NSC,Sugar,Starch),names_to="Variable",values_to="pct_max")

nsc10_p<-ggplot(data=nsc10,aes(Ypd,pct_max,color=Variable)) + 
  geom_point(alpha=0.5) + geom_smooth(method="lm",formula=y~log(x),se=TRUE) + ylab("% of Maximum") + 
  xlab("Predawn Water Potential (-MPa)") +
  scale_color_manual(values=c("Starch"="#FDEA72","Sugar"="#9BE6EF"))  + 
  theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(strip.text.x = element_text(
        size = 20, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + labs(color="Component")+  theme(text = element_text(
        size = 15, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + theme(legend.title = element_blank()) + facet_wrap(~Species,scales="free")

nscm10<-wp_nsc_m10%>%
  ungroup()%>%
  dplyr::select(Species,Ypd,NSC,Sugar,Starch)%>%
  pivot_longer(cols=c(NSC,Sugar,Starch),names_to="Variable",values_to="pct_max")

nscm10_p<-ggplot(data=nscm10,aes(Ypd,pct_max,color=Variable)) + 
  geom_point(alpha=0.5) + geom_smooth(method="lm",formula=y~log(x),se=TRUE) + ylab("% of Maximum") + 
  xlab("Predawn Water Potential (-MPa)") +
  scale_color_manual(values=c("Starch"="#FDEA72","Sugar"="#9BE6EF"))  + 
  theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(strip.text.x = element_text(
        size = 20, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + labs(color="Component")+  theme(text = element_text(
        size = 15, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + theme(legend.title = element_blank()) + facet_wrap(~Species,scales="free")

nsc25<-wp_nsc_25%>%
  ungroup()%>%
  dplyr::select(Species,Ypd,NSC,Sugar,Starch)%>%
  pivot_longer(cols=c(NSC,Sugar,Starch),names_to="Variable",values_to="pct_max")

nsc25_p<-ggplot(data=nsc25,aes(Ypd,pct_max,color=Variable)) + 
  geom_point(alpha=0.5) + geom_smooth(method="lm",formula=y~log(x),se=TRUE) + ylab("% of Maximum") + 
  xlab("Predawn Water Potential (-MPa)") +
  scale_color_manual(values=c("Starch"="#FDEA72","Sugar"="#9BE6EF"))  + 
  theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(strip.text.x = element_text(
        size = 20, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + labs(color="Component")+  theme(text = element_text(
        size = 15, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + theme(legend.title = element_blank()) + facet_wrap(~Species,scales="free")

nscm25<-wp_nsc_m25%>%
  ungroup()%>%
  dplyr::select(Species,Ypd,NSC,Sugar,Starch)%>%
  pivot_longer(cols=c(NSC,Sugar,Starch),names_to="Variable",values_to="pct_max")

nscm25_p<-ggplot(data=nscm25,aes(Ypd,pct_max,color=Variable)) + 
  geom_point(alpha=0.5) + geom_smooth(method="lm",formula=y~log(x),se=TRUE) + ylab("% of Maximum") + 
  xlab("Predawn Water Potential (-MPa)") +
  scale_color_manual(values=c("Starch"="#FDEA72","Sugar"="#9BE6EF"))  + 
  theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(strip.text.x = element_text(
        size = 20, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + labs(color="Component")+  theme(text = element_text(
        size = 15, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + theme(legend.title = element_blank()) + facet_wrap(~Species,scales="free")

nsc_var<-ggarrange(nsc10_p,nscm10_p,nsc25_p,nscm25_p,ncol=1,labels=c("A: +10%","B: -10%","C: -25%", "D: -25%"))

```

``` {r NSC sensitivity Fig. 1}
# make a revised figure 1 with associated G and A changes
wpg<-rbind(g_all,wp_all)%>%
  mutate(Ypd=abs(Ypd),Species=ifelse(Species=="JUMO","J. monosperma","P. edulis"))%>%
  rbind(.,wp_fin)%>%
  filter(Variable!="Sugar",Variable!="Starch",Method!="Obs. Max")

fig1SA<-ggplot(wpg,aes(Ypd,pct)) +
  geom_smooth(method="lm",formula=y~log(x),se=TRUE,aes(x=abs(Ypd),y=pct,color=Variable),fullrange=TRUE) + 
  ylab("% of Maximum") + 
  xlab("Predawn Water Potential (-MPa)") + 
  scale_x_continuous(guide = guide_axis(check.overlap = TRUE),limits=c(1,4),breaks=c(1,2,3,4)) +
  scale_color_manual(values=c("Photosynthesis"="#5b859e","Growth"="#df8d71","NSC"="grey")) +
  theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  
  theme(text = element_text(
        size = 21, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
  theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   )   + 
  ylim(-10,100) + geom_hline(yintercept=0,linetype="dotted") + 
  theme(text = element_text(
        size = 15, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + 
  theme(legend.title = element_blank()) + 
  theme(plot.title = element_text(size = 12, face = "italic",hjust=0.5,vjust=-0.2)) +
  facet_wrap(Species~Method,scales="free",ncol=2)

```

``` {r Fig. 2 sensitivity}
# redo all analyses for figure 2 with updates
g<-rbind(g10,gm10,g25,gm25)%>%
  dplyr::select(ID,Year,Month,Species,pct_growth,Ypd,Method)%>%
  dplyr::rename(Growth=pct_growth)%>%
  distinct()
a<-rbind(wp10,wpm10,wp25,wpm25)%>%
  dplyr::select(ID,Year,Month,Species,pct_photo,Ypd,Method)%>%
  dplyr::rename(Photosynthesis=pct_photo)%>%
  distinct()
ga<-merge(a,g)%>%
  mutate(Species=ifelse(Species=="JUMO","J. monosperma","P. edulis"),Ypd=abs(Ypd))
ga$Month<-gsub("0","",ga$Month)
ga$Month<-as.numeric(ga$Month)


gap<-ggplot(ga,aes(Photosynthesis,Growth,color=Species)) +
  geom_point() +
  geom_smooth(method="lm") +
  facet_wrap(Species~Method,ncol=2,scales="free") +
  theme_minimal()

```

``` {r PCA sensitivity}
# redo the PCA with SA data
# make a master file with all sensitivity analyses
# take original files and merge across
g<-rbind(g10,gm10,g25,gm25)%>%
  dplyr::select(ID,Year,Month,Species,pct_growth,Ypd,Method)%>%
  rename(Growth=pct_growth)%>%
  distinct()
a<-rbind(wp10,wpm10,wp25,wpm25)%>%
  dplyr::select(ID,Year,Month,Species,pct_photo,Ypd,Method)%>%
  rename(Photosynthesis=pct_photo)%>%
  distinct()
ga<-merge(a,g)%>%
  mutate(Species=ifelse(Species=="JUMO","J. monosperma","P. edulis"),Ypd=abs(Ypd))
ga$Month<-gsub("0","",ga$Month)
ga$Month<-as.numeric(ga$Month)

nsc<-rbind(wp_nsc_10,wp_nsc_m10,wp_nsc_25,wp_nsc_m25)%>%
  ungroup()%>%
  dplyr::select(ID,Year,Month,Species,NSC,Sugar,Starch,Ypd,Method)%>%
  distinct()%>%
  filter(Year>=2013,Year<=2014)
nsc$Month<-as.numeric(nsc$Month)

gansc<-merge(nsc,ga)

thetaSA <- gansc%>%
  group_by(Species,Method)%>%
  mutate(theta=acos( sum(Growth*Photosynthesis) / ( sqrt(sum(Growth * Growth)) * sqrt(sum(Photosynthesis * Photosynthesis)) ) ))%>%
  dplyr::select(Species,Method,theta)%>%
  distinct()%>%
  rename(Theta=theta)
theta_tab<-theme_vanilla(flextable(thetaSA))

# 10% PCA
pca10<-prcomp(~Growth+Photosynthesis+NSC+Sugar+Starch+Ypd,data=subset(gansc,Method=="+10%"),center=TRUE,scale.=TRUE)
summary(pca) # PC1, PC2, PC3 explain 83% of variance
pca10
pca_sum<-unclass(summary(pca10))$importance
pca_sum<-as.data.frame(pca_sum)
pca_sum10<-pca_sum%>%
  add_rownames()%>%
  mutate(Method="+10%")
pca_tab<-as.data.frame(pca10$rotation)
pca_tab10<-pca_tab%>%
  add_rownames()%>%
  mutate(Method="+10%")

#-10% PCA
pcam10<-prcomp(~Growth+Photosynthesis+NSC+Sugar+Starch+Ypd,data=subset(gansc,Method=="-10%"),center=TRUE,scale.=TRUE)
summary(pca) # PC1, PC2, PC3 explain 83% of variance
pcam10
pca_sum<-unclass(summary(pcam10))$importance
pca_sum<-as.data.frame(pca_sum)
pca_summ10<-pca_sum%>%
  add_rownames()%>%
  mutate(Method="-10%")
pca_tab<-as.data.frame(pcam10$rotation)
pca_tabm10<-pca_tab%>%
  add_rownames()%>%
  mutate(Method="-10%")

# 25% PCA
pca25<-prcomp(~Growth+Photosynthesis+NSC+Sugar+Starch+Ypd,data=subset(gansc,Method=="+25%"),center=TRUE,scale.=TRUE)
summary(pca25) # PC1, PC2, PC3 explain 83% of variance
pca25
pca_sum<-unclass(summary(pca25))$importance
pca_sum<-as.data.frame(pca_sum)
pca_sum25<-pca_sum%>%
  add_rownames()%>%
  mutate(Method="+25%")
pca_tab<-as.data.frame(pca25$rotation)
pca_tab25<-pca_tab%>%
  add_rownames()%>%
  mutate(Method="+25%")


# -25% PCA
pcam25<-prcomp(~Growth+Photosynthesis+NSC+Sugar+Starch+Ypd,data=subset(gansc,Method=="-25%"),center=TRUE,scale.=TRUE)
summary(pcam25) # PC1, PC2, PC3 explain 83% of variance
pcam25
pca_sum<-unclass(summary(pcam25))$importance
pca_sum<-as.data.frame(pca_sum)
pca_summ25<-pca_sum%>%
  add_rownames()%>%
  mutate(Method="-25%")
pca_tab<-as.data.frame(pcam25$rotation)
pca_tabm25<-pca_tab%>%
  add_rownames()%>%
  mutate(Method="-25%")


sum<-rbind(pca_sum10,pca_summ10,pca_sum25,pca_summ25)
pca_sum<-flextable(sum)
#pca_kab<-kbl(pca_tab)%>%
 #  kable_classic() %>%
  # kable_styling(bootstrap_options = "striped", font_size = 20)
tab<-rbind(pca_tab10,pca_tabm10,pca_tab25,pca_tabm25)
pca_tab<-flextable(tab)




```

``` {r PCA SA figs}
library(ggbiplot)

pca10_plot<-ggbiplot::ggbiplot(pca10,ellipse=TRUE,var.axes = TRUE,varname.size=4,alpha=0.3) + ylab("PC2 (27.8%)") +  xlab("PC1 (32.6%)") + scale_x_continuous(guide = guide_axis(check.overlap = TRUE),limits=c(-3,3),breaks=c(-3,-2,-1,0,1,2,3)) + scale_y_continuous(guide = guide_axis(check.overlap = TRUE),limits=c(-2.5,2.5),breaks=c(-2.5,-2,-1,0,1,2,2.5)) + theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(text = element_text(
        size = 20, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + 
  theme(legend.title = element_blank()) 


pc1<-pca_tab10%>%
  dplyr::select(rowname,PC1)%>%
  dplyr::rename(Value=PC1)%>%
  dplyr::mutate(Variable="PC1")
pc2<-pca_tab10%>%
  dplyr::select(rowname,PC2)%>%
  dplyr::rename(Value=PC2)%>%
  dplyr::mutate(Variable="PC2")
pc3<-pca_tab10%>%
  dplyr::select(rowname,PC3)%>%
  dplyr::rename(Value=PC3)%>%
  dplyr::mutate(Variable="PC3")
pc4<-pca_tab10%>%
  dplyr::select(rowname,PC4)%>%
  dplyr::rename(Value=PC4)%>%
  dplyr::mutate(Variable="PC4")
pc5<-pca_tab10%>%
  dplyr::select(rowname,PC5)%>%
  dplyr::rename(Value=PC5)%>%
  dplyr::mutate(Variable="PC5")
pc<-rbind(pc1,pc2,pc3,pc4,pc5)


pca_heat10<-ggplot(pc,aes(Variable,rowname)) + geom_tile(aes(fill=Value)) + geom_text(aes(label=round(Value,2))) + ylab("") +  xlab("Principal Component")  + theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(text = element_text(
        size = 20, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + guides(fill=guide_legend(title="Species"))+ 
  theme(legend.title = element_blank(),legend.text=element_text(size=12),
        plot.margin=unit(c(0.2,1,0.5,-0.5), "cm")) +
  scale_fill_gradientn(colours=hcl.colors(10,"Spectral"),guide="colourbar") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 10))

pc1<-pca_sum10%>%
  dplyr::filter(rowname=="Proportion of Variance")%>%
  dplyr::select(rowname,PC1)%>%
  dplyr::rename(Value=PC1)%>%
  dplyr::mutate(Variable="PC1")
pc2<-pca_sum10%>%
    dplyr::filter(rowname=="Proportion of Variance")%>%
  dplyr::select(rowname,PC2)%>%
  dplyr::rename(Value=PC2)%>%
  dplyr::mutate(Variable="PC2")
pc3<-pca_sum10%>%
    dplyr::filter(rowname=="Proportion of Variance")%>%
  dplyr::select(rowname,PC3)%>%
  dplyr::rename(Value=PC3)%>%
  dplyr::mutate(Variable="PC3")
pc4<-pca_sum10%>%
    dplyr::filter(rowname=="Proportion of Variance")%>%
  dplyr::select(rowname,PC4)%>%
  dplyr::rename(Value=PC4)%>%
  dplyr::mutate(Variable="PC4")
pc5<-pca_sum10%>%
    dplyr::filter(rowname=="Proportion of Variance")%>%
  dplyr::select(rowname,PC5)%>%
  dplyr::rename(Value=PC5)%>%
  dplyr::mutate(Variable="PC5")
screepc<-rbind(pc1,pc2,pc3,pc4,pc5)
  
scree10<-ggplot(screepc,aes(Variable,Value,group=rowname)) + 
  geom_bar(stat="identity",color="black",fill="white") + 
  xlab("") +
  ylab("% of Variance") + theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(text = element_text(
        size = 12, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + guides(fill=guide_legend(title="Species"))+ 
  theme(legend.title = element_blank(),
        axis.text.x=element_blank(),
        plot.margin=unit(c(1,1,-0.1,1), "cm"))

pcaplot<-pca10_plot+  theme(text = element_text(
        size = 15, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   )  


scree2<-ggarrange(NULL,scree10,NULL,ncol=3,widths = c(0.15,1.5,0.35))

pca_heat_scree<-ggarrange(scree2,pca_heat10,nrow=2,heights=c(0.2,0.5))
phs<-ggarrange(pca_heat_scree,heights=0.2)

p10<-ggarrange(phs,pcaplot,nrow=1,labels=c("A","B"))

# -10%
pcam10_plot<-ggbiplot::ggbiplot(pcam10,ellipse=TRUE,var.axes = TRUE,varname.size=4,alpha=0.3) + ylab("PC2 (27.8%)") +  xlab("PC1 (32.6%)") + scale_x_continuous(guide = guide_axis(check.overlap = TRUE),limits=c(-3,3),breaks=c(-3,-2,-1,0,1,2,3)) + scale_y_continuous(guide = guide_axis(check.overlap = TRUE),limits=c(-2.5,2.5),breaks=c(-2.5,-2,-1,0,1,2,2.5)) + theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(text = element_text(
        size = 20, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + 
  theme(legend.title = element_blank()) 


pc1<-pca_tabm10%>%
  dplyr::select(rowname,PC1)%>%
  dplyr::rename(Value=PC1)%>%
  dplyr::mutate(Variable="PC1")
pc2<-pca_tabm10%>%
  dplyr::select(rowname,PC2)%>%
  dplyr::rename(Value=PC2)%>%
  dplyr::mutate(Variable="PC2")
pc3<-pca_tabm10%>%
  dplyr::select(rowname,PC3)%>%
  dplyr::rename(Value=PC3)%>%
  dplyr::mutate(Variable="PC3")
pc4<-pca_tabm10%>%
  dplyr::select(rowname,PC4)%>%
  dplyr::rename(Value=PC4)%>%
  dplyr::mutate(Variable="PC4")
pc5<-pca_tabm10%>%
  dplyr::select(rowname,PC5)%>%
  dplyr::rename(Value=PC5)%>%
  dplyr::mutate(Variable="PC5")
pc<-rbind(pc1,pc2,pc3,pc4,pc5)


pca_heatm10<-ggplot(pc,aes(Variable,rowname)) + geom_tile(aes(fill=Value)) + geom_text(aes(label=round(Value,2))) + ylab("") +  xlab("Principal Component")  + theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(text = element_text(
        size = 20, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + guides(fill=guide_legend(title="Species"))+ 
  theme(legend.title = element_blank(),legend.text=element_text(size=12),
        plot.margin=unit(c(0.2,1,0.5,-0.5), "cm")) +
  scale_fill_gradientn(colours=hcl.colors(10,"Spectral"),guide="colourbar") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 10))

pc1<-pca_summ10%>%
  dplyr::filter(rowname=="Proportion of Variance")%>%
  dplyr::select(rowname,PC1)%>%
  dplyr::rename(Value=PC1)%>%
  dplyr::mutate(Variable="PC1")
pc2<-pca_sum10%>%
    dplyr::filter(rowname=="Proportion of Variance")%>%
  dplyr::select(rowname,PC2)%>%
  dplyr::rename(Value=PC2)%>%
  dplyr::mutate(Variable="PC2")
pc3<-pca_summ10%>%
    dplyr::filter(rowname=="Proportion of Variance")%>%
  dplyr::select(rowname,PC3)%>%
  dplyr::rename(Value=PC3)%>%
  dplyr::mutate(Variable="PC3")
pc4<-pca_summ10%>%
    dplyr::filter(rowname=="Proportion of Variance")%>%
  dplyr::select(rowname,PC4)%>%
  dplyr::rename(Value=PC4)%>%
  dplyr::mutate(Variable="PC4")
pc5<-pca_summ10%>%
    dplyr::filter(rowname=="Proportion of Variance")%>%
  dplyr::select(rowname,PC5)%>%
  dplyr::rename(Value=PC5)%>%
  dplyr::mutate(Variable="PC5")
screepc<-rbind(pc1,pc2,pc3,pc4,pc5)
  
screem10<-ggplot(screepc,aes(Variable,Value,group=rowname)) + 
  geom_bar(stat="identity",color="black",fill="white") + 
  xlab("") +
  ylab("% of Variance") + theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(text = element_text(
        size = 12, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + guides(fill=guide_legend(title="Species"))+ 
  theme(legend.title = element_blank(),
        axis.text.x=element_blank(),
        plot.margin=unit(c(1,1,-0.1,1), "cm"))

pcaplot<-pcam10_plot+  theme(text = element_text(
        size = 15, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   )  


scree2<-ggarrange(NULL,screem10,NULL,ncol=3,widths = c(0.15,1.5,0.35))

pca_heat_scree<-ggarrange(scree2,pca_heatm10,nrow=2,heights=c(0.2,0.5))
phsm10<-ggarrange(pca_heat_scree,heights=0.2)

pm10<-ggarrange(phs,pcaplot,nrow=1,labels=c("A","B"))

# +25%
pca25_plot<-ggbiplot::ggbiplot(pca25,ellipse=TRUE,var.axes = TRUE,varname.size=4,alpha=0.3) + ylab("PC2 (27.8%)") +  xlab("PC1 (32.6%)") + scale_x_continuous(guide = guide_axis(check.overlap = TRUE),limits=c(-3,3),breaks=c(-3,-2,-1,0,1,2,3)) + scale_y_continuous(guide = guide_axis(check.overlap = TRUE),limits=c(-2.5,2.5),breaks=c(-2.5,-2,-1,0,1,2,2.5)) + theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(text = element_text(
        size = 20, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + 
  theme(legend.title = element_blank()) 


pc1<-pca_tab25%>%
  dplyr::select(rowname,PC1)%>%
  dplyr::rename(Value=PC1)%>%
  dplyr::mutate(Variable="PC1")
pc2<-pca_tab25%>%
  dplyr::select(rowname,PC2)%>%
  dplyr::rename(Value=PC2)%>%
  dplyr::mutate(Variable="PC2")
pc3<-pca_tab25%>%
  dplyr::select(rowname,PC3)%>%
  dplyr::rename(Value=PC3)%>%
  dplyr::mutate(Variable="PC3")
pc4<-pca_tab25%>%
  dplyr::select(rowname,PC4)%>%
  dplyr::rename(Value=PC4)%>%
  dplyr::mutate(Variable="PC4")
pc5<-pca_tab25%>%
  dplyr::select(rowname,PC5)%>%
  dplyr::rename(Value=PC5)%>%
  dplyr::mutate(Variable="PC5")
pc<-rbind(pc1,pc2,pc3,pc4,pc5)


pca_heat25<-ggplot(pc,aes(Variable,rowname)) + geom_tile(aes(fill=Value)) + geom_text(aes(label=round(Value,2))) + ylab("") +  xlab("Principal Component")  + theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(text = element_text(
        size = 20, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + guides(fill=guide_legend(title="Species"))+ 
  theme(legend.title = element_blank(),legend.text=element_text(size=12),
        plot.margin=unit(c(0.2,1,0.5,-0.5), "cm")) +
  scale_fill_gradientn(colours=hcl.colors(10,"Spectral"),guide="colourbar") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 10))

pc1<-pca_sum25%>%
  dplyr::filter(rowname=="Proportion of Variance")%>%
  dplyr::select(rowname,PC1)%>%
  dplyr::rename(Value=PC1)%>%
  dplyr::mutate(Variable="PC1")
pc2<-pca_sum25%>%
    dplyr::filter(rowname=="Proportion of Variance")%>%
  dplyr::select(rowname,PC2)%>%
  dplyr::rename(Value=PC2)%>%
  dplyr::mutate(Variable="PC2")
pc3<-pca_sum25%>%
    dplyr::filter(rowname=="Proportion of Variance")%>%
  dplyr::select(rowname,PC3)%>%
  dplyr::rename(Value=PC3)%>%
  dplyr::mutate(Variable="PC3")
pc4<-pca_sum25%>%
    dplyr::filter(rowname=="Proportion of Variance")%>%
  dplyr::select(rowname,PC4)%>%
  dplyr::rename(Value=PC4)%>%
  dplyr::mutate(Variable="PC4")
pc5<-pca_sum25%>%
    dplyr::filter(rowname=="Proportion of Variance")%>%
  dplyr::select(rowname,PC5)%>%
  dplyr::rename(Value=PC5)%>%
  dplyr::mutate(Variable="PC5")
screepc<-rbind(pc1,pc2,pc3,pc4,pc5)
  
scree25<-ggplot(screepc,aes(Variable,Value,group=rowname)) + 
  geom_bar(stat="identity",color="black",fill="white") + 
  xlab("") +
  ylab("% of Variance") + theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(text = element_text(
        size = 12, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + guides(fill=guide_legend(title="Species"))+ 
  theme(legend.title = element_blank(),
        axis.text.x=element_blank(),
        plot.margin=unit(c(1,1,-0.1,1), "cm"))

pcaplot<-pca25_plot+  theme(text = element_text(
        size = 15, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   )  


scree2<-ggarrange(NULL,scree10,NULL,ncol=3,widths = c(0.15,1.5,0.35))

pca_heat_scree<-ggarrange(scree2,pca_heat25,nrow=2,heights=c(0.2,0.5))
phs<-ggarrange(pca_heat_scree,heights=0.2)

p25<-ggarrange(phs,pcaplot,nrow=1,labels=c("A","B")) 


# -25%
pcam25_plot<-ggbiplot::ggbiplot(pcam25,ellipse=TRUE,var.axes = TRUE,varname.size=4,alpha=0.3) + ylab("PC2 (27.8%)") +  xlab("PC1 (32.6%)") + scale_x_continuous(guide = guide_axis(check.overlap = TRUE),limits=c(-3,3),breaks=c(-3,-2,-1,0,1,2,3)) + scale_y_continuous(guide = guide_axis(check.overlap = TRUE),limits=c(-2.5,2.5),breaks=c(-2.5,-2,-1,0,1,2,2.5)) + theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(text = element_text(
        size = 20, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + 
  theme(legend.title = element_blank()) 


pc1<-pca_tabm25%>%
  dplyr::select(rowname,PC1)%>%
  dplyr::rename(Value=PC1)%>%
  dplyr::mutate(Variable="PC1")
pc2<-pca_tabm25%>%
  dplyr::select(rowname,PC2)%>%
  dplyr::rename(Value=PC2)%>%
  dplyr::mutate(Variable="PC2")
pc3<-pca_tabm25%>%
  dplyr::select(rowname,PC3)%>%
  dplyr::rename(Value=PC3)%>%
  dplyr::mutate(Variable="PC3")
pc4<-pca_tabm25%>%
  dplyr::select(rowname,PC4)%>%
  dplyr::rename(Value=PC4)%>%
  dplyr::mutate(Variable="PC4")
pc5<-pca_tabm25%>%
  dplyr::select(rowname,PC5)%>%
  dplyr::rename(Value=PC5)%>%
  dplyr::mutate(Variable="PC5")
pc<-rbind(pc1,pc2,pc3,pc4,pc5)


pca_heatm25<-ggplot(pc,aes(Variable,rowname)) + geom_tile(aes(fill=Value)) + geom_text(aes(label=round(Value,2))) + ylab("") +  xlab("Principal Component")  + theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(text = element_text(
        size = 20, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + guides(fill=guide_legend(title="Species"))+ 
  theme(legend.title = element_blank(),legend.text=element_text(size=12),
        plot.margin=unit(c(0.2,1,0.5,-0.5), "cm")) +
  scale_fill_gradientn(colours=hcl.colors(10,"Spectral"),guide="colourbar") + guides(fill = guide_colourbar(barwidth = 0.5, barheight = 10))

pc1<-pca_summ25%>%
  dplyr::filter(rowname=="Proportion of Variance")%>%
  dplyr::select(rowname,PC1)%>%
  dplyr::rename(Value=PC1)%>%
  dplyr::mutate(Variable="PC1")
pc2<-pca_summ25%>%
    dplyr::filter(rowname=="Proportion of Variance")%>%
  dplyr::select(rowname,PC2)%>%
  dplyr::rename(Value=PC2)%>%
  dplyr::mutate(Variable="PC2")
pc3<-pca_summ25%>%
    dplyr::filter(rowname=="Proportion of Variance")%>%
  dplyr::select(rowname,PC3)%>%
  dplyr::rename(Value=PC3)%>%
  dplyr::mutate(Variable="PC3")
pc4<-pca_summ25%>%
    dplyr::filter(rowname=="Proportion of Variance")%>%
  dplyr::select(rowname,PC4)%>%
  dplyr::rename(Value=PC4)%>%
  dplyr::mutate(Variable="PC4")
pc5<-pca_summ25%>%
    dplyr::filter(rowname=="Proportion of Variance")%>%
  dplyr::select(rowname,PC5)%>%
  dplyr::rename(Value=PC5)%>%
  dplyr::mutate(Variable="PC5")
screepc<-rbind(pc1,pc2,pc3,pc4,pc5)
  
screem25<-ggplot(screepc,aes(Variable,Value,group=rowname)) + 
  geom_bar(stat="identity",color="black",fill="white") + 
  xlab("") +
  ylab("% of Variance") + theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(text = element_text(
        size = 12, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + guides(fill=guide_legend(title="Species"))+ 
  theme(legend.title = element_blank(),
        axis.text.x=element_blank(),
        plot.margin=unit(c(1,1,-0.1,1), "cm"))


pcaplot<-pcam25_plot+  theme(text = element_text(
        size = 15, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   )  


scree2<-ggarrange(NULL,screem25,NULL,ncol=3,widths = c(0.15,1.5,0.35))

pca_heat_scree<-ggarrange(scree2,pca_heat25,nrow=2,heights=c(0.2,0.5))
phs<-ggarrange(pca_heat_scree,heights=0.2)

pm25<-ggarrange(phs,pcaplot,nrow=1,labels=c("A","B")) 



PCA1010<-ggarrange(p10,pm10,ncol=1,labels=c("+10%","-10%"))
PCA2525<-ggarrange(p25,pm25,ncol=1,labels=c("+25%","-25%"))





```

```{r NSC at Status, eval=FALSE, include=FALSE,results='asis'}

#nsc_at_status<-nsc_ypd_intercepts%>%
  #mutate(sink_source=ifelse(xint<xint_photo,1,0))
#status_1<-nsc_at_status%>%
 # filter(sink_source=="1")%>%
  #mutate(Status=ifelse(Ypd<=xint_photo, "Source", ifelse(Ypd>=xint, "No Limit", "Sink")))

#status_2<-nsc_at_status%>%
 # filter(sink_source=="0")%>%
  #mutate(Status=ifelse(Ypd<=xint_photo, "Source", ifelse(Ypd>=xint, "No Limit", "Sink")))
#nsc_at_status<-rbind(status_1,status_2)%>%
 # ungroup()%>%
  #filter(Tissue=="Leaf_Twig")%>%
  #select(-mean_ypd)%>%
  #drop_na()%>%
  #select(Species,ID,Treatment,Year,Month,Date,Sugar,NSC,Starch,Status,Ypd)

NSC_1.A$Month<-as.numeric(NSC_1.A$Month)
NSC.2A<-merge(NSC_1.A,wp) # combine % NSC with raw psi data

nsc_int<-merge(NSC.2A,intercepts)%>% # combine intercepts with tissue-level nsc / psi data
  distinct()
nsc_status<-nsc_int%>%
  mutate(xint_photo=-(xint_photo))%>%
  mutate(Status=ifelse(Ypd<=xint_photo, "Photosynthesis = 0", ifelse(Ypd>xint, "Not Limited","Growth = 0")))%>% # define when trees are below a certain water potential
  drop_na()%>%
  #mutate(szn=ifelse(Month=="6", "June - September",ifelse(Month=="7","June - September",ifelse(Month=="8","June - September",ifelse(Month=="9","June - September","October-May")))))%>% # define different NSC increase / decrease times
  dplyr::select(Species,ID,Tissue,Year,Month,pct_NSC,pct_sug,pct_starch,Ypd,Status)

nsc_status$Month<-as.numeric(nsc_status$Month)

NAS<-nsc_status%>% # create DF for figures - calculate means and sem
  dplyr::group_by(Species,Status,Tissue,)%>%
  dplyr::mutate(mean_NSC=mean(pct_NSC))%>%
  dplyr::mutate(sem_NSC=sem(pct_NSC))%>%
  dplyr::mutate(mean_sug=mean(pct_sug))%>%
  dplyr::mutate(sem_sug=sem(pct_sug))%>%
  dplyr::mutate(mean_starch=mean(pct_starch))%>%
  dplyr::mutate(sem_starch=sem(pct_starch))

NAS<-rbind(NAS,data.frame(Species="P. edulis",ID="30",Tissue="root",Year=2016,Month=3,pct_NSC=0,pct_sug=0,pct_starch=0,Ypd=0,Status="Growth = 0",mean_NSC=0,sem_NSC=0,mean_sug=0,sem_sug=0,mean_starch=0,sem_starch=0)) # this code creates a "fake" line of data so that bar width remains the same, and empty values are shown more clearly
NAS$Status = factor(NAS$Status, levels = c("Not Limited", "Growth = 0", "Photosynthesis = 0"), ordered = TRUE) # set factor levels so data is presented in order of no limit, growth, and photosynthesis 


positions<-c("Not Limited","Growth = 0", "Photosynthesis = 0")


# NEED TO: 1.) reorder bars as non, growth, photosynthesis; 2.) fix the error bar issue with P. edulis root
# FIGURE 3 B, C, D
nsc_bar<-ggplot(NAS,aes(Species,mean_NSC,fill=Status)) + geom_bar(stat="summary",position="dodge",colour="white") + 
  geom_errorbar(stat="identity",aes(ymin=mean_NSC-sem_NSC, ymax=mean_NSC+sem_NSC,group=Status),position=position_dodge(.9),width=.0) + ylab("% of Maximum NSC")+ scale_x_discrete(guide = guide_axis(check.overlap = TRUE)) +  scale_fill_manual(name="Limitation Type", ,values=wes_palette("Zissou1",n=6,type='continuous')) + theme(axis.text.x = element_text(angle = 90),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + facet_wrap(~Tissue)  +  theme(strip.text.x = element_text(
        size = 12, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) 
ylim(0,11)

ss_bar<-ggplot(NAS,aes(Species,mean_sug,fill=Status)) + geom_bar(stat="summary",position = "dodge",colour="white") +
  geom_errorbar(stat="identity",aes(ymin=mean_sug-sem_sug, ymax=mean_sug+sem_sug), width=.0,position=position_dodge(.9)) + ylab("% of Maximum Sugar")+ scale_x_discrete(drop=FALSE,guide = guide_axis(check.overlap = TRUE)) +  scale_fill_manual(name="Limitation Type",values=wes_palette("Zissou1",n=6,type='continuous')) + theme(axis.text.x = element_text(angle = 90),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + facet_wrap(~Tissue)  +  theme(strip.text.x = element_text(
        size = 12, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) 
ylim(0,11)

starch_bar<-ggplot(NAS,aes(Species,mean_starch,fill=Status)) + geom_bar(stat="summary",position = "dodge",colour="white") +
  geom_errorbar(stat="identity",aes(ymin=mean_starch-sem_starch, ymax=mean_starch+sem_starch), width=.0,position=position_dodge(.9)) + ylab("% of Maximum Starch")+ scale_x_discrete(drop=FALSE,guide = guide_axis(check.overlap = TRUE)) +  scale_fill_manual(name="Limitation Type",values=wes_palette("Zissou1",n=6,type='continuous')) + theme(axis.text.x = element_text(angle = 90),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + facet_wrap(~Tissue)  +  theme(strip.text.x = element_text(
        size = 12, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) 
ylim(0,11)


```

``` {r NSC at Status Statistics,eval=FALSE, include=FALSE,results='asis'}
# first check normality for ANOVA
NAS$pct_NSC<-as.numeric(NAS$pct_NSC)
nsc_qqplot<-ggplot(NAS,aes(sample=pct_NSC)) + geom_qq() + geom_qq_line() + facet_wrap(Status~Species)
nsc_hist<-ggplot(NAS,aes(pct_NSC)) + geom_histogram() + facet_wrap(Status~Species)
# data does not appear to be normal 
# there are also very few observations during sink and source limitation. What do we do with that?!
# run mixed-effects model with poly(Month) 
ctrl=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=100000))
library(lmerTest)
NSC.lme<-lmer(pct_NSC~poly(Month,3)*Status*Species*Tissue*(1|ID),data=NAS,control=ctrl) 
nsc_tab<-tab_model(NSC.lme, 
                   terms=NULL,
                  dv.labels= "Effects of Water Stress on Total NSC")
# the only significant effect was for pinon leaf
ss.lme<-lmer(pct_sug~poly(Month,3)*Status*Species*Tissue*(1|ID),data=NAS,control=ctrl) 
ss_tab<-tab_model(ss.lme, 
                   terms=NULL,
                  dv.labels= "Effects of Water Stress on Total Soluble Sugars")
st.lme<-lmer(pct_starch~poly(Month,3)*Status*Species*Tissue*(1|ID),data=NAS,control=ctrl) 
st_tab<-tab_model(st.lme, 
                   terms=NULL,
                  dv.labels= "Effects of Water Stress on Total Starch")
# run ANOVA on mixed effects model
# NOT NECESSARY GIVEN ABOVE RESULTS FROM LME tables
nsc_anova<-aov(NSC.lme)
summary(nsc_anova)
nsc_aov<-anova(NSC.lme,data=NAS)
nsc_aov
nsc_status<-aov(pct_NSC~Status*Species*Tissue*szn,data=NAS)
plot(nsc_status)
summary(nsc_status)
nsc_post<-TukeyHSD(nsc_status,'Status:Species:Tissue:szn',ordered=TRUE)
nscresults<-tidy(nsc_post)%>%
  filter(adj.p.value<=0.1)%>%
  dplyr::select(contrast,adj.p.value)

ss_aov<-anova(ss.lme,data=NAS)
ss_aov<-aov(pct_sug~Status*Species*Tissue*szn,data=NAS)
summary(ss_aov)
ss_post<-TukeyHSD(ss_aov,'Status:Species:Tissue:szn')
ssresults<-tidy(ss_post)%>%
  filter(adj.p.value<=0.1)%>%
  dplyr::select(contrast,adj.p.value)

st_aov<-anova(st.lme,data=NAS)
st_aov
st_aov<-aov(pct_starch~Status*Species*Tissue*szn,data=NAS)
summary(st_aov)
st_post<-TukeyHSD(st_aov,'Status:Species:Tissue:szn')
stresults<-tidy(st_post)%>%
  filter(adj.p.value<=0.1)%>%
  dplyr::select(contrast,adj.p.value)

# NEED TO EXPORT ALL OF THESE TABLES

# these results are suggestive of a lack of NSC accumulation during sink limitation. Or rather, sink limitation is a poor predictor of NSC because the only significant effects are driven by changes in sugar during the monsoon season when NSC is already at it's highest / increasing.
```

``` {r predicted NSC, include=FALSE, eval=FALSE,results='asis'}
# first build the general model for each tree and test it against observed data
models<-mv%>%
  group_by(Species,Component)%>%
  do(fit=lm(pct~exp(-Ypd),data=.)) # run an exponential model for each Species and component combination (makes df of lists for each Species)
# now, we use the interval data for growth, first, to predict NSC at each growth interval
nsc_growth<-growth_int%>%
  dplyr::rename(Ypd=pred_Ypd)%>% # match the newdata column to original data name
  group_by(Species)%>% # group by species, since thresholds are at species level. Should I try it at individual level?
  nest()%>% # collapses data by grouping variable (Species) so I can combine with model list dataframe
  full_join(models)%>% # combine models list and new data
  group_by(Species,Component)%>% # group by species and component 
  do(pred_pct=augment(.$fit[[1]], newdata = .$data[[1]]))%>% # predict NSC at each growth interval based on the water potential and NSC relationship derived in the "models" dataframe above
  unnest() # flatten data out to plot
# now plot the data to see how it looks. Make sense?
growth_nsc_plot<-ggplot(nsc_growth,aes(interval,.fitted,color=Component,shape=Component,group=Component)) + labs(x="% of Maximum Growth",y="% of Maximum NSC (Predicted)") +  geom_smooth(stat="smooth",method="gam",formula=y~s(log(x),bs="cs",k=8),se=TRUE) + facet_wrap(~Species,scale="free",ncol=1) + scale_y_continuous(guide = guide_axis(check.overlap = TRUE),limits=c(0.2,0.8),breaks=c(0.2,0.3,0.4,0.5,0.6,0.7,0.8)) + scale_x_discrete(guide = guide_axis(check.overlap = TRUE)) +  scale_color_manual(values=wes_palette("Zissou1",n=3,type='continuous')) + theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(strip.text.x = element_text(
        size = 20, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) 

# now use the interval data for photosynthesis to predict NSC at each interval based on the same model
nsc_photo<-photo_int%>%
  dplyr::rename(Ypd=pred_Ypd)%>% # match the newdata column to original data name
  group_by(Species)%>% # group by species, since thresholds are at species level. Should I try it at individual level?
  nest()%>% # collapses data by grouping variable (Species) so I can combine with model list dataframe
  full_join(models)%>% # combine models list and new data
  group_by(Species,Component)%>% # group by species and component 
  do(pred_pct=augment(.$fit[[1]], newdata = .$data[[1]]))%>% # predict NSC at each photosynthesis interval based on the water potential and NSC relationship derived in the "models" dataframe above
  unnest() # flatten data out to plot
# now plot the data to see how it looks. Make sense?
photo_nsc_plot<-ggplot(nsc_photo,aes(interval,.fitted,color=Component,shape=Component,group=Component)) + labs(x="% of Maximum Photosynthesis",y="% of Maximum NSC (Predicted)") +  geom_smooth(stat="smooth",method="gam",formula=y~s(log(x),bs="cs",k=7),se=TRUE) + facet_wrap(~Species,scale="free",ncol=1)  + scale_y_continuous(guide = guide_axis(check.overlap = TRUE),limits=c(0.2,0.8),breaks=c(0.2,0.3,0.4,0.5,0.6,0.7,0.8))  + scale_x_discrete(guide = guide_axis(check.overlap = TRUE)) +  scale_color_manual(values=wes_palette("Zissou1",n=3,type='continuous')) + theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(strip.text.x = element_text(
        size = 20, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) 


nsc_predicted<-ggarrange(growth_nsc_plot,photo_nsc_plot,labels=c("C","D"),ncol=2,legend="none")

# the shape of the response curves are remarkably similar for growth and photosynthesis
# this is probably because the response curves of these parameters with Ypd is statistically the same


```


```{r OLD pct days statistics, include=FALSE, eval=FALSE,echo=FALSE}
# they are the same


# Question 1: Are there significant differences in the amount of time spent between % of maximum for each variable?
# 1.) test for normality
pg_limit$Status<-as.factor(pg_limit$Status)
pct_qq<-qqnorm(pg_limit$pct_study) # data doesn't look normal
pct_hist<-hist(pg_limit$pct_study) # looks like a strong right skew
library(ppcc) # load package to run qqnromality correlation test
ppcc<-ppccTest(pg_limit$pct_study,qfn="qnorm") # pct_study data is not normal
sumo<-pg_limit%>%
  filter(Site=="SUMO")
sumo_qqplot<-ggplot(sumo,aes(sample=pct_study)) + geom_qq() + geom_qq_line() + facet_wrap(~Status)
mdb<-pg_limit%>%
  filter(Site=="MDB")
mdb_qqplot<-ggplot(mdb,aes(sample=pct_study)) + geom_qq() + facet_wrap(Species~Status)



# try a log transformation to see if it helps make data more normal
pct_log<-pg_limit%>%
  ungroup()%>%
  filter(pct_study>0)%>%
  mutate(log_pct=log(pct_study)) # initial qq plot suggested non-normal data; trying lognormal transformation
logpct_qq<-qqnorm(pct_log$log_pct) # data looks a bit weird still
logpct_hist<-hist(pct_log$log_pct) # looks like a strong left skew
ppccTest(pct_log$log_pct,qfn="qnorm") # probability plot correlation coefficient test suggests the log data differs from a normal distribution
# data does not follow a normal distribution
# run KW test for each pair and pairwise wilcoxon test to see where differences are
psg<-sumo%>%
  filter(Species=="P. edulis")%>% # subset by species
  filter(Variable=="Growth") # subset by variable
psg_kw<-kruskal.test(pct_study~Status,data=psg) # p < 0.001 # run kruskal wallis test

# keeping this code live but not going to use it. Let's just use ks test reslts
library(FSA)
psg_dunn<-dunnTest(pct_study~Status,data=psg,method='bonferroni')# run Dunn's test to find where differences are
pmg<-mdb%>%
  filter(Species=="P. edulis")%>%
  filter(Variable=="Growth")
pmg_kw<-kruskal.test(pct_study~Status,data=pmg) # p < 0.001
pmg_dunn<-dunnTest(pct_study~Status,data=pmg,method='bonferroni')
psp<-sumo%>%
  filter(Species=="P. edulis")%>%
  filter(Variable=="Photosynthesis")
psp_kw<-kruskal.test(pct_study~Status,data=psp) # p < 0.001
psp_dunn<-dunnTest(pct_study~Status,data=psp,method='bonferroni')
pmp<-mdb%>%
  filter(Species=="P. edulis")%>%
  filter(Variable=="Photosynthesis")
pmp_kw<-kruskal.test(pct_study~Status,data=pmp) # p < 0.001
pmp_dunn<-dunnTest(pct_study~Status,data=pmp,method='bonferroni')
jsg<-sumo%>%
  filter(Species=="J. monosperma")%>%
  filter(Variable=="Growth")
jsg_kw<-kruskal.test(pct_study~Status,data=jsg) # p < 0.001
jsg_dunn<-dunnTest(pct_study~Status,data=jsg,method='bonferroni')
jmg<-mdb%>%
  filter(Species=="J. monosperma")%>%
  filter(Variable=="Growth")
jmg_kw<-kruskal.test(pct_study~Status,data=jmg) # p < 0.01
jmg_dunn<-dunnTest(pct_study~Status,data=jmg,method='bonferroni',list=TRUE)
jsp<-sumo%>%
  filter(Species=="J. monosperma")%>%
  filter(Variable=="Photosynthesis")
jsp_kw<-kruskal.test(pct_study~Status,data=jsp) # p < 0.001
jsp_dunn<-dunnTest(pct_study~Status,data=jsp,method='bonferroni')
jmp<-mdb%>%
  filter(Species=="J. monosperma")%>%
  filter(Variable=="Photosynthesis")
jmp_kw<-kruskal.test(pct_study~Status,data=jmp) # p < 0.01
jmp_dunn<-dunnTest(pct_study~Status,data=jmp,method='bonferroni')



all_tab<-cbind(psg_dunn$res$Comparison,psg_dunn$res$P.adj,pmg_dunn$res$P.adj,psp_dunn$res$P.adj,pmp_dunn$res$P.adj,jsg_dunn$res$P.adj,jmg_dunn$res$P.adj,jsp_dunn$res$P.adj,jmp_dunn$res$P.adj)
all_tab<-as.data.frame(all_tab)

all_tab<-all_tab%>%
  dplyr::rename(Comparison=V1)%>%
  dplyr::rename("P. edulis_SUMO_Growth"=V2)%>%
  dplyr::rename("P. edulis_MDB_Growth"=V3)%>%
  dplyr::rename("P. edulis_SUMO_Photosynthesis"=V4)%>%
  dplyr::rename("P. edulis_MDB_Photosynthesis"=V5)%>%
  dplyr::rename("J. monosperma_SUMO_Growth"=V6)%>%
  dplyr::rename("J. monosperma_MDB_Growth"=V7)%>%
  dplyr::rename("J. monosperma_SUMO_Photosynthesis"=V8)%>%
  dplyr::rename("J. monosperma_MDB_Photosynthesis"=V9)

library(kableExtra)

siglabel <- function(x){
  xf <- round(x, 3)
  xp <- as.data.frame(xf) %>%
  mutate(sig=case_when(xf <= 0.001 ~ "***",
                       xf > 0.001 & xf <= 0.01 ~ "**",
                       xf > 0.01 & xf <= 0.05 ~ "*",
                      xf > 0.05 ~ "")) %>%
  mutate(vsig=paste(xf, sig, sep=""))
  return(xp$vsig)
}

at <- all_tab %>%
  distinct() 
  #mutate(across(-Comparison, as.numeric)) %>%
  #mutate(across(-Comparison, siglabel))
names<-c("% of Maximum Comparison", "P. edulis, SUMO, G", "P. edulis, MDB, G", "P. edulis, SUMO, A", "P. edulis, MDB, A", "J. monosperma, SUMO, G", "J. monosperma, MDB, G", "J. monosperma, SUMO, A", "J. monosperma, MDB, A")
names(names)<-c("% of Maximum Comparison", "P. edulis, SUMO, G", "P. edulis, MDB, G", "P. edulis, SUMO, A", "P. edulis, MDB, A", "J. monosperma, SUMO, G", "J. monosperma, MDB, G", "J. monosperma, SUMO, A", "J. monosperma, MDB, A")
at_names<-names(at)

for (i in 2:9) {
  at[,i]<-as.numeric(at[,i])
  at[,i]<-ifelse(at[,i]<=.05,round(at[,i],3),"n.s.")
  at[,i]<-ifelse(at[,i]==0,"<0.001",at[,i])
  names(at) [names(at) == at_names[i]] = names[i]
}

all_kab<-flextable(at)
#all_kab<-kbl(at,align='c',table.attr = "style = \"color: black;\"")%>%
 #   kable_classic(full_width = F, html_font = "Cambria")%>%
  #kable_styling(font_size = 20)

# Question 2: For a given % of max, was there variation by site?

```

```{r OLD Statistics, include=FALSE,eval=FALSE}

# H1: Growth is more sensitive to Ypd than Photosynthesis
# H2: JUMO Growth and Photosynthesis is less sensitive to Ypd than PIED
# H3: Sink limitation does not affect the probability of NSC increasing
# H4: Seasonal NSC fluxes have a greater influence on NSC dynamics than sink or source limitation
# H5: The % of the study period spent in sink or source limitation increases under A, H, D, and HD, respectively. (beta regression?)
# H6: Over the last 20 years (1992-2012), the frequency of source limitation has increased.

#first, determine best model (polynomial function) to find Ypd when Photo stops (One Model to Rule Them All)


# Second, determine best model (polynomial function) to find Ypd when Growth stops



#############################
#######  H1: ANOVA ##########
#############################


H1<-aov(xint~Limitation*Species,data=intercepts_anova_data)
H1post<-TukeyHSD(H1,ordered=TRUE)
plot(H1)
h1levene<-leveneTest(xint~Limitation*Species,data=intercepts_anova_data)
# data is NOT heteroskedastic!


##############################
####### H2: ANOVA ############
##############################
# Answered this in H1.1

#############################
#######  H3: LMER ##########
#############################
ctrl=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=100000))
library(lmerTest)
#NSC.month<-lmer(NSC~Month+(1|ID),data=nsc_at_status,control=ctrl)
#NSC.month.poly2<-lmer(NSC~poly(Month,2)+(1|ID),data=nsc_at_status,control=ctrl)
#NSC.month.poly3<-lmer(NSC~poly(Month,3)+(1|ID),data=nsc_at_status,control=ctrl) # best model
#monthAIC<-AICctab(NSC.month,NSC.month.poly2,NSC.month.poly3,base=TRUE,weights=TRUE,delta=TRUE,sort=TRUE)
# What is the probability that NSC is increasing when under sink limitation?

nsc_at_status$Month<-as.numeric(nsc_at_status$Month)
nsc_at_status$Species<-as.character(nsc_at_status$Species)
nsc_at_status$Status<-as.character(nsc_at_status$Status)
nsc_at_status$Treatment<-as.character(nsc_at_status$Treatment)
nsc_at_status$ID<-as.character(nsc_at_status$ID)
#nsc_at_status$normal_duration<-as.numeric(nsc_at_status$normal_duration)

NSC.month.status.species<-lmer(NSC~poly(Month,3)*Status*Species*Tissue*(1|ID),data=nsc_at_status,control=ctrl) 
#NSC.month.species<-lmer(NSC~poly(Month,3)+Species+Tissue+(1|ID),data=nsc_at_status,control=ctrl) # winner!
#NSC.month.species.statduration<-lmer(NSC~poly(Month,3)+Species+Tissue+Status*normal_duration+(1|ID),data=nsc_at_status,control=ctrl) 
#NSC.month.status<-lmer(NSC~poly(Month,3)+Status+Tissue+(1|ID),data=nsc_at_status,control=ctrl)
#NSC.month<-lmer(NSC~poly(Month,3)+Tissue+(1|ID),data=nsc_at_status,control=ctrl)
#NSC.status<-lmer(NSC~Status+Tissue+(1|ID),data=nsc_at_status,control=ctrl)
#NSC.species<-lmer(NSC~Species+Tissue+(1|ID),data=nsc_at_status,control=ctrl)
#NSC.null<-lmer(NSC~1+(1|ID),data=nsc_at_status,control=ctrl)
#NSCAICctab<-AICctab(NSC.month.status.species,NSC.month.species,NSC.month.species.statduration,NSC.month.status,NSC.month,NSC.status,NSC.species,NSC.null,base=TRUE,weights=TRUE,delta=TRUE,sort=TRUE)
# need to export AICc table, and lmer.ms results
#nsc_at_status$predictNSC<-predict(NSC.month.species,nsc_at_status)
NSC_GLMM_anova<-anova(NSC.month.status.species)
# got it!

# do this analysis for NSC components Sugar and Starch
# Sugar
sugar.month<-lmer(Sugar~Month+(1|ID),data=nsc_at_status,control=ctrl)
sugar.month.poly2<-lmer(Sugar~poly(Month,2)+(1|ID),data=nsc_at_status,control=ctrl)# winner
sugar.month.poly3<-lmer(Sugar~poly(Month,3)+(1|ID),data=nsc_at_status,control=ctrl)
monthAIC<-AICctab(sugar.month,sugar.month.poly2,sugar.month.poly3,nobs=15,base=TRUE,weights=TRUE,delta=TRUE,sort=TRUE)

sugar.month.status.species<-lmer(Sugar~poly(Month,3)*Status*Species*Tissue+(1|ID),data=nsc_at_status,control=ctrl)
#sugar.month.treatment.species<-lmer(Sugar~poly(Month,2)+Species+Tissue+(1|ID),data=nsc_at_status,control=ctrl)
#sugar.month.species<-lmer(Sugar~poly(Month,2)+Species+Tissue+(1|ID),data=nsc_at_status,control=ctrl) # winner
#sugar.month.species.statduration<-lmer(Sugar~poly(Month,2)+Species+Tissue+Status*normal_duration+(1|ID),data=nsc_at_status,control=ctrl) 
#sugar.month.status<-lmer(Sugar~poly(Month,2)+Tissue+Status+(1|ID),data=nsc_at_status,control=ctrl)
#sugar.month<-lmer(Sugar~poly(Month,2)+Tissue+(1|ID),data=nsc_at_status,control=ctrl) 
#sugar.month<-lmer(Sugar~poly(Month,2)+Tissue+(1|ID),data=nsc_at_status,control=ctrl)
#sugar.status<-lmer(Sugar~Status+Tissue+(1|ID),data=nsc_at_status,control=ctrl)
#sugar.species<-lmer(Sugar~Species+Tissue+(1|ID),data=nsc_at_status,control=ctrl)
#sugar.null<-lmer(Sugar~1+(1|ID),data=nsc_at_status,control=ctrl)
#SSAICctab<-AICctab(sugar.month.status.species,sugar.month.species,sugar.month.species.statduration,sugar.month,sugar.status,sugar.species,sugar.null,base=TRUE,weights=TRUE,delta=TRUE,sort=TRUE)
# need to export AICc table, and lmer.ms results
#nsc_at_status$predictSugar<-predict(sugar.month.status.species,nsc_at_status)
SS_GLMM_anova<-anova(sugar.month.status.species)
# Starch
starch.month<-lmer(Starch~Month+(1|ID),data=nsc_at_status,control=ctrl)
starch.month.poly2<-lmer(Starch~poly(Month,2)+(1|ID),data=nsc_at_status,control=ctrl) 
starch.month.poly3<-lmer(Starch~poly(Month,3)+(1|ID),data=nsc_at_status,control=ctrl) # winner
monthAIC<-AICctab(starch.month,starch.month.poly2,starch.month.poly3,nobs=15,base=TRUE,weights=TRUE,delta=TRUE,sort=TRUE)

starch.month.status.species<-lmer(Starch~poly(Month,3)*Status*Species*Tissue+(1|ID),data=nsc_at_status,control=ctrl)
#starch.month.species<-lmer(Starch~poly(Month,3)+Species+Tissue+(1|ID),data=nsc_at_status,control=ctrl)
#starch.month.species<-lmer(Starch~poly(Month,3)+Species+Tissue+(1|ID),data=nsc_at_status,control=ctrl) 
#starch.month.species.statduration<-lmer(Starch~poly(Month,3)+Species+Tissue+Status*normal_duration+(1|ID),data=nsc_at_status,control=ctrl) 
#starch.month.status<-lmer(Starch~poly(Month,3)+Status+Tissue+(1|ID),data=nsc_at_status,control=ctrl)
#starch.month<-lmer(Starch~poly(Month,3)+Tissue+(1|ID),data=nsc_at_status,control=ctrl) # winner
#starch.status<-lmer(Starch~Status+Tissue+(1|ID),data=nsc_at_status,control=ctrl)
#starch<-lmer(Starch~(1|ID),data=nsc_at_status,control=ctrl)
#starch.species<-lmer(Starch~Species+Tissue+(1|ID),data=nsc_at_status,control=ctrl)
#starch.null<-lmer(Starch~1+(1|ID),data=nsc_at_status,control=ctrl)
#StAICctab<-AICctab(starch.month.status.species,starch.month.species,starch.month.status,starch.month,starch.status,starch,starch.species,starch.month.species.statduration,starch.null,base=TRUE,weights=TRUE,delta=TRUE,sort=TRUE)
# need to export AICc table, and lmer.ms results
#nsc_at_status$predictStarch<-predict(starch.month.status,nsc_at_status)
ST_GLMM_anova<-anova(starch.month.status.species)

#######################
####### H3.2 ##########
#### NSC AT STATUS ####
#######################

H3.2_NSC<-aov(NSC~Status*Species*Tissue,data=nsc_at_status)
plot(H3.2_NSC)
H3.2_NSC_posthoc<-TukeyHSD(H3.2_NSC)
H3.2_SS<-aov(Sugar~Status*Species*Tissue,data=nsc_at_status)
plot(H3.2_SS)
H3.2_ss_posthoc<-TukeyHSD(H3.2_SS)
H3.2_ST<-aov(Starch~Status*Species*Tissue,data=nsc_at_status)
plot(H3.2_ST)
H3.2_ST_posthoc<-TukeyHSD(H3.2_ST)

H3.2_NSC_posthoc
H3.2_ss_posthoc
H3.2_ST_posthoc



##############################
###### A at Status Stats #####
##############################
# photosynthesis ANOVA
photo_test<-aov(Photo~Status*Species,data=photo_5)
photo_post<-TukeyHSD(photo_test,ordered=TRUE)



########################
###### H4 ##############
########################
# DID THIS IN H3

#########################
######## H5: ANOVA ########
#########################
# Are trees spending more time in a certain status, and does that increase as stress increases(A,H,D,HD)? Different for different species?
#H5.1<-aov(pct_study~Status*Species,data=nsc_ypd_days2) 
#plot(H5.1)
#H5.1_posthoc<-TukeyHSD(H5.1) 
#H5.1_posthoc


# predicted stats
#nscp<-aov(predictNSC~Status*Species,data=nsc_at_status)
#ssp<-aov(predictSugar~Status*Species,data=nsc_at_status)
#stp<-aov(predictStarch~Status*Species,data=nsc_at_status)


```

```{r OLD New Plots, include=FALSE,eval=FALSE}

spp.labs <- c("J. monosperma", "P. edulis")
names(spp.labs) <- c("JUMO", "PIED")


################################
## Growth/A bar charts #########
################################
intercepts_anova_data<-intercepts_anova_data%>%
  group_by(Species,Limitation)%>%
  mutate(sem=sem(xint))%>%
  mutate(mean_intercept=mean(xint))%>%
  mutate(Species==ifelse(Species=="JUMO","J. monosperma","P. edulis"))

status_plot<-ggplot(intercepts_anova_data,aes(Species,mean_intercept,fill=Limitation,label=ifelse(Limitation=="growth","a","b"))) + geom_bar(stat="summary",position = "dodge",colour="white") + 
  ylim(0,-10.5) +geom_text(stat="identity",position=position_dodge(0.9),aes(y=(mean_intercept-sem)-0.5),vjust=0)+
  geom_errorbar(stat="identity",aes(ymin=mean_intercept+sem, ymax=mean_intercept-sem), width=.0,position=position_dodge(.9)) + ylab(expression(paste("",psi," (MPa)"))) + scale_x_discrete(label=spp.labs,guide = guide_axis(check.overlap = TRUE)) +  scale_fill_manual(name="Limitation Type",labels=c("Growth","Photosynthesis"),values=wes_palette("GrandBudapest1",n=2,type='discrete')) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(strip.text.x = element_text(
        size = 12, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   )+ scale_color_manual(values=wes_palette("GrandBudapest1",n=75,type='continuous')) + ylim(0,-7.5) + theme(
    legend.position = c(.95, .95),
    legend.justification = c("right", "top")) 

###################################
## Growth x treatment bar charts ##
###################################

growth_sem_1<-g_wp%>%
  group_by(Species)%>%
  mutate(sem_growth=sem(xint))%>%
  mutate(mean_xint=mean(xint))%>%
  select(Species,Treatment,ID,mean_xint,sem_growth)%>%
  distinct(ID,sem_growth,.keep_all = TRUE)


growth_barchart<-ggplot(data=growth_sem_1, aes(Species, mean_xint,fill=Species)) + 
  geom_bar(stat="summary",position = "dodge",colour="white") +
  geom_errorbar(stat="identity",aes(ymin=mean_xint-sem_growth, ymax=mean_xint+sem_growth), width=.2,position=position_dodge(.9))  +
  ylim(0,-6)  + ylab("Predawn Water Potential at 0 Growth") + scale_x_discrete(guide = guide_axis(check.overlap = TRUE)) + scale_fill_manual(values=wes_palette("GrandBudapest1",n=2,type='discrete'))

######################
# A x treat charts ###
######################
a<-wp_photo_final%>%
  group_by(Species)%>%
  mutate(sem_photo=sem(xint_photo))%>%
  mutate(mean_int=mean(xint_photo))%>%
  select(Species,Treatment,ID,xint_photo,mean_int,sem_photo)%>%
  distinct(ID,sem_photo,.keep_all = TRUE)

treatment.species<-a%>%
  mutate(sig=ifelse(Species=="PIED" & Treatment=="A","ab",ifelse(Species=="PIED" & Treatment=="D","b",ifelse(Species=="PIED" & Treatment=="H","ab",ifelse(Species=="PIED" & Treatment=="HD","b",ifelse(Species=="JUMO" & Treatment=="D","a",ifelse(Species=="JUMO" & Treatment=="HD","a",NA))))))) %>% group_by(Species)%>%mutate(y=max(xint_photo))

photo_barchart<-ggplot(data=a, aes(Species, mean_int,fill=Species)) + 
  geom_bar(stat="summary",position = "dodge",colour="white") +
  geom_errorbar(stat="identity",aes(ymax=mean_int-sem_photo, ymin=mean_int+sem_photo), width=.2,position=position_dodge(.9))  +
  ylim(0,-3) + ylab("Predawn Water Potential at 0 Photosynthesis") + ylim(0,-6) + scale_x_discrete(guide = guide_axis(check.overlap = TRUE)) + scale_fill_manual(values=wes_palette("GrandBudapest1",n=2,type='discrete'))





##################
## NoA x NoG #####
##################

#AG_plot<-ggplot(intercepts,aes(photo_int_ind,intercept)) + geom_point()+geom_smooth(method="lm") + xlab("Ypd Source Limitation") + ylab("Ypd Sink Limitation") + facet_wrap(~Species,scales="free")

######################
##### Delta Int ######
######################
#delta<-ggplot(delta_intercepts,aes(Treatment,delta_int)) + geom_boxplot() + facet_wrap(~Species)

#####################
## Total days of study ##
#####################
#color<-nsc_ypd_days2%>%
  #ungroup()%>%
  #select(Status,color)
#total_days_plot<-ggplot(nsc_ypd_days2,aes(Status,total_days_status,linetype=Status)) + geom_boxplot() + facet_wrap(Species~Treatment)


#######################
#### NSC at status ####
#######################
####### NEED TO SAVE THESE PLOTS ##########
#status_boxplot_nsc<-ggplot(nsc_at_status,aes(Treatment,NSC,linetype=Status,fill=Status),fill=nsc_at_status$color) + geom_boxplot() + facet_wrap(~Species)
#status_boxplot_ss<-ggplot(nsc_at_status,aes(Treatment,Sugar,linetype=Status,fill=Status),fill=nsc_at_status$color) + geom_boxplot() + facet_wrap(~Species)
#status_boxplot_st<-ggplot(nsc_at_status,aes(Treatment,Starch,linetype=Status,fill=Status),fill=nsc_at_status$color) + geom_boxplot() + facet_wrap(~Species)

NAS<-nsc_at_status%>%
  group_by(Species,Tissue,Status)%>%
  mutate(mean_NSC=mean(NSC))%>%
  mutate(mean_Sugar=mean(Sugar))%>%
  mutate(mean_Starch=mean(Starch))%>%
  mutate(sem_NSC=sem(NSC))%>%
  mutate(sem_Sugar=sem(Sugar))%>%
  mutate(sem_Starch=sem(Starch))%>%
  select(Species,Treatment,Status,Tissue,mean_NSC,mean_Sugar,mean_Starch,sem_NSC,sem_Sugar,sem_Starch)%>%
  distinct()


nsc_cap<-str_wrap("Figure 2. Barchart showing average concentrations of NSC in J. monosperma and P. edulis during each limitation status. Letters indicate significant differences in NSC concentrations between each limitation status, within species, within treatments")
ss_cap<-str_wrap("Barchart showing average sugar concentrations in J. monosperma and P. edulis\n during each limitation status. Letters indicate significant differences\n in NSC concentrations between each limitation status, within species, within treatments")
st_cap<-str_wrap("Barchart showing average starch concentrations in J. monosperma and P. edulis\n during each limitation status. Letters indicate significant differences\n in NSC concentrations between each limitation status, within species, within treatments")


nsc_stat<-compare_means(formula=NSC~Status,data=nsc_at_status)
ss_stat<-compare_means(formula=Sugar~Status,data=nsc_at_status)
st_stat<-compare_means(formula=Starch~Status,data=nsc_at_status)

comparisons <- list(c("Sink","Source"),c("Sink","No Limit"),c("Source","No Limit"))

#, label=ifelse(Species=="JUMO" & Status=="Sink","a",ifelse(Species=="PIED" & Status=="Sink","A",ifelse(Species=="PIED"&Status=="Source","A",ifelse(Species=="JUMO"&Status=="Source","a",ifelse(Species=="JUMO"&Status=="No Limit","a",ifelse(Species=="PIED" & Status=="No Limit","A",""))

NAS<-NAS%>%
  mutate(Species=ifelse(Species=="JUMO","J. monosperma","P. edulis"))
  
nsc_bar<-ggplot(NAS,aes(Species,mean_NSC,fill=Status,label=ifelse(Tissue=="bole"&Status == "Sink","n.s.",ifelse(Tissue=="leaf"&Status == "Sink","n.s.",ifelse(Tissue=="twig"&Status == "Sink","n.s.",ifelse(Tissue=="root"&Status == "Sink","n.s.","")))))) +  geom_text(stat="identity",position=position_dodge(0.9),aes(y=(mean_NSC+sem_NSC)+0.5),vjust=0) + geom_bar(stat="summary",position = "dodge",colour="white") +
  geom_errorbar(stat="identity",aes(ymin=mean_NSC-sem_NSC, ymax=mean_NSC+sem_NSC), width=.0,position=position_dodge(.9)) + ylab("% NSC")+ scale_x_discrete(guide = guide_axis(check.overlap = TRUE)) +  scale_fill_manual(name="Limitation Type",labels=c("None","Growth","Photosynthesis"),values=wes_palette("GrandBudapest1",n=3,type='discrete')) + theme(axis.text.x = element_text(angle = 90),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + facet_wrap(~Tissue)  +  theme(strip.text.x = element_text(
        size = 12, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + ylim(0,11)

ss_bar<-ggplot(NAS,aes(Species,mean_Sugar,fill=Status,label=ifelse(Tissue=="bole"&Status=="Sink","n.s.",ifelse(Tissue=="leaf"&Species=="J. monosperma"&Status=="No Limit","a",ifelse(Tissue=="leaf"&Species=="J. monosperma"&Status=="Sink","ab",ifelse(Tissue=="leaf"&Species=="J. monosperma"&Status=="Source","b",ifelse(Tissue=="leaf"&Species=="P. edulis"&Status=="Sink","n.s.",ifelse(Tissue=="root"&Species=="J. monosperma"&Status=="No Limit","a",ifelse(Tissue=="root"&Species=="J. monosperma"&Status=="Sink","ab",ifelse(Tissue=="root"&Species=="J. monosperma"&Status=="Source","b",ifelse(Tissue=="root"&Species=="P. edulis"&Status=="Sink","n.s.",ifelse(Tissue=="twig"&Species=="J. monosperma"&Status=="No Limit","a",ifelse(Tissue=="twig"&Species=="J. monosperma"&Status=="Sink","a",ifelse(Tissue=="twig"&Species=="J. monosperma"&Status=="Source","b",ifelse(Tissue=="twig"&Species=="P. edulis"&Status=="No Limit","a",ifelse(Tissue=="twig"&Species=="P. edulis"&Status=="Sink","b",ifelse(Tissue=="twig"&Species=="P. edulis"&Status=="Source","b",""))))))))))))))))) + geom_text(stat="identity",position=position_dodge(0.9),aes(y=(mean_Sugar+sem_Sugar)+1),vjust=0) + geom_bar(stat="summary",position = "dodge",colour="white") +
  geom_errorbar(stat="identity",aes(ymin=mean_Sugar-sem_Sugar, ymax=mean_Sugar+sem_Sugar), width=.0,position=position_dodge(.9)) + ylab("% Sugar")+ scale_x_discrete(guide = guide_axis(check.overlap = TRUE)) +  scale_fill_manual(name="Limitation Type",labels=c("None","Growth","Photosynthesis"),values=wes_palette("GrandBudapest1",n=3,type='discrete')) + theme(axis.text.x = element_text(angle = 90),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + facet_wrap(~Tissue)  +  theme(strip.text.x = element_text(
        size = 12, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   )+ ylim(0,10)

st_bar<-ggplot(NAS,aes(Species,mean_Starch,fill=Status,label=ifelse(Status=="Sink","n.s.",""))) + geom_text(stat="identity",position=position_dodge(0.9),aes(y=(mean_Starch+sem_Starch)+1),vjust=0) + geom_bar(stat="summary",position = "dodge",colour="white") +
  geom_errorbar(stat="identity",aes(ymin=mean_Starch-sem_Starch, ymax=mean_Starch+sem_Starch), width=.0,position=position_dodge(.9)) + ylab("% Starch")+ scale_x_discrete(guide = guide_axis(check.overlap = TRUE)) +  scale_fill_manual(name="Limitation Type",labels=c("None","Growth","Photosynthesis"),values=wes_palette("GrandBudapest1",n=3,type='discrete')) + theme(axis.text.x = element_text(angle = 90),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + facet_wrap(~Tissue)  +  theme(strip.text.x = element_text(
        size = 12, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   )+ ylim(0,10)










##########################
## H3 Predicted Plot #####
##########################
#model_nsc<-nsc_at_status%>%
  #select(Species,ID,Treatment,Status,Tissue,Month,predictNSC,predictSugar,predictStarch)%>%
  #distinct()

#nsclm_wrap<-str_wrap("Figure 5. Results of the best fitting linear mixed-effects model, according to our Akaike Information Criterion, showing NSC concentrations through time at various limitation statuses. Faded points indicate true NSC values, while smooth lines indicate model predicted values. Green points and lines = No Limitation. Yellow points and lines = Sink Limitation. Red points and lines = Source Limitation. ")
#sslm_wrap<-str_wrap("Figure 6. Results of the best fitting linear mixed-effects model, according to our Akaike Information Criterion, showing soluble sugar concentrations through time at various limitation statuses. Faded points indicate true sugar values, while smooth lines indicate model predicted values. Green points and lines = No Limitation. Yellow points and lines = Sink Limitation. Red points and lines = Source Limitation. ")
#stlm_wrap<- "Figure 7. Results of the best fitting linear mixed-effects model, according to our Akaike Information Criterion, showing starch concentrations through time at various limitation statuses. Faded points indicate true starch values, while smooth lines indicate model predicted values. Green points and lines = No Limitation. Yellow points and lines = Sink Limitation. Red points and lines = Source Limitation. "



#lmplot_nsc<-ggplot(nsc_at_status,aes(Month,NSC,color=Status)) + geom_point(alpha=0.1) + geom_point(aes(y=predictNSC,color=Status)) + ylab("% NSC")  + facet_wrap(~Species, drop=TRUE,labeller=labeller(Species=spp.labs)) + scale_x_discrete(limits=c("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"), guide = guide_axis(check.overlap = TRUE)) + scale_color_manual(name="Limitation",labels=c("No Limit","Sink","Source"),values=wes_palette("GrandBudapest1",n=3,type='discrete')) + theme(strip.text.x = element_text(
 #       size = 12, face = "italic"),
  #      panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
#panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
 #  strip.background = element_rect(
  #   color="white", fill="white", size=1.5, linetype="solid"
   #  )
   #) + facet_wrap(~Tissue)

#lmplot_sugar<-ggplot(nsc_at_status,aes(Month,Sugar,color=Status)) + geom_point(alpha=0.1) + geom_point(data=model_nsc,aes(y=predictSugar)) + ylab("% Sugar")   + facet_wrap(~Species, drop=TRUE,labeller=labeller(Species=spp.labs)) + scale_x_discrete(limits=c("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"), guide = guide_axis(check.overlap = TRUE))  + scale_color_manual(name="Limitation",labels=c("No Limit","Sink","Source"),values=wes_palette("GrandBudapest1",n=3,type='discrete')) + theme(strip.text.x = element_text(
 #       size = 12, face = "italic"),
  #      panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
#panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
 #  strip.background = element_rect(
  #   color="white", fill="white", size=1.5, linetype="solid"
   #  )
   #)+ facet_wrap(~Tissue)

#lmplot_starch<-ggplot(nsc_at_status,aes(Month,Starch,color=Status)) + geom_point(alpha=0.1) + geom_point(data=model_nsc,aes(y=predictStarch)) + ylab("% Starch")   + facet_wrap(~Species, drop=TRUE,labeller=labeller(Species=spp.labs)) + scale_x_discrete(limits=c("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"), guide = guide_axis(check.overlap = TRUE))  + scale_color_manual(name="Limitation",labels=c("No Limit","Sink","Source"),values=wes_palette("GrandBudapest1",n=3,type='discrete')) + theme(strip.text.x = element_text(
 #       size = 12, face = "italic"),
  #      panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
#panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
 #  strip.background = element_rect(
#     color="white", fill="white", size=1.5, linetype="solid"
#     )
#   ) + facet_wrap(~Tissue)

#NAS_predict<-nsc_at_status%>%
 # group_by(Species,Treatment,Status,Tissue)%>%
  #mutate(mean_NSCp=mean(predictNSC))%>%
  #mutate(mean_Sugarp=mean(predictSugar))%>%
  #mutate(mean_Starchp=mean(predictStarch))%>%
  #mutate(sem_NSC=sem(predictNSC))%>%
  #mutate(sem_Sugar=sem(predictSugar))%>%
  #mutate(sem_Starch=sem(predictStarch))%>%
  #select(Species,Treatment,Status,Tissue,mean_NSCp,mean_Sugarp,mean_Starchp,sem_NSC,sem_Sugar,sem_Starch)%>%
  #distinct()


#nsc_bar_predict<-ggplot(NAS_predict,aes(Species,mean_NSCp,fill=Status,label=ifelse(Species=="JUMO" & Status=="Sink","a",ifelse(Species=="PIED" & Status=="Sink","A",ifelse(Species=="PIED"&Status=="Source","A",ifelse(Species=="JUMO"&Status=="Source","a",ifelse(Species=="JUMO"&Status=="No Limit","a",ifelse(Species=="PIED" & Status=="No Limit","A","")))))))) + geom_text(stat="summary",position=position_dodge(0.9),aes(y=(mean_NSCp+sem_NSC)+0.8),vjust=0) + geom_bar(stat="summary",position = "dodge",colour="white") +
 # geom_errorbar(stat="summary",aes(ymin=mean_NSCp-sem_NSC, ymax=mean_NSCp+sem_NSC), width=.2,position=position_dodge(.9)) + ylab("% NSC")+ scale_x_discrete(guide = guide_axis(check.overlap = TRUE)) +  scale_fill_manual(name="Limitation",labels=c("No Limit","Sink","Source"),values=wes_palette("GrandBudapest1",n=3,type='discrete')) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
#panel.background = element_blank(), axis.line = element_line(colour = "black")) + facet_wrap(~Tissue)

#ss_bar_predict<-ggplot(NAS_predict,aes(Species,mean_Sugarp,fill=Status,label=ifelse(Species=="JUMO" & Status=="Sink","a",ifelse(Species=="PIED" & Status=="Sink","A",ifelse(Species=="PIED"&Status=="Source","A",ifelse(Species=="JUMO"&Status=="Source","a",ifelse(Species=="JUMO"&Status=="No Limit","a",ifelse(Species=="PIED" & Status=="No Limit","A","")))))))) + geom_text(stat="summary",position=position_dodge(0.9),aes(y=(mean_Sugarp+sem_Sugar)+0.5),vjust=0) + geom_bar(stat="summary",position = "dodge",colour="white") +
 # geom_errorbar(stat="summary",aes(ymin=mean_Sugarp-sem_Sugar, ymax=mean_Sugarp+sem_Sugar), width=.2,position=position_dodge(.9)) + ylab("% NSC")+ scale_x_discrete(guide = guide_axis(check.overlap = TRUE)) +  scale_fill_manual(name="Limitation",labels=c("No Limit","Sink","Source"),values=wes_palette("GrandBudapest1",n=3,type='discrete')) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
#panel.background = element_blank(), axis.line = element_line(colour = "black"))

#st_bar_predict<-ggplot(NAS_predict,aes(Species,mean_Starchp,fill=Status,label=ifelse(Species=="JUMO" & Status=="Sink","a",ifelse(Species=="PIED" & Status=="Sink","A",ifelse(Species=="PIED"&Status=="Source","A",ifelse(Species=="JUMO"&Status=="Source","a",ifelse(Species=="JUMO"&Status=="No Limit","a",ifelse(Species=="PIED" & Status=="No Limit","A","")))))))) + geom_text(stat="summary",position=position_dodge(0.9),aes(y=(mean_Starchp+sem_Starch)+0.8),vjust=0) + geom_bar(stat="summary",position = "dodge",colour="white") +
#  geom_errorbar(stat="summary",aes(ymin=mean_Starchp-sem_Starch, ymax=mean_Starchp+sem_Starch), width=.2,position=position_dodge(.9)) + ylab("% NSC")+ scale_x_discrete(guide = guide_axis(check.overlap = TRUE)) +  scale_fill_manual(name="Limitation",labels=c("No Limit","Sink","Source"),values=wes_palette("GrandBudapest1",n=3,type='discrete')) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
#panel.background = element_blank(), axis.line = element_line(colour = "black"))

##############################
##### predict vs. actual #####
##############################
#pvn<-ggplot(nsc_at_status,aes(NSC,predictNSC,color=Status)) + geom_point() + facet_wrap(Species~Tissue) + geom_abline(slope=1)



#############################
##### H5: Days in Status ####
#############################
j<-nsc_ypd_days2%>%filter(Species=="JUMO")%>%
  filter(Treatment!="A")%>%
  filter(Treatment!="H")
p<-nsc_ypd_days2%>%filter(Species=="PIED")
nsc_ypd_days3<-rbind(j,p)
days_sig<-nsc_ypd_days3%>%
  mutate(sig=ifelse(Species=="PIED" & Treatment=="A" ,"a",ifelse(Species=="PIED" & Treatment=="D","a",ifelse(Species=="PIED" & Treatment=="H","a",ifelse(Species=="PIED" & Treatment=="HD","a",ifelse(Species=="JUMO" & Treatment=="D" & Status=="No Limit","a",ifelse(Species=="JUMO" & Treatment=="D" & Status=="Sink","b",ifelse(Species=="JUMO" & Treatment=="D" & Status=="Source","b",ifelse(Species=="JUMO" & Treatment=="HD" & Status=="No Limit","a",ifelse(Species=="JUMO" & Treatment=="HD" & Status=="Sink","b",ifelse(Species=="JUMO" & Treatment=="HD" & Status=="Source","b",NA))))))))))) %>% group_by(Treatment,Species,Status)%>%mutate(y=max(pct_study))

days_sig_BIG<-nsc_ypd_days2%>%
  mutate(sig=ifelse(Species=="PIED" & Treatment=="D" ,"A",ifelse(Species=="PIED" & Treatment=="HD","A",ifelse(Species=="JUMO" & Treatment=="D","A",ifelse(Species=="JUMO" & Treatment=="HD","A",NA))))) %>% group_by(Treatment,Species,Status)%>%mutate(y=max(pct_study))

days_plot<-ggplot(nsc_ypd_days3,aes(Treatment,pct_study,linetype=Status))+geom_boxplot()+facet_wrap(~Species)+geom_text(data=days_sig,position=position_dodge(0.9),aes(x=Treatment,y=0.02+y,label=sig),vjust=0)+geom_text(data=days_sig_BIG,position=position_dodge(0.9),aes(x=Treatment,y=0.05+y,label=sig),vjust=0) + ylab("% of Study Period")+ scale_x_discrete(guide = guide_axis(check.overlap = TRUE)) + labs(caption="Boxplot of the percentage of the study period spent under No Limitation, Sink Limitation or Source Limitation by species and treatment. Lower case letters indicate differences within species, while upper case letters indicate differences within treatment, between species.")

###########################
### Days barcharts ########
###########################
nsc_ypd_days4<-nsc_ypd_days3%>%
  drop_na()%>%
  group_by(Species,Status)%>%
  mutate(sem=sem(pct_study))%>%
  mutate(mean_pct=mean(pct_study))

daysplot_bar<-ggplot(nsc_ypd_days4,aes(Species,mean_pct,fill=Status)) + geom_bar(stat="summary",position = "dodge",colour="white") + geom_errorbar(stat="identity",aes(ymin=mean_pct-sem, ymax=mean_pct+sem), width=.2,position=position_dodge(.9)) + ylim(0.0,1)+ylab("% of Study Period")+ scale_x_discrete(guide = guide_axis(check.overlap = TRUE)) + scale_fill_manual(name="Limitation",labels=c("No Limit","Sink","Source"),values=wes_palette("GrandBudapest1",n=3,type='discrete')) + theme(strip.text.x = element_text(
        size = 12, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   )

###########################
#### longterm plots #######
###########################
longterm_analysis<-ggplot(longterm_annual,aes(Year,avg_annual,color=Status)) + geom_point() + geom_line() + facet_wrap(~Species,nrow=2,ncol=1) + scale_x_continuous() + labs(y="Average Number of Days") + geom_errorbar(stat="identity",aes(ymin=avg_annual-sem, ymax=avg_annual+sem), width=.2)+ theme(strip.text.x = element_text(
        size = 12, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   )+ scale_color_manual(name="Limitation",labels=c("No Limit","Sink","Source"),values=wes_palette("GrandBudapest1",n=3,type='discrete'))

longterm3<-longterm3%>%
  mutate(month=month(Date))%>%
  mutate(Study=ifelse(grepl("SUMO",ID),'SUMO','MDB'))%>%
  group_by(Study)%>%
  mutate(Study_length=max(DOS)-min(DOS))%>%
  group_by(ID,Status,Study)%>%
  arrange(ID,Date)%>%
  group_by(ID) %>%
  mutate(days_status= DOS - lag(DOS, default = DOS[1]))%>%
  arrange(ID, Date, DOS) %>%
  transform(days_status = lead(days_status))%>%
  group_by(ID, Status) %>%
  mutate(total_days_status = sum(days_status)) %>%
  mutate(pct_study=total_days_status/Study_length)%>%
  mutate(Species=ifelse(Species=="JUMO","J. monosperma","P. edulis"))


longtermx<-longterm3
longtermx$Date<-as.factor(longtermx$Date)


  

longterm_Ypd<-ggplot(longterm3,aes(Date,Ypd,color=Species)) + geom_point() + geom_line() +
  geom_hline(aes(yintercept=mean_sink,linetype=Species),linetype="dashed") + geom_hline(aes(yintercept=mean_source,linetype=Species),linetype="solid") +
facet_grid(Species~Study,scales="free_x",space="free_x",switch="y")  +  theme(strip.text.x = element_text(
        size = 12, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   )+ scale_color_manual(values=wes_palette("IsleofDogs1",n=2,type='discrete'))+ guides(color="none") + theme(axis.text.x = element_text(angle = 45, vjust=0.5)) + theme(strip.text = element_text(face = "italic")) + labs(y=expression(psi[pd]~(MPa)))

library(grid)
lt = ggplot_gtable(ggplot_build(longterm_Ypd))
library(gtable)
gtable_show_layout(lt)
lt$widths[8] = 1.5*lt$widths[8]
lt$widths[6] = 0.7*lt$widths[6]
grid.draw(lt)

lt_ypd<-as_ggplot(lt)



longterm_frequency<-longterm3%>%
  mutate(Study=ifelse(grepl("SUMO",ID),'SUMO','MDB'))%>%
  mutate(number=1)%>%
  group_by(Study,Species,Status,Year)%>%
  mutate(frequency=sum(number))%>%
  ungroup()%>%
  group_by(Study,Species,Status)%>%
  mutate(aaf=mean(frequency))%>%
  mutate(sem=sem(frequency))%>%
  drop_na()%>%
  mutate(apct=mean(pct_study))%>%
  mutate(sem_pct=sem(pct_study))

#status_frequency<-ggplot(longterm_frequency,aes(Study,aaf,fill=Status,label=ifelse(Species=="JUMO" & Status=="Sink","***",ifelse(Species=="PIED" & Status=="Sink","***",ifelse(Species=="PIED"&Status=="Source","***",ifelse(Species=="JUMO"&Status=="Source","***",ifelse(Species=="JUMO"&Status=="No Limit","***",ifelse(Species=="PIED" & Status=="No Limit","***","")))))))) + geom_text(stat="identity",position=position_dodge(0.9),aes(y=(aaf+sem)+5),vjust=0) + geom_bar(stat="summary",position = "dodge",colour="white") + 
 # geom_errorbar(stat="identity",aes(ymin=aaf-sem, ymax=aaf+sem), width=.2,position=position_dodge(.9)) + ylab("Annual Frequency of Sink & Source Limitation")+ scale_x_discrete(guide = guide_axis(check.overlap = TRUE)) +  scale_fill_manual(name="Limitation",labels=c("No Limit","Sink","Source"),values=wes_palette("GrandBudapest1",n=3,type='discrete')) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
#panel.background = element_blank(), axis.line = element_line(colour = "black")) + facet_wrap(~Species,ncol=1,nrow=2,labeller=labeller(Species=spp.labs)) +  theme(strip.text.x = element_text(
 #       size = 12, face = "italic"),
  #      panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
#panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
 #  strip.background = element_rect(
  #   color="white", fill="white", size=1.5, linetype="solid"
  #   )
  # )

status_pct<-ggplot(longterm_frequency,aes(Study,apct,fill=Status,label=ifelse(Species=="J. monosperma" & Status=="Sink" & Study=="MDB","b",ifelse(Species=="P. edulis" & Status=="Sink" & Study=="MDB","b",ifelse(Species=="P. edulis"&Status=="Source" & Study=="MDB","c",ifelse(Species=="J. monosperma"&Status=="Source"&Study=="MDB","b",ifelse(Species=="J. monosperma"&Status=="No Limit"&Study=="MDB","a",ifelse(Species=="P. edulis" & Status=="No Limit"&Study=="MDB","a",ifelse(Species=="P. edulis" & Study=="SUMO" & Status=="No Limit","a",ifelse(Species=="J. monosperma" & Status=="No Limit"&Study=="SUMO","a",ifelse(Species=="J. monosperma" & Study=="SUMO" & Status=="Sink","b",ifelse(Species=="J. monosperma" & Study=="SUMO" & Status=="Source","c",ifelse(Species=="P. edulis" & Study=="SUMO" & Status=="Sink","b",ifelse(Species=="P. edulis" & Study=="SUMO" & Status=="Source","c","")))))))))))))) + geom_text(stat="identity",position=position_dodge(0.9),aes(y=(apct+sem_pct)+0.05),vjust=0) + geom_bar(stat="summary",position = "dodge",colour="white") + 
  geom_errorbar(stat="identity",aes(ymin=apct-sem_pct, ymax=apct+sem_pct), width=.0,position=position_dodge(.9)) + ylab("Proportion of Study")+ scale_x_discrete(guide = guide_axis(check.overlap = TRUE)) +  scale_fill_manual(name="Limitation Type",labels=c("None","Growth","Photosynthesis"),values=wes_palette("GrandBudapest1",n=3,type='discrete')) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + facet_wrap(~Species,ncol=1,nrow=2) +  theme(strip.text.x = element_text(
        size = 12, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   )  + theme(
    legend.position = c(.95, .95),
    legend.justification = c("right", "top")) +
    theme(text = element_text(size=15))


#+ scale_x_discrete(limits=longterm3$Date, guide = guide_axis(check.overlap = TRUE)) + labs(y="Ypd")


########################
###### time series #####
########################

#time_series_nsc<-ggplot(nsc_ypd2,aes(Date,avg_nsc)) +
  #geom_rect(data=subset(nsc_ypd2,color=="yellow"),aes(xmin=Date,xmax=end,ymin=-Inf,ymax=Inf),fill="yellow")+
 # geom_rect(data=subset(nsc_ypd2,color=="tomato3"),aes(xmin=Date,xmax=end,ymin=-Inf,ymax=Inf),fill="tomato3")+
  #geom_rect(data=subset(nsc_ypd2,color=="green3"),aes(xmin=Date,xmax=end,ymin=-Inf,ymax=Inf),fill="green3")+
 # geom_point(aes(Date,avg_nsc,shape=Tissue)) + geom_line(aes(Date,avg_nsc,color=Tissue)) +
  #geom_errorbar(stat="identity",aes(ymin=avg_nsc-sem_nsc, ymax=avg_nsc+sem_nsc)) +
  #facet_wrap(Species~Treatment,scales="free")

#time_series_ss<-ggplot(nsc_ypd2,aes(Date,avg_ss)) +
 # geom_rect(data=subset(nsc_ypd2,color=="yellow"),aes(xmin=Date,xmax=end,ymin=-Inf,ymax=Inf),fill="yellow")+
 # geom_rect(data=subset(nsc_ypd2,color=="tomato3"),aes(xmin=Date,xmax=end,ymin=-Inf,ymax=Inf),fill="tomato3")+
  #geom_rect(data=subset(nsc_ypd2,color=="green3"),aes(xmin=Date,xmax=end,ymin=-Inf,ymax=Inf),fill="green3")+
  #geom_point(aes(Date,avg_ss,shape=Tissue)) + geom_line(aes(Date,avg_ss,color=Tissue)) +
  #geom_errorbar(stat="identity",aes(ymin=avg_ss-sem_ss, ymax=avg_ss+sem_ss)) +
  #facet_wrap(Species~Treatment,scales="free")

#time_series_st<-ggplot(nsc_ypd2,aes(Date,avg_st)) +
 # geom_rect(data=subset(nsc_ypd2,color=="yellow"),aes(xmin=Date,xmax=end,ymin=-Inf,ymax=Inf),fill="yellow")+
 # geom_rect(data=subset(nsc_ypd2,color=="tomato3"),aes(xmin=Date,xmax=end,ymin=-Inf,ymax=Inf),fill="tomato3")+
  #geom_rect(data=subset(nsc_ypd2,color=="green3"),aes(xmin=Date,xmax=end,ymin=-Inf,ymax=Inf),fill="green3")+
  #geom_point(aes(Date,avg_st,shape=Tissue)) + geom_line(aes(Date,avg_st,color=Tissue)) +
  #geom_errorbar(stat="identity",aes(ymin=avg_st-sem_st, ymax=avg_st+sem_st)) +
  #facet_wrap(Species~Treatment,scales="free")

#nsc_ypd3<-nsc_ypd2%>%
  #mutate(temp=ifelse(Species=="JUMO" & Treatment=="A",NA,ifelse(Species=="JUMO" & Treatment=="H",NA,1)))%>%
  #drop_na()

#timeseries_all<-ggplot(nsc_ypd3,aes(Date,avg_nsc,color=Treatment)) + geom_point() + geom_errorbar(aes(ymin=avg_nsc-sem_nsc,ymax=avg_nsc+sem_nsc)) + geom_line() + facet_wrap(~Species)



###################################
## Photosynthesis at sink source ##
###################################
photo_5<-photo_5%>%
  group_by(Species,Status)%>%
  mutate(sem_A=sem(Photo))%>%
  filter(Status!="Source")

photo_sink<-ggplot(photo_5,aes(Status,avg_A,fill=Status,label=ifelse(Species=="JUMO" & Status=="Sink","b",ifelse(Species=="PIED" & Status=="Sink","b",ifelse(Species=="PIED"&Status=="Source","b",ifelse(Species=="JUMO"&Status=="Source","c",ifelse(Species=="JUMO"&Status=="No Limit","a",ifelse(Species=="PIED" & Status=="No Limit","a","")))))))) + geom_text(stat="identity",position=position_dodge(0.9),aes(y=(avg_A+sem_A)+0.5),vjust=0) + geom_bar(stat="summary",position = "dodge",colour="white") + ylim(0,7)+
  geom_errorbar(stat="identity",aes(ymin=avg_A-sem_A, ymax=avg_A+sem_A), width=.0,position=position_dodge(.9)) + ylab("A (mmol m^2 s^-1")+ scale_x_discrete(guide = guide_axis(check.overlap = TRUE)) +  scale_fill_manual(name="Limitation Type",labels=c("None","Growth","Photosynthesis"),values=wes_palette("GrandBudapest1",n=3,type='discrete')) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + facet_wrap(~Species,ncol=1,nrow=2,labeller=labeller(Species=spp.labs)) +  theme(strip.text.x = element_text(
        size = 12, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + theme(
    legend.position = c(.95, .95),
    legend.justification = c("right", "top")) 


# plot time series of photosynthesis
# make horizontal line for avg A during each status
photo_5$Date<-as.Date(photo_5$Date,"%Y-%m-%d")
photo_time<-ggplot(photo_5,aes(Date,Photo,color=Species,linetype=ID)) + geom_point() + geom_line() + geom_hline(data=subset(photo_5, Status=="Sink"),aes(yintercept=avg_A),linetype="dashed") + 
  geom_hline(data=subset(photo_5, Status=="Source"),aes(yintercept=avg_A),linetype="solid") + 
   geom_hline(data=subset(photo_5, Status=="No Limit"),aes(yintercept=avg_A),linetype="dotdash") + 
facet_wrap(~Species,nrow=2,ncol=1,labeller=labeller(Species=spp.labs))  +  theme(strip.text.x = element_text(
        size = 12, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   )+ scale_color_manual(values=wes_palette("IsleofDogs1",n=2,type='discrete'))+ theme(legend.position = "none")


```

```{r OLD Tables, include=FALSE, eval=FALSE} 
# need to work on how to format tables best....
###############
#### H1 & 2 ###
###############
status_table<-as.data.frame(anova(H1))
title<-c("Table 1"="Source Limitation", "Table 2"="Sink Limitation")

# I need to find a better way to export the xtables for final manuscript

###############
## H3 & H4 ####
###############

#nsctab<-tab_model(NSC.month.status.treatment.species,NSC.month.treatment.species,NSC.month.species,NSC.month.species.statduration,NSC.month.treatment.status,NSC.month.treatment,NSC.month,NSC.status,NSC.treatment,NSC.species,NSC.null,transform=NULL,show.aicc=TRUE,show.p=TRUE,show.intercept=FALSE,title="Linear Mixed Effects Models - NSC",dv.labels="NSC") %>%
 # return()%>%
  #asis_output()


#sstab<-tab_model(sugar.month.status.treatment.species,sugar.month.treatment.species,sugar.month.species,sugar.month.species.statduration,sugar.month.treatment.status,sugar.month.treatment,sugar.month,sugar.status,sugar.treatment,sugar.species,sugar.null,transform=NULL,show.aicc=TRUE,show.p=TRUE,show.intercept=FALSE,title="Linear Mixed Effects Models - Sugar",dv.labels="Sugar")

#sttab<-tab_model(starch.month.status.treatment.species,starch.month.treatment.species,starch.month.species,starch.month.species.statduration,starch.month.treatment.status,starch.month.treatment,starch.month,starch.status,starch.treatment,starch.species,starch.null,transform=NULL,show.aicc=TRUE,show.p=TRUE,show.intercept=FALSE,title="Linear Mixed Effects Models - Starch",dv.labels="Starch")

#nscaic<-as.data.frame(NSC.month.status.treatment.species)
#ssaic<-as.data.frame(SSAICctab)
#staic<-as.data.frame(StAICctab)

#################
####### H5 ######
#################
h5.1<-as.data.frame(summary(H5.1)[[1]])
h5.1tab<-xtable(H5.1)
h5.1tg<-tableGrob(h5.1tab)
ggsave("H5.pdf",h5.1tg,width=11,height=3)


#######################
## Intercept Models ###
#######################




```

```{r OLD multivariate / multivariable approach, include=FALSE, eval=FALSE}

#library(dplyr)
# let's start by merging the growth and photosynthesis data
#growth<-growth%>%select(-Date)
#wp_photo_final<-wp_photo_final%>%select(-Date)
#growth_gas<-merge(wp_photo_final,g_wp)%>%distinct()%>%
 # dplyr::select(Year,Month,Species,ID,Ypd,pct_photo,pct_growth)
# then, create NSC pct data
#NSC$Month<-as.numeric(NSC$Month)
NSC_1<-NSC%>%
 drop_na()%>%
  dplyr::select(Year,Month,ID,Species,Tot.NSC,Starch,Tot.Sug,Tissue)%>% # select only columns i need
  group_by(Year,Month,ID)%>% # group by time / tree for next analysis
  mutate(tot.NSC=sum(Tot.NSC))%>% # calculate tree-level total nsc at each time-point
  mutate(tot.ss=sum(Tot.Sug))%>% # calculate tree-level total sugar at each time-point
  mutate(tot.st=sum(Starch))%>% # calculate tree-level total starch at each time-point
  dplyr::group_by(Year,Month,ID,Tissue)%>%
  dplyr::mutate(avg_NSC=mean(Tot.NSC))%>%
  dplyr::mutate(avg_SS=mean(Tot.Sug))%>%
  dplyr::mutate(avg_ST=mean(Starch))%>%
  dplyr::group_by(ID,Tissue)%>%
  dplyr::mutate(max_NSC=max(avg_NSC))%>%
  dplyr::mutate(max_sug=max(avg_SS))%>%
  dplyr::mutate(max_starch=max(avg_ST))%>%
  mutate(szn=ifelse(Month=="06", "June - September",ifelse(Month=="07","June - September",ifelse(Month=="08","June - September",ifelse(Month=="09","June - September","October-May")))))%>%
  dplyr::group_by(Year,Month,ID,Tissue)%>%
  dplyr::mutate(pct_NSC=avg_NSC/max_NSC)%>%
  dplyr::mutate(pct_sug=avg_SS/max_sug)%>%
  dplyr::mutate(pct_starch=avg_ST/max_starch)%>%
  dplyr::select(-avg_NSC,-avg_SS,-avg_ST,-Tot.NSC,-Tot.Sug,-Starch,-max_NSC,-max_sug,-max_starch)%>%
  drop_na()%>%
  mutate(Species=ifelse(Species=="JUMO","J. monosperma","P. edulis"))
#wp_spp$Month<-as.numeric(wp_spp$Month)
#wp_spp<-wp_spp%>%dplyr::select(-ID)
# then, merge NSC 
NSC2<-merge(NSC_1,wp)

# then, construct some models that describe the change in NSC with variation in growth, photosynthesis and WP
#### START HERE...........
#ctrl=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=100000))
#library(lmerTest)
#model.nsc<-lme4::lmer(pct_NSC~abs(Ypd)*Season*Tissue*(1|ID),data=NSC2,control=ctrl) 
#model.sug<-lme4::lmer(pct_sug~abs(Ypd)*Season*Tissue*(1|ID),data=NSC2,control=ctrl) 
#model.st<-lme4::lmer(pct_starch~abs(Ypd)*Season*Tissue*(1|ID),data=NSC2,control=ctrl) 
#library(sjPlot)
#nsc.plot<-plot_model(model.nsc,show.values = TRUE, show.p=TRUE)
#sug.plot<-plot_model(model.sug,show.values = TRUE, show.p=TRUE)
#st.plot<-plot_model(model.st,show.values = TRUE, show.p=TRUE)
#all_sj<-ggarrange(nsc.plot,sug.plot,st.plot,nrow=3)

#nsc_tab<-tab_model(model.nsc, 
 #                  terms=NULL,
  #                dv.labels= "Effects of Water Stress on Total NSC")
#sug_tab<-tab_model(model.sug, 
 #                 show.re.var= TRUE,
  #                terms=NULL,
   #               dv.labels= "Effects of Water Stress on Total Sugar")
#st_tab<-tab_model(model.st, 
 #                 show.re.var= TRUE,
  #                terms=NULL,
   #               dv.labels= "Effects of Water Stress on Starch")



# this model approach is limited because of different resolutions for each dataset
# have to drop the poly month effect so this model won't account for seasonal variation...
# perhaps multivariate NOT multivariable approach is better?
# I can still visually show the different responses though...
############ SHOW THE RESPONSES OF A, G, NSC to variation in psi ####################
nsc<-NSC2%>%
  dplyr::select(Year,Month,Species,Tissue,pct_NSC,Ypd,szn)%>%
  dplyr::rename(pct=pct_NSC)%>%
  drop_na()%>%
  dplyr::mutate(variable="NSC")
sug<-NSC2%>%dplyr::select(Year,Month,Species,Tissue,pct_sug,Ypd,szn)%>%dplyr::rename(pct=pct_sug)%>%drop_na()%>%
  dplyr::mutate(variable="Sugar")
st<-NSC2%>%dplyr::select(Year,Month,Species,Tissue,pct_starch,Ypd,szn)%>%dplyr::rename(pct=pct_starch)%>%drop_na()%>%
  dplyr::mutate(variable="Starch")
mv<-rbind(nsc,sug,st)
mv$Ypd<-as.numeric(mv$Ypd)

szn_plot<-ggplot(mv,aes(abs(Ypd),pct,color=variable)) +  geom_smooth(method="gam",formula=y~s(log(x),bs="cs",k=1),se=TRUE) +  facet_wrap(szn~Species,scales="free") + ylab("% of Maximum") + xlab("Predawn Water Potential (-MPa)") + scale_x_continuous(guide = guide_axis(check.overlap = TRUE)) +  scale_color_manual(values=wes_palette("GrandBudapest1",n=3,type='continuous')) + theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(strip.text.x = element_text(
        size = 20, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   )



nsc_plot<-ggplot(mv,aes(abs(Ypd),pct,color=variable)) +  geom_smooth(method="gam",formula=y~s(log(x),bs="cs",k=1),se=TRUE) +  facet_wrap(~Species,scales="free") + ylab("% of Maximum") + xlab("Predawn Water Potential (-MPa)") + scale_x_continuous(guide = guide_axis(check.overlap = TRUE)) +  scale_color_manual(values=wes_palette("GrandBudapest1",n=3,type='continuous')) + theme(axis.text.x = element_text(angle = 0,size=12),axis.text.y=element_text(size=12),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(strip.text.x = element_text(
        size = 20, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   )




##### plot by tissue and component vs Ypd
#szn_nsc<-mv%>%
 # filter(variable!="Growth")%>%
  #filter(variable!="Photo")

#ct_plot<-ggplot(mv,aes(abs(Ypd),pct,color=variable)) +  geom_smooth(method="gam",formula=y~s(log(x),bs="cs",k=1),se=FALSE) +  facet_wrap(~Species,scales="free") + ylab("% of Maximum") + xlab("Predawn Water Potential (-MPa)") + scale_x_continuous(guide = guide_axis(check.overlap = TRUE)) +  scale_color_manual(values=wes_palette("Zissou1",n=12,type='continuous')) + theme(axis.text.x = element_text(angle = 0),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
#panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(strip.text.x = element_text(
 #       size = 12, face = "italic"),
  #      panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
#panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
 #  strip.background = element_rect(
  #   color="white", fill="white", size=1.5, linetype="solid"
   #  )
   #)


########### Does the effect of Ypd on NSC change based on season? ##############

#ct_plot_szn<-ggplot(szn_nsc,aes(abs(Ypd),pct,color=variable,linetype=Season)) +  geom_smooth(method="lm",formula=y~s(log(x),bs="cs",k=1),se=FALSE) +  facet_wrap(Species~variable,scales="free") + ylab("% of Maximum") + xlab("Predawn Water Potential (-MPa)") + scale_x_continuous(guide = guide_axis(check.overlap = TRUE)) +  scale_color_manual(values=wes_palette("Zissou1",n=12,type='continuous')) + theme(axis.text.x = element_text(angle = 0),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
#panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(strip.text.x = element_text(
 #       size = 12, face = "italic"),
  #      panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
#panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
 #  strip.background = element_rect(
  #   color="white", fill="white", size=1.5, linetype="solid"
   #  )
   #)



######### NSC time-series ###############

#nsc_time<-ggplot(NSC,aes(Date,Tot.NSC,color=ID)) + geom_point()+ facet_wrap(Tissue~Species) + theme(legend.position = "none")


#nsc_spp<-ggplot(data=subset(mv2,variable=="NSC"),aes(Month,pct,color=Year,group=Year)) + geom_point() + geom_line() + facet_wrap(Tissue~Species) + ylab("% of Maximum") + xlab("Month") + scale_x_discrete(guide = guide_axis(check.overlap = TRUE)) +  scale_color_manual(values=wes_palette("GrandBudapest1",n=5,type='continuous')) + theme(axis.text.x = element_text(angle = 90),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
#panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(strip.text.x = element_text(
 #       size = 12, face = "italic"),
  #      panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
#panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
 #  strip.background = element_rect(
  #   color="white", fill="white", size=1.5, linetype="solid"
   #  )
   #) + ggtitle("Total NSC")

#sugar_spp<-ggplot(data=subset(mv2,variable=="Sugar"),aes(Month,pct,color=Year,group=Year))+ geom_point() + geom_line() + facet_wrap(Tissue~Species) + ylab("% of Maximum") + xlab("Month") + scale_x_discrete(guide = guide_axis(check.overlap = TRUE)) +  scale_color_manual(values=wes_palette("GrandBudapest1",n=5,type='continuous')) + theme(axis.text.x = element_text(angle = 90),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
#panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(strip.text.x = element_text(
 #       size = 12, face = "italic"),
  #      panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
#panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
 #  strip.background = element_rect(
  #   color="white", fill="white", size=1.5, linetype="solid"
   #  )
   #) + ggtitle("Sugar")


#starch_spp<-ggplot(data=subset(mv2,variable=="Starch"),aes(Month,pct,color=Year,group=Year))+ geom_point() + geom_line() + facet_wrap(Tissue~Species) + ylab("% of Maximum") + xlab("Month") + scale_x_discrete(guide = guide_axis(check.overlap = TRUE)) +  scale_color_manual(values=wes_palette("GrandBudapest1",n=5,type='continuous')) + theme(axis.text.x = element_text(angle = 90),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
#panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(strip.text.x = element_text(
 #       size = 12, face = "italic"),
  #      panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
#panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
 #  strip.background = element_rect(
  #   color="white", fill="white", size=1.5, linetype="solid"
   #  )
   #)+ ggtitle("Starch")



#agn_time<-ggplot(data=mv_new,aes(Date,pct,color=variable)) + geom_line(group=2) + facet_wrap(~Species) 


#agn_time<-ggplot(mv_new,aes(Date,pct,color=variable,group=variable)) + geom_line() + facet_wrap(~Species,scales="free") + ylab("% of Maximum") + xlab("Date") + scale_x_discrete(guide = guide_axis(check.overlap = TRUE)) +  scale_color_manual(values=wes_palette("Zissou1",n=5,type='continuous')) + theme(axis.text.x = element_text(angle = 90),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
#panel.background = element_blank(), axis.line = element_line(colour = "black"))  +  theme(strip.text.x = element_text(
 #       size = 12, face = "italic"),
  #      panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
#panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
 #  strip.background = element_rect(
  #   color="white", fill="white", size=1.5, linetype="solid"
   #  )
   #)








```

```{r OLD Time Series, include=FALSE,eval=FALSE}


sugar_d <- NSC %>%
  dplyr::select(Year, Month, Date, Species, ID, Tissue, Tot.Sug, Tot.NSC, Starch)%>%
  drop_na()%>%
  distinct()
sugar_lt <- sugar_d %>%
  dplyr::ungroup() %>%
  dplyr::select(Year, Month, Date, Species, ID, Tissue, Tot.Sug, Tot.NSC, Starch) %>%
  dplyr::ungroup()%>%
  dplyr::group_by(Year,Month,ID,Tissue) %>%
  dplyr::mutate(Sugar = sum(Tot.Sug))%>%
  dplyr::mutate(NSC = sum(Tot.NSC))%>%
  dplyr::mutate(Starch = sum(Starch)) %>%
  dplyr::select(Year,Month,Date,Species,ID,Tissue,Sugar,NSC,Starch)%>%
  distinct()

nsc<-sugar_lt
WP4<-WP3%>%
  dplyr::select(Year,Month,Species,ID,Ypd)
nsc_ypd<-merge(nsc,WP4)
nsc_ypd$Ypd<-as.numeric(nsc_ypd$Ypd)
nsc_ypd<-merge(nsc_ypd,treats)%>%
  group_by(Species,Treatment,Date,Tissue)%>%
  mutate(avg_nsc=mean(NSC))%>%
  mutate(avg_ss=mean(Sugar))%>%
  mutate(avg_st=mean(Starch))%>%
  mutate(sem_nsc=sem(NSC))%>%
  mutate(sem_ss=sem(Sugar))%>%
  mutate(sem_st=sem(Starch))%>%
  ungroup()%>%
  group_by(Date,Treatment)%>%
  mutate(mean_ypd=mean(Ypd))%>%
  distinct()%>%
  ungroup()%>%
  dplyr::select(-Date,-Treatment,-mean_ypd)

##### NEED TO WORK ON NSC ANALYSES SOME MORE!!!!


nsc_ypd_intercepts<-merge(nsc_ypd,intercepts)%>%
  drop_na()%>%
  group_by(Species)%>%
  mutate(sink_source=ifelse(xint<xint_photo,1,0))

nscypd1<-nsc_ypd_intercepts%>%filter(sink_source=="1")%>%
  mutate(Status=ifelse(Ypd<=xint, "Sink", ifelse(Ypd>=xint_photo, "No Limit", "Source")))
#nscypd2<-nsc_ypd_intercepts%>%
    #filter(sink_source=="0")%>%
  #mutate(Status=ifelse(Ypd<=xint_photo, "Source", ifelse(Ypd>=xint, "No Limit", "Sink")))
#nscypd_intercepts<-rbind(nscypd1,nscypd2)%>%
  #mutate(color=ifelse(Status=="Source","tomato3",ifelse(Status=="Sink","yellow","green3")))
nscypd_intercepts<-nscypd1

nsc_ypd2<-nscypd_intercepts%>%
  select(Species,ID,Treatment,Date,Tissue,avg_nsc,avg_ss,avg_st,sem_nsc,sem_ss,sem_st,mean_ypd,Status) %>%
  distinct()%>%
  arrange(Species,Treatment,Date)%>%
  group_by(Species,Treatment) %>%
  mutate(end = lead(Date))
  
  




```

```{r OLD Delta Intercepts, include=FALSE,eval=FALSE}
delta_intercepts<-intercepts%>%
  ungroup()%>%
  mutate(delta_int=xint_photo-xint)


```

```{r OLD 20 year reconstructions, include=FALSE, echo=FALSE,eval=FALSE}
days_recon<-read.csv("/Users/alexthompson/Dropbox/PhD data/SUMO data/days_reconstruction.csv")
days_recon$Date<-as.Date(days_recon$Date,"%Y-%m-%d")
longterm<-read.csv("/Users/alexthompson/Dropbox/PhD data/SUMO data/longterm_PWP.csv")%>%
  dplyr::mutate(Species=ifelse(Species=="JUMO","J. monosperma","P. edulis"))
longterm$Date<-as.Date(longterm$Date)
longterm$Date<-as.numeric(longterm$Date)
lg<-merge(longterm,days_recon)
long_int<-merge(lg,growth_int)%>%
  dplyr::mutate(Status=ifelse(Ypd<=pred_Ypd,interval,NA))%>%
  drop_na()%>%
  dplyr::arrange(ID,DOS)%>%
  dplyr::group_by(ID,DOS)%>%
  dplyr::mutate(Status=min(interval))%>%
  distinct(ID,DOS,.keep_all = TRUE)%>%
  dplyr::group_by(ID) %>%
  dplyr::mutate(days_status= DOS - lag(DOS, default = DOS[1]))%>%
  dplyr::arrange(ID, DOS) %>%
  transform(days_status = lead(days_status))%>%
  drop_na()%>%
  dplyr::group_by(ID, Status) %>%
  dplyr::mutate(total_days_status = sum(days_status)) %>%
  dplyr::select(Species, Year,ID, DOS, Status, total_days_status, Ypd) %>%
  dplyr::mutate(pct_study=total_days_status/8884)%>%
  distinct(Year,ID,Status,total_days_status, .keep_all = TRUE)%>%
  dplyr::group_by(Species,Status)%>%
  dplyr::mutate(avg_pct=mean(pct_study)*100)%>%
  dplyr::mutate(sem_pct=sem(pct_study))%>%
  dplyr::select(Species,Status,pct_study,avg_pct,sem_pct)%>%
  dplyr::mutate(Variable="Growth")

p_long_int<-merge(lg,photo_int)%>%
  dplyr::mutate(Status=ifelse(Ypd<=pred_Ypd,interval,NA))%>%
  drop_na()%>%
  dplyr::arrange(ID,DOS)%>%
  dplyr::group_by(ID,DOS)%>%
  dplyr::mutate(Status=min(interval))%>%
  distinct(ID,DOS,.keep_all = TRUE)%>%
  dplyr::group_by(ID) %>%
  dplyr::mutate(days_status= DOS - lag(DOS, default = DOS[1]))%>%
  dplyr::arrange(ID, DOS) %>%
  transform(days_status = lead(days_status))%>%
  drop_na()%>%
  dplyr::group_by(ID, Status) %>%
  dplyr::mutate(total_days_status = sum(days_status)) %>%
  dplyr::select(Species, Year,ID, DOS, Status, total_days_status, Ypd) %>%
  dplyr::mutate(pct_study=total_days_status/8884)%>%
  distinct(Year,ID,Status,total_days_status, .keep_all = TRUE)%>%
  dplyr::group_by(Species,Status)%>%
  dplyr::mutate(avg_pct=mean(pct_study)*100)%>%
  dplyr::mutate(sem_pct=sem(pct_study))%>%
  dplyr::select(Species,Status,pct_study,avg_pct,sem_pct)%>%
  dplyr::mutate(Variable="Photosynthesis")

long_limit<-rbind(long_int,p_long_int)%>%
  mutate(Range=ifelse(avg_pct<=10, "0-10",ifelse(avg_pct<=25,"10-25",ifelse(avg_pct<=50, "25-50",ifelse(avg_pct>50,"50+",NA)))))
long_limit$Status<-as.factor(long_limit$Status)

# how do I do the circular plot idea?!?
ten<-long_limit%>%
  dplyr::filter(Status==10)%>%distinct(Species,Status,Range,Variable)
twofive<-long_limit%>%
  dplyr::filter(Status==25)%>%distinct(Species,Status,Range,Variable)
fifty<-long_limit%>%
  dplyr::filter(Status==50)%>%distinct(Species,Status,Range,Variable)
sevenfive<-long_limit%>%
  dplyr::filter(Status==75)%>%distinct(Species,Status,Range,Variable)
lg_lim_plot<-ggplot(long_limit,aes("","")) + geom_point(data=sevenfive,size=125,aes(color=Range)) + geom_point(data=sevenfive,size=125,pch=21,color="white") + geom_text(data=sevenfive,label="75%",color="white",hjust=5.9) + geom_point(data=fifty,size=100,aes(color=Range))  +geom_point(data=fifty,size=100,pch=21,color="white") + geom_text(data=fifty,label="50%",color="white",hjust=4.7) + geom_point(data=twofive,size=75,aes(color=Range)) +geom_point(data=twofive,size=75,pch=21,color="white") + geom_text(data=twofive,label="25%",color="white",hjust=3.5) + geom_point(data=ten,size=50,aes(color=Range)) + geom_point(data=ten,size=50,pch=21,color="white") + geom_text(data=ten,label="10%",color="white",hjust=2.3) + guides(color = guide_legend(override.aes = list(size = 10))) + facet_wrap(Variable~Species) + theme_void() +  scale_color_manual(values=wes_palette("GrandBudapest1",n=4,type='discrete')) + theme(legend.position = c(.98,.5)) + labs(color="Percentage of Study Period") + theme(panel.spacing.x=unit(-2, "lines"),strip.text.x = element_text(
        size = 15, face = "italic"))

  

ggarrange(lim_plot,lg_lim_plot,ncol=1,nrow=2,common.legend = TRUE, labels="AUTO")
















  ungroup()%>%
  group_by(Species)%>%
  mutate(mean_sink=mean(xint))%>%
  mutate(mean_source=mean(xint_photo))%>%
  select(Species, mean_sink, mean_source)%>%
  distinct()
longterm_b<-nsc_ypd_days%>%
  select(Year,Date,Species,ID,Ypd)%>%
  group_by(Year,Species)%>%
  ungroup()
longterm_b$ID <- paste0(longterm_b$ID, "_SUMO")
longterm_c<-merge(longterm_b,longterm_intercept)
longterm_c$Date<-as.Date(as.numeric(longterm_c$Date,"%Y/%m/%d"))
longterm2<-merge(longterm,longterm_intercept)
longterm2$Date<-as.Date(longterm2$Date,"%Y-%m-%d")
longterm2.1<-rbind(longterm2,longterm_c)
longterm2.1$Date<-as.Date(longterm2.1$Date,"%Y-%m-%d")
longterm3<-merge(longterm2.1,days_recon)%>%
  group_by(Date,Species)%>%
  mutate(Status=ifelse(Ypd<=mean_source,"Source",ifelse(Ypd>=mean_sink,"No Limit","Sink")))%>%
  drop_na()%>%
  arrange(Species,ID,Date,Status)%>%
  group_by(Species,ID) %>%
  distinct()%>%
  mutate(days_status= DOS - lag(DOS, default = DOS[1]))%>%
  arrange(Species,ID, Date, DOS) %>%
  mutate(days_status=ifelse(lead(Year)==Year,lead(days_status),0))%>%
  group_by(ID)%>%
  mutate(max_date=max(Date))%>%
  mutate(drop=ifelse(Date==max_date,NA,"keep"))%>%
  drop_na()%>%
  select(-drop,-max_date)
longterm3$Date<-as.Date(longterm3$Date,"%Y-%m-%d")
last_day<-longterm3%>%
  filter(days_status==0)
day<-days_recon%>%
  mutate(Year=year(Date))%>%
  group_by(Year)%>%
  filter(Date==last(Date))
last_day<-rbind(last_day,day)%>%
  group_by(Year)%>%
  mutate(days_status=last(DOS)-DOS)%>%
  drop_na()
longterm4<-rbind(longterm3,last_day)%>%
  filter(days_status>0)%>%
  group_by(Species,ID,Status,Year)%>%
  mutate(annual_days=sum(days_status))  %>%
  group_by(Species,Year,Status)%>%
  mutate(sem=sem(annual_days))%>%
  mutate(avg_annual=mean(annual_days))
longterm_annual<-longterm4%>%
  distinct(Species,Year,Status,avg_annual,.keep_all=TRUE)%>%
  select(Species,Year,Status,avg_annual,sem)

longterm_frequency<-longterm3%>%
  mutate(number=1)%>%
  group_by(Species,ID,Status,Year)%>%
  mutate(frequency=sum(number))%>%
  group_by(Species,Status)%>%
  mutate(afreq=mean(frequency))%>%
  distinct(Species,afreq)





# NOW, doing the ring plots for long-term MDB data
pg_limit<-rbind(g_days,p_days)%>%
  mutate(Range=ifelse(avg_pct<=10, "0-10",ifelse(avg_pct<=25,"10-25",ifelse(avg_pct<=50, "25-50",ifelse(avg_pct>50,"50+",NA)))))
pg_limit$Status<-as.factor(pg_limit$Status)

# how do I do the circular plot idea?!?
ten<-pg_limit%>%
  dplyr::filter(Status==10)%>%distinct(Species,Status,Range,Variable)
twofive<-pg_limit%>%
  dplyr::filter(Status==25)%>%distinct(Species,Status,Range,Variable)
fifty<-pg_limit%>%
  dplyr::filter(Status==50)%>%distinct(Species,Status,Range,Variable)
sevenfive<-pg_limit%>%
  dplyr::filter(Status==75)%>%distinct(Species,Status,Range,Variable)
library(ggrepel)
lim_plot<-ggplot(pg_limit,aes("","")) + geom_point(data=sevenfive,size=125,aes(color=Range)) + geom_point(data=sevenfive,size=125,pch=21,color="white") + geom_text(data=sevenfive,label="75%",color="white",hjust=5.9) + geom_point(data=fifty,size=100,aes(color=Range))  +geom_point(data=fifty,size=100,pch=21,color="white") + geom_text(data=fifty,label="50%",color="white",hjust=4.7) + geom_point(data=twofive,size=75,aes(color=Range)) +geom_point(data=twofive,size=75,pch=21,color="white") + geom_text(data=twofive,label="25%",color="white",hjust=3.5) + geom_point(data=ten,size=50,aes(color=Range)) + geom_point(data=ten,size=50,pch=21,color="white") + geom_text(data=ten,label="10%",color="white",hjust=2.3) + guides(color = guide_legend(override.aes = list(size = 10))) + facet_wrap(Variable~Species) + theme_void() +  scale_color_manual(values=wes_palette("GrandBudapest1",n=4,type='discrete')) + theme(legend.position = c(.98,.5)) + labs(color="Percentage of Study Period") + theme(panel.spacing.x=unit(-2, "lines"),strip.text.x = element_text(
        size = 15, face = "italic"))








#### old code, keep in case ### 
#group_by(Species,ID, Status) %>%
 # mutate(total_days_status = sum(days_status)) %>%
  #group_by(Species,ID,Year,Status)%>%
  #mutate(annual_status_days=sum(days_status))%>%

  #select(Species, Year, ID, Status, total_days_status, annual_status_days,sem) %>%
  #group_by(Species,ID) %>%
  #distinct()%>%
  #mutate(pct_study=total_days_status/8932)%>%
  #distinct()%>%
  #drop_na()
```

``` {r OLD individual analysis, include=FALSE,eval=FALSE}
#### ONLY RUN THIS CODE TO LOOK AT INDIVIDUAL TREE STUFF ###
#### let's make a regression of proportion of time vs. threshold, colored by treatment ########
## Step 1: redo analysis at individual tree level, SUMO only! ##
days_recon<-read.csv("/Users/alexthompson/Dropbox/PhD data/SUMO data/days_reconstruction.csv")
days_recon$Date<-as.Date(days_recon$Date,"%Y-%m-%d")
longterm<-read.csv("/Users/alexthompson/Dropbox/PhD data/SUMO data/longterm_PWP.csv")
longterm_intercept_indvidual<-nsc_ypd_intercepts%>%
  ungroup()%>%
  select(Species, ID, xint, xint_photo,Treatment)%>%
  distinct()
longterm_b<-nsc_ypd_days%>%
  select(Year,Date,Species,ID,Ypd,Treatment)%>%
  group_by(Year,Species)%>%
  ungroup()
#longterm_b$ID <- paste0(longterm_b$ID, "_SUMO")
longterm_c<-merge(longterm_b,longterm_intercept_indvidual)%>%
  filter(-Year)
longterm_c$Date<-as.Date(as.numeric(longterm_c$Date,"%Y/%m/%d"))
#longterm2<-longterm_intercept_indvidual

longterm3<-merge(longterm_c,days_recon)%>%
  group_by(Date,ID)%>%
  mutate(Status=ifelse(Ypd<=xint_photo,"Source",ifelse(Ypd>=xint,"No Limit","Sink")))%>%
  drop_na()%>%
  arrange(Species,ID,Date,Status)%>%
  group_by(ID) %>%
  distinct()%>%
  mutate(days_status= DOS - lag(DOS, default = DOS[1]))%>%
  arrange(Species,ID, Date, DOS) %>%
  mutate(days_status=ifelse(lead(Year)==Year,lead(days_status),0))%>%
  group_by(ID)%>%
  mutate(max_date=max(Date))%>%
  mutate(drop=ifelse(Date==max_date,NA,"keep"))%>%
  drop_na()%>%
  select(-drop,-max_date)
longterm3$Date<-as.Date(longterm3$Date,"%Y-%m-%d")
last_day<-longterm3%>%
  filter(days_status==0)
day<-days_recon%>%
  mutate(Year=year(Date))%>%
  group_by(Year)%>%
  filter(Date==last(Date))
last_day<-rbind(last_day,day)%>%
  group_by(Year)%>%
  mutate(days_status=last(DOS)-DOS)%>%
  drop_na()
longterm4<-rbind(longterm3,last_day)%>%
  filter(days_status>0)%>%
  group_by(ID,Status,Year)%>%
  mutate(annual_days=sum(days_status))  %>%
  group_by(ID,Year,Status)%>%
  mutate(sem=sem(annual_days))%>%
  mutate(avg_annual=mean(annual_days))
longterm_annual<-longterm4%>%
  distinct(ID,Year,Status,avg_annual,.keep_all=TRUE)%>%
  select(Species,ID,Year,Status,avg_annual,sem,Treatment)


longterm3<-longterm3%>%
  group_by(ID)%>%
  mutate(Study_length=max(DOS)-min(DOS))%>%
  group_by(ID,Status)%>%
  arrange(ID,Date)%>%
  group_by(ID) %>%
  mutate(days_status= DOS - lag(DOS, default = DOS[1]))%>%
  arrange(ID, Date, DOS) %>%
  transform(days_status = lead(days_status))%>%
  group_by(ID, Status) %>%
  mutate(total_days_status = sum(days_status)) %>%
  mutate(pct_study=total_days_status/Study_length)

longterm_frequency<-longterm3%>%
  mutate(number=1)%>%
  group_by(ID,Status,Year)%>%
  mutate(frequency=sum(number))%>%
  ungroup()%>%
  group_by(ID,Status)%>%
  mutate(aaf=mean(frequency))%>%
  mutate(sem=sem(frequency))%>%
  mutate(apct=mean(pct_study))%>%
  mutate(sem_pct=sem(pct_study))%>%
  filter(Status!="No Limit")


tp<-ggplot(longterm_frequency,aes(xint,apct)) + geom_point(aes(shape=Treatment)) + facet_wrap(Status~Species) + geom_smooth(method="lm")

# one JUMO spent 100% of the time in a non-limited state
# for source limitation, we only have two observations for both species? Weird. 
# CHECK ON SOURCE LIMITATION #
source_check1<-longterm3%>%
  distinct(Species,ID,Status)%>%
  filter(Status=="Source")
source_check2<-longterm_frequency%>%
  distinct(ID,Status)%>%
  filter(Status=="Source")


```

``` {r OLD photo time series, include=FALSE,eval=FALSE}

photo_one<-wp_photo_final_for_anova%>%
  rename(xint_photo=xint)%>%
  select(-type)
new_one<-merge(photo_one,g_wp_for_anova)%>%
  distinct()
photo_four<-merge(photo3, new_one)
photo_5<-merge(photo_four,WP4)%>%
  mutate(Status=ifelse(Ypd<=xint_photo, "Source", ifelse(Ypd>=xint, "No Limit", "Sink")))%>%
  group_by(Species,Status)%>%
  mutate(avg_A=mean(Photo))

photo_sink<-ggplot(photo_5,aes(Species,Photo,fill=Status)) + geom_bar(stat="summary",position = "dodge",colour="white")

```



```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.pos = 'H')
knitr::opts_chunk$set(fig.width=10, fig.height=6)
```
Affiliations:  
^1^School of the Environment, Washington State University, Pullman, WA, 99164  
^2^ School of Natural Resources and the Environment, University of Arizona, Tucson, AZ, 85719, USA 
^3^Los Alamos National Laboratory, Earth & Environmental Sciences Division, Los Alamos, NM, USA  
^4^Plant Ecology Research Laboratory PERL, School of Architecture, Civil and Environmental Engineering, EPFL, CH-1015 Lausanne, Switzerland  
^5^Community Ecology Unit, Swiss Federal Institute for Forest, Snow and Landscape WSL, CH-1015 Lausanne, Switzerland  
^6^Estación Experimental Aula Dei (EEAD-CSIC), Zaragoza, Spain  
^7^Center for Ecosystem Science and Society, Northern Arizona University, Flagstaff, AZ, 86011  
^8^Department of Ecosystem Science and Sustainability, Colorado State University, Fort Collins CO 80523 and USDA Forest Service, Rocky Mountain Research Station, Fort Collins CO 80526  
^9^Department of Entomology, University of Wisconsin, Madison, WI, 53706  
^10^Atmospheric Sciences and Global Change Division, Pacific Northwest National Lab, PO Box 999, Richland, WA, 99352  
^11^School of Biological Sciences, Washington State University, PO Box 644236, Pullman, WA 99164-4236  
  
__Target journal: Nature Plants as a Letter__  
  
Citation Count:  /30  
Abstract Word Count:  /150  
Main Text Word Count:  /2000  
  
__Abstract__   
  
Plant survival depends on a careful balance between carbon supply and demand [@Loomis; @Chapin1990; @Korner2003; @Wiley2012a; @Korner2015; @Monson2021; @McDowell2022]. When carbon supply becomes limited, plants may buffer demand by using stored carbohydrates (starch) [@Chapin1990; @Korner2003; @Wiley2012a; @McDowell2022]. During drought, starch may accumulate if growth stops before photosynthesis [@Hsiao1973; @Korner2003; @Muller2011]. This expectation is pervasive, yet few studies have combined simultaneous measurements of drought, photosynthesis, growth, and carbon storage to test this. Using a field experiment with mature trees and the longest continuous dataset of plant water potential ($\psi_{pd}$), we show that growth and photosynthesis slow in parallel as $\psi_{pd}$ declines, preventing carbon storage in two semi-arid conifers ( _J. monosperma_ and _P. edulis_). During experimental drought, growth and photosynthesis were frequently limited. Yet, twenty-five years of $\psi_{pd}$ measurements suggest that the co-limitation of growth and photosynthesis is rare, except under extreme conditions such as drought. We offer an alternative perspective on how plants use carbon that views growth and photosynthesis as independent processes both regulated by water availability.  
    
__Main__   
  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Drought constrains plant growth and photosynthesis by reducing cell turgor, preventing cell exapansion and closing stomata, though these symptoms are often not simultaneous [@Hsiao1973; @Korner2003]. Growth tends to respond more rapidly than photosynthesis to water stress [@Hsiao1973; @Korner2003; @Muller2011]. When drought inhibits growth [otherwise referred to as _sink limitation_; @Korner2003] ongoing photosynthesis can provide carbohydrates to be stored as non-structural carbohydrates (NSCs) [@Chapin1990; @Korner2003]. NSCs, which include sugar and starch, provide an important source of metabolic substrate for plants during drought, after photosynthesis stops [otherwise referred to as _source limitation_; @Korner2003]. NSCs can be used to support respiration [@Collins2021], synthesize defense compounds [@Herms1992; @Lerdau1994; @Trowbridge2021], avoid turgor loss [@Sapes2020], and delay plant death [@OBrien2014; @Lauder2019; @McDowell2022]. Ultimately, carbohydrate accumulation in plants experiencing drought-induced growth limitation remains an important yet unproven hypothesis in plant ecology. We test this core idea in plant drought response using mature trees with simultaneous measurements of photosynthesis, growth, NSCs, and plant water potential.  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Drought-induced limitation to growth occurs as $\psi_{pd}$ becomes more negative, leading to a decline in cell turgor, preventing cell division and elongation [@Priestley1929]. Eventually, drought stress leads to stomatal closure, photosynthesis stops, and plants enter a state where survival depends on the consumption of stored NSC [@McDowell2022; @Korner2003]. Photosynthesis may decline less quickly than growth during drought, but this has only been tested in a few species [@Hsiao1973; @Muller2011]. This tendency to overgeneralize results from a few organisms, often growing under experimental greenhouse conditions, and at early ontogenetic stages, to all plants may be the source of significant error in modern vegetation models [@Hartmann2018; @Franklin2020].  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  Few studies use mature trees in field experiments to evaluate carbon source-sink dynamics under drought [@Hartmann2018]. Surprisingly, no studies have simultaneously measured changes in growth, photosynthesis and starch accumulation along a $\psi_{pd}$ gradient on mature trees in the field [although @Trowbridge2021 did consider these questions in the context of plant defense]. To address these gaps, we leverage data from a 25-year, monthly $\psi_{pd}$ monitoring project (Mesita Del Buey, hereafter MDB) and a field drought experiment (the Los Alamos Survival Mortality Experiment, hereafter SUMO). MDB was established to monitor the long-term water status of mature trees in a piñon-juniper woodland of northern New Mexico from 1992 to 2016 and may be the longest continuous measurement of plant water potential [@Breshears2009; @McDowell2016].  SUMO was a multi-year field experiment (2012 - 2016) designed to manipulate temperature (+4.8$^\circ$C) and precipitation (-45%) consistent with climate change predictions. This integration of a long-term dataset with a neighboring manipulative study is ideal for evaluating the effects of water limitation on plants in the field.  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  Here we ask two questions concerning plant carbon dynamics during drought: 1) Does growth stop before photosynthesis in response to declining $\psi_{pd}$? and 2) Does carbon storage increase as growth declines with more negative $\psi_{pd}$? Monthly measurements of $\psi_{pd}$, photosynthesis, and stem radial growth from the SUMO experiment were used to identify thresholds at which growth and photosynthesis reached zero (sink and source limitation, respectively), in two tree species that differ in tolerance to drought, _Juniperus monosperma_ and _Pinus edulis_ (Fig. 1). Thresholds for the cessation of growth and photosynthesis were defined as the x-intercepts of the species-level regressions of percent of maximum growth or photosynthesis against $\psi_{pd}$ (Fig. 1). We used these thresholds for the SUMO trees to evaluate the hypotheses that growth would stop before photosynthesis, driving an increase of starch in these trees. Following these hypotheses, we leveraged the 25-year dataset of $\psi_{pd}$ on the same species from MDB, to further test the corollary that growth would be limited more frequently than photosynthesis.  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  Counter to our expectation, growth did not stop before photosynthesis (Fig. 1). Photosynthesis initially declined significantly faster (slope = -0.33, p < 0.05) than growth (slope = -26.8) for _J. monosperma_ (Fig. 1B). Near a $\psi_{pd}$ of -3.5 MPa, both variables converged until crossing the x-axis at -6.86 MPa and -6.75 MPa for growth and photosynthesis, respectively (Fig. 1A, not significant). In contrast, _P. edulis_ displayed strong patterns of co-limitation of growth and photosynthesis across the entire range of observed $\psi_{pd}$ (Fig. 1B; p = 0.064). The distinct co-limitation patterns of each species reflects their alternative tolerances to drought stress[@Mcdowell2019] (Fig. 1).  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  Can the co-limitation of growth and photosynthesis under progressively lower $\psi_{pd}$ be explained as the control of growth by photosynthesis (or vice versa)? Prior work [@STITT1993] has shown molecular evidence of coordinated growth and photosynthesis under low resource availability however, during drought, water availability is the primary factor limiting growth and photosynthesis. The co-limitation of growth and photosynthesis may be the result of a coordinated yet independent response to drought (Fig. 1B and 1C). In support of this view, we provide several lines of evidence. First, growth and photosynthesis showed no correlation (Fig. 2A) and trees of both species could maintain relatively high growth rates under low photosynthesis (and vice versa). Second, growth and photosynthesis were coordinated only when water availability was low during the summer drought and followed separate trajectories after drought was relieved (Fig. 2B).  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  Growth and photosynthesis were qualitatively similar in both species during the 2013 and 2014 growing seasons (Fig. 2B). Both species experienced their lowest levels of growth and photosynthesis during the earliest parts of the growing season, consistent with low soil water availability. Following the late summer monsoon (July / August), photosynthesis exceeded growth in both species (~50% difference in both species; Fig. 2B). The absence of a proportional increase in growth rate with increasing photosynthetic rate implies growth was not limited by carbon availability.  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  In 2013, $\psi_{pd}$ averaged -2.91 MPa and -1.99 MPa for _J. monosperma_ and _P. edulis_, respectively. In contrast, $\psi_{pd}$ averaged -1.74 MPa for _J. monosperma_ and -1.53 MPa for _P edulis_ in 2014 (Fig 2C). 2013 was the only year that _J. monosperma_ ever experienced $\psi_{pd}$ low enough for growth and photosynthesis to cease. Although _P. edulis_ fell below this threshold several times throughout the study, a majority of those observations were during the 2013 growing season (Fig. 2C). This difference in $\psi_{pd}$ may explain the extremely low values of growth and photosynthesis in 2013, relative to 2014 (Fig 2B). The growth of _J. monosperma_ tended to track photosynthesis in 2014, similar to the patterns observed in 2013 though average rates were much higher in the early season of 2014. The growth rate of _P. edulis_ also qualitatively tracked photosynthesis in 2014, but was sustained at a rate roughly 10% greater than the rate of photosynthesis. This suggests that even when photosynthesis is lower than growth, the pool of available carbohydrates within a tree, both stored and incoming from photosynthesis, is sufficient to supply growth.  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  Sugar concentrations in both species were unaffected as growth declined in response to low $\psi_{pd}$ (Figs. 3C, 3D). Starch concentrations significantly declined as growth became limited in _P. edulis_, a symptom of the rapid co-limitation of growth and photosynthesis in this species (Figs. 3D, 1C). As a function of $\psi_{pd}$, starch significantly declined in both species (Fig. 3A, 3B, S3). _J. monosperma_ delayed starch depletion as $\psi_{pd}$ became more negative (slope = -10.04), consistent with this species' tendency to delay stomatal closure during drought (Fig. 1B). Ultimately, we observed a significant increase in the sugar concentrations of _J. monosperma_, which suggests osmotic adjustment with increasing water stress (Fig. 3A). In contrast, _P. edulis_ rapidly hydrolized starch (slope = -14.91) in response to declining $\psi_{pd}$ while keeping sugar concentrations relatively unchanged. This finding is consistent with previous work showing a lack of osmotic adjustment in this species [@Meinzer2014]. Instead, the early onset of source limitation in _P. edulis_ likely forced this species to convert starch into sugar which was quickly consumed by other metabolic processes like respiration (Fig. 3B).  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  During this study, both species displayed a clear coordination of growth, photosynthesis, and carbon storage in response to drought (Figs. 1 - 3). Often, the results contrasted (Figs. 3A, 3BB) or were unexpected (Fig. 1). To explore how these traits interact simultaneously, we used a principal components analysis (PCA) to project our variables ($\psi_{pd}$, canopy starch, canopy sugar, growth, and photosynthesis) into a 2-dimensional subspace. More than 70% of the variance in the data spanning the entire growing season could be explained using just two principal components (PC1 = 47.15%, PC2 = 27.58%; Fig. 4; Table S4). PC1 reflects the antagonistic effect of $\psi_{pd}$ on growth and photosynthesis (Fig. 4), and the increase in tree sugar concentrations observed in Figure 3. Along PC1, co-limitation of growth and photosynthesis was observed. PC2 however, illustrates the independence of growth and photosynthesis with both variables moving in opposite directions. While most of the variance in the data was explained by just two principal components (74.73%; Fig. 4A), this contrast between growth and photosynthesis was persistent throughout PC2 - PC4 (> 90%; Fig. 4A). Remarkably similar patterns were observed when June data was analyzed on its own, to include NSC components from the bole, roots, and the canopy (Fig. S4).  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  To further quantify the relationship between growth and photosynthesis, we calculated the inner product of the variable vectors in our data, determined as: $Growth\cdot Photosynthesis = |Growth|\times |Photosynthesis|\times cos(\theta)$ and solved for $\theta$. Here, $\theta$ represents the angle between two vectors, where a value approaching 90° indicates two vectors are orthogonal. The angle between growth and photosynthesis was 89°, confirming the independent yet coordinated response of each variable to declining $\psi_{pd}$. Starch fell within the angle between growth and photosynthesis, suggesting carbon storage increases when conditions are favorable to support high levels of growth and photosynthesis (Fig. 4). This is consistent with the strong seasonal patterns we observed in NSC, which reflect phenological patterns of carbon supply and demand [Fig 2B; Fig. S2, @MartinezVilalta2016; @Peltier2020]. Although this may provide some evidence against the view of competing sinks and allocation hierarchies in favor of a more integrated view of plant carbon allocation, we are careful in our interpretation given the absence of molecular data [@STITT1993].  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  Central to our understanding of plant carbon allocation is the view that starch accumulates during periods of reduced growth [@Chapin1990; @Korner2003; @Wiley2012a; @Monson2021]. In this study however, we show that growth and photosynthesis decline concomitantly in response to drought. Drought conditions severe enough to drive this sink-source co-limitation were rare in both our observational and experimental data (Fig. 2). This suggests that carbon storage may have actually increased more often than it decreased. Moreover, this study only evaluated radial growth changes. While we recognize that elsewhere on these trees growth may have persisted, radial growth is often the first to stop in response to drought. Even if growth had continued elsewhere on the plant, the rapid decline in photosynthesis still prevented carbon storage.  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  Large-scale field experiments and long-term observational datasets such as these are often used to parameterize models that predict ecosystem responses to climate change [@DeKauwe2014; @Trugman2019; @Mackay2019; @Franklin2020]. It is these rare but extreme events that often matter most in determining whether plants live or die [@McDowell2022], and are thus often the subject of such models. Many models [@Franklin2020] reflect the theory that growth stops before photosynthesis [@Korner2003; @Muller2011], that carbon storage increases following cessation of growth [@Chapin1990; @Korner2003], and that photosynthesis drives growth [@Korner2015]. Such views are clearly contradicted by our results. Instead, we offer an alternative perspective on how plants use carbon (at least in terms of growth, photosynthesis, and carbon storage) that views growth and photosynthesis as largely independent processes influenced by complexes of molecular, biophysical, and chemical regulators. Beyond growth and storage, other sinks such as defense and respiration play significant roles in plant carbon balance and have implications for their sensitivity to biotic and abiotic stress [@Trowbridge2021; @Monson2021; @McDowell2022]. It is critical that future research move beyond measurements of growth and NSC as simple proxies for plant carbon balance during drought. Until vegetation models account for the complexities of plant carbon dynamics, sink-source co-limitation, and sink multiplicity, we will remain challenged in predicting the response of earth's largest terrestrial carbon sink to climate change[@Cabon2022].   
  
  
__Methods__  
  
_Site Description and Experimental Design_   
  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  The Los Alamos Survival/Mortality (SUMO) experiment [@Adams2015; @Grossiord2017; @Manrique-Alba2018; @Mcdowell2019] and MDB site [@Breshears2005; @Breshears2009] have been described in detail previously by others. Briefly, the SUMO and MDB sites are located  near Los Alamos, New Mexico USA, at elevations of 2150m and 2140m, respecively in piñon-juniper woodland just below the *Pinus ponderosa* forest ecotone. *Pinus edulis* and *Juniperus monosperma* dominate both sites, although scattered individuals of *Quercus gambelli*, *P. ponderosa*, *J. deppeana* and *J. scopulorum* can also be found at the SUMO site. A volcanic tuff parent material sits below the Hackroy clay loam soils that are found at both sites and can be found at depths ranging from 40-80 cm. The growing season occurs between April and October. Average 30-year temperature and precipitation were 10.1 C and 360mm, respectively. At the MDB site, five trees each of *P. edulis* and *J. monosperma* were selected for long term monitoring in March 1992, and two additional _P. edulis_ trees were added in 1994. In 2003, all seven measured *P. edulis* trees died from drought and bark beetle attack, and five surviving replacements were selected in 2004.  Measurements from one tree were switched to another in 2008. Several *J. monosperma* were added to measurements in subsequent years: five in 2007, and three in 2015. At SUMO , below-canopy precipitation removal structures and open-top heating chambers were installed during June 2012. A total of 64 individuals of *P. edulis* and *J. monosperma* (32 trees per species) were selected and placed into one of five treatments (5-7 trees per species in each), however due to a lack of growth data, only four treatments are considered in this paper. The ambient treatment consisted of trees exposed to ambient temperature and precipitation. The heat treatment was implemented by placing open top chambers around selected trees to create an average increase of 4.8°C above ambient temperatures. Drought trees were exposed to ambient temperatures within a precipitation removal structure that diverted ~45% of precipitation away from these trees. Heat + Drought trees were exposed to both the 4.8°C temperature increase and the precipitation removal. Continuous measurement of site climatic conditions using two weather stations, in addition to within-chamber measurements, allowed control of chamber conditions using heating and air-conditioning units.  
  
_Radial Growth Measurements and Calculations_  
  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  Tree radial growth was measured as outlined by Manrique-Alba et al. [@Manrique-Alba2018]. Briefly, from May through September in 2013 and 2014, a linear variable displacement transducer (LVDT) was attached to the upper bole of 11 individuals of _J. monosperma_ and 12 individuals of _P. edulis_ using a rectangular frame that was attached directly to the tree using screws. Trees were selected from Heat, Heat + Drought, Drought, and Ambient treatments. Dead bark was gently removed from the site where the sensor contacted the tree, though a thin layer was left as to protect the phloem and prevent water loss.  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  Data from the LVDT is a relative metric of change in diameter over time. Upon installation, each LVDT was set to “zero” the night of the first day of the measurement period before any growth occurred. This established the reference point from which measured growth would deviate. Because diurnal fluxes of stem diameter make calculating growth difficult, we considered growth initiation to have occurred when the maximum stem diameter exceeded that of the previous day’s maximum, for each tree. When maximum stem diameter did not exceed the previous day’s maximum, we considered growth to have stopped.   
  
_Water potential and Photosynthesis_   
  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  Xylem water potential and foliar gas exchange were determined for 11 individuals of _J. monosperma_ and 12 individuals of _P. edulis_ at SUMO (2011 - 2017). Xylem water potential only was measured monthly on 14 _J. monosperma_ and 13 _P. edulis_ at MDB (1992 - 2016). Two twig samples were collected every three months from each tree before sunrise and the xylem water tension was measured using a Scholander pressure chamber (PMS Instruments, Albany, OR, USA). The level of water stress for each tree was quantified as the average predawn water potential ($\psi_{pd}$) of both stems.  
 Net photosynthesis and gas exchange were measured on the south-facing, sun-exposed side of each tree using a Li-Cor LI-6400 (Lincoln, NE, USA). Needles from each tree were measured under chamber conditions set of 380ppm CO2, 1500 mol $m^{−2} s^{−1}$ light-saturating photosynthetic photon flux density (PPFD), temperatures between 20-25°C, and 0% relative humidity. These conditions closely matched those of the outside environment, where temperatures ranged from 13 – 30°C and 750 – 1800 mmol $m^{−2} s^{−1}$ PPFD. After two minutes of steady-state gas exchange, measurements were recorded, and needle samples were collected to determine leaf area. Gas exchange data was corrected using leaf area measurements made on a Li-Cor LI3100C area meter.  
	 
_Non-Structural Carbohydrates_   
  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Beginning on March 14th, 2012 at SUMO, leaf and stem tissue samples were collected for each tree four times each year to capture seasonal changes associated with spring dormancy break, mid-summer drought, monsoon wet-season, and post-monsoon dry-down. Bole and root samples were collected using an increment borer once per year during the dry season, in June. Upon collection, samples were placed into liquid nitrogen and transported to the lab in dry ice. Samples were kept stored at -70°C until analysis, when they were microwaved for 5 min at 800W and placed in a drying oven for 48h at 65°C. All samples were ground using a ball mill and woody tissues were preground using a Wiley Mini-Mill. To assay NSC, we used the protocol outlined by Dickman et al. [@Dickman2015], as developed from the methods of Hoch et al. [@Hoch2003]. This method has been verified to produce reasonably accurate and precise measurements of NSC, defined as glucose, fructose, sucrose, and starch [@Landhausser2018]. ~12mg of finely ground sample was placed into a deep-well plate with 1.6 mL deionized water and placed into a 100C water bath for 1h. A NAD-linked enzymatic assay was used in combination with spectral assessment at 340 nm for NSC quantification.  
    
	 
_Data Analysis_  
  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Prior to data analysis, outliers in the growth and photosynthesis data that exceeded 3x the mean cook's distance were removed [@Kim]. To begin our analysis, we evaluated the response of growth and $A_{net}$ to declining $\psi_{pd}$. Because of the disjointed sampling frequency of $\psi_{pd}$ and stem radial growth, we normalized the $\psi_{pd}$ at which growth and $A_{net}$ stopped for each tree. We first took the sum of all daily growth between $\psi_{pd}$ measurement intervals as the total monthly growth for each tree. To account for tree-specific variation in growth rates, maximum growth was first determined at the tree level and all growth measurements were expressed as a percentage of that maximum. A pooled linear-log regression was then run at the species level (due to low sample size at the individual level), identifying the response of growth to declining $\psi_{pd}$ (Fig. S1A, S1C). Limitation to photosynthesis was determined similarly, first with percent of maximum photosynthetic rates established at the tree-level and a linear-log regression to evaluate species-level response to drought (Figs. S1B, S1D). The regression model used to describe the relationship between $\psi_{pd}$ and growth or photosynthesis, respectively was determined using AIC. The best performing growth model was a linear log model, while photosynthesis performed best when using a polynomial model (see Tables S8 and S9). This was true for both species. Since our aim was to evaluate carbohydrate dynamics following complete cessation of growth and photosynthesis, as well as along the trajectory to complete cessation, the polynomial model was rejected in favor of the second best fitting model, the linear-log model ($\Delta AIC <7$). Although trees were placed into different treatments for the duration of the SUMO study, we used cross-treatment fits to expand the observed range of $\psi_{pd}$, making our analysis more robust. Thus, we chose to evaluate differences in thresholds and NSC dynamics on a species-level basis, pooling data among SUMO treatments, increasing our sample size from ~3 trees per species per treatment to 11 individuals of _P. edulis_ and 12 individuals of _J. monosperma_.  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  Statistical analyses were conducted using base R [@R]. We began by evaluating the goodness-of-fit of several linear and non-linear regression models on the relationship between growth and photosynthesis with $\psi_{pd}$ (Tables S8 & S9). After fitting several models to the data, goodness-of-fit was determined using Akaike's Information Criterion and the model with the lowest dAIC was selected. Because we were interested in models where the regression line crossed the x-axis (a necessary condition for finding points of cessation), model selection was further filtered as the model with the smallest dAIC < 7 [@Akaike]. The result was that polynomial fits were ultimately excluded even if they fit the data best.  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  To test for differences in the points of cessation and slopes of growth and photosynthesis with $\psi_{pd}$, we used an analysis of variance on the interaction of each variable (Table S2) in the aforementioned model and analysis of variance with growth and photosynthesis as response variables. Although growth and photosynthesis vary continuously with $\psi_{pd}$, this approach allowed us to identify a threshold beyond which plant carbon dynamics could be evaluated. To test the hypothesis that growth limitation induces an increase in starch, we evaluated a set of candidate models with sugar and starch as a response variable, and either % of maximum growth or $\psi_{pd}$ as a predictor variable. The candidate models we tested were polynomial, negative exponential, linear, and linear-log. We evaluated the best-fitting model for each species, component, and predictor variable separately (see Tables S6 & S7 for AIC results; Fig 3 shows best fitting models and their mathematical form).  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  The amount of time that trees spent at different rates of growth and photosynthesis relative to their maximums was of particular interest, with respect to generalizing the effects observed here to how trees might respond under future warming. For each species, at each site, we calculated the average frequency (expressed as a % of the study length at MDB and SUMO) of growth and photosynthesis limitation. Based on the linear-log models fit to the $\psi_{pd}$ versus growth and photosynthesis data, we used an inverse-predict algorithm to estimate the % of maximum growth and photosynthesis at a given $psi_{pd}$, in 10% intervals (Figure S7). We calculated how often each species spent at each interval, and used a Kolmolgorov-Smirnov test to evaluate differences in the distribution. If the trajectory toward cessation differed between growth and photosynthesis, we would expect the distributions to be significantly different. Finally, to better understand the interdependence of growth, photosynthesis, sugar, and starch to drought, we used a principal components analysis. The apparent coupling of growth and photosynthesis to declining $\psi_{pd}$ (Fig. 1) was of particular interest given the widely cited conjecture that photosynthesis drives growth [@Korner2013; @Korner2015]. This analysis leveraged photosynthesis, growth, NSC, and $\psi_{pd}$ data, yet was limited by the infrequency of the growth measurements. Still, the dimensionality of the dataset was not outweighed by the limitations of the sample size, and we were able to run a scaled analysis using a correlation matrix of the data (see Tables S4 and S5 for PCA results). Orthogonality between variables was measured using the dot-product of each vector, expressed as $\theta$, effectively measuring the independence between two vectors [@Johnson2007].  
  
  
  
  
__Figures__  
  
```{r echo=FALSE, results='asis', error=FALSE, warning=FALSE, message=FALSE,out.width="100%", fig.align='center',fig.height=10}
agplot
ggsave("fig1.png",plot=agplot,height=130,width=88,units="mm",scale=2,bg="white")
getwd()
```  
  
Figure 1. __No carbon storage for growth-limited trees.__ Growth and photosynthesis are co-limited as $\psi_{pd}$ declines (B and C). The expected increase in starch accumulation as growth becomes constrained by drought is subverted given the rapid decline in photosynthesis. In A, the theoretical response of growth, photosynthesis, and starch is shown based on predictions from theory [@Korner2003]. In B and C, the observed response of growth, photosynthesis, and canopy starch to drought suggests this theory may not apply to mature trees living in semi-arid environments. Lines in A reflect a loess smooth function. In B and C, lines reflect a linear-log model fit at the species-level while limitation thresholds reflect the x-intercept of each regression line. Significance between the slope and intercept of each line was evaluated using an analysis of variance (Table S2). Grey areas around lines indicate 95% confidence intervals. A separate analysis of needle, twig, bole, and root NSC for June only can be viewed in Figs. S1 & S2.   
   
```{r echo=FALSE, results='asis', error=FALSE, warning=FALSE, message=FALSE, fig.align='center',fig.height=10}
#longterm_Ypd
# pg_lin<-pg_lin + theme(legend.position=c(.4,.75)) +  theme(text = element_text(
#         size = 10, face = "italic"),
#         panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
# panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
#    strip.background = element_rect(
#      color="white", fill="white", size=1.5, linetype="solid"
#      )
#    ) 
lypdSUMO<-longterm_Ypd_SUMO +  theme(text = element_text(
        size = 15, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + ylim(-10,100)


ag_figs<-ggarrange(a_g,ag_time,nrow=1,labels=c("A","B"),widths=c(0.6,1))

fig2<-ggarrange(ag_figs,lypdSUMO,nrow=2,heights = c(1.5,2), labels = c("","C"))
ggsave("fig2.png",fig2,height=130,width=88,units="mm",scale=2.8,bg="white")

S11<-longterm_Ypd_MDB +  theme(text = element_text(
        size = 15, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) 
ggsave("S11.png",S11,width=8,height=8)

```
  
Figure 2.  __Growth and photosynthesis are not correlated (A), but respond together to the environment (B, C).__ In A, growth and photosynthesis are plotted against each other, showing a lack of relationship between the two variables. In B, seasonal variation in growth and photosynthesis suggest the two variables respond in tandem to seasonal variation but diverge toward the end of the growing season. In early fall, photosynthesis remains high, while growth converges to zero consistent with phenological patterns. In C, a time-series of % of maximum growth (red) and photosynthesis (blue) at MDB (25 years) and SUMO (6 years) show that complete cessation of growth and photosynthesis is rare. The dramatic crash in growth and photosynthesis for _P. edulis_ at MDB in 2003 indicates a drought-induced mortality event, after which new trees were selected. Although very low $\psi_{pd}$ sufficient to close stomata and stop growth are relatively rare, the 2003 mortality event highlights the importance of rare and extreme events as a driver of tree mortality.  In A, points represent tree-level observations of growth and photosynthesis. In B, points represent species-level average growth and photosynthesis for the month while error bars represent standard error. In C, lines represent individual trees measured monthly through time. % of maximum growth and photosynthesis was determined using the linear-log model from Figure 1.   
  
```{r echo=FALSE, results='asis', error=FALSE, warning=FALSE, message=FALSE,out.width="100%", fig.align='center',fig.height=10}
nscypd<-ggarrange(jumo_nsccanopy,pied_nsccanopy,ncol=1,labels=c("A","B"),common.legend=TRUE,widths=0.2


#nsc_all<-ggarrange(nscg,nscypd,nrow=2,common.legend=TRUE,widths=0.2)
plus_tissue<-ggarrange(nscypd,slope_plot,ncol=2,common.legend=FALSE,labels=c("","C"))
#library(ragg)
#ragg::agg_png("fig3.png", width = 5, height = 5, units = "in", res = 300, scaling = 1)
#plus_tissue
ggsave("fig3.png",plus_tissue,height=130,width=88,units="mm",scale=3,bg="white")

#nscplot<-ggarrange(nscypd,nsc_predicted,nrow=1,ncol=2,common.legend=TRUE)

nscg<-ggarrange(jgn_plotcanopy,pgn_plotcanopy,ncol=1,labels=c("A","B"),legend="none",widths=0.2)
plus_tissue2<-ggarrange(nscg,slope_plot2,ncol=2,common.legend=FALSE,labels=c("","C"))
ggsave("fig4.png",plus_tissue2,height=130,width=88,units="mm",scale=3.5,bg="white")
```
   
Figure 3. **_J. monosperma_ and _P. edulis_ hydrolyze starch to increase or maintain sugar concentrations, respectively.** As $\psi_{pd}$ becomes more negative, _P. edulis_ maintains cell osmotic potential by converting starch into sugar. _J. monosperma_ may in turn increase cell osmotic potential as a result of keeping stomata open, increasing sugar concentrations, and losing more water. Because photosynthesis declines with growth (see Fig. 1), starch concentrations continue to decline in both species as $\psi_{pd}$ becomes increasingly negative and growth approaches cessation. Points are observations of canopy sugar (blue points and line) and starch (yellow points and line). Lines represent the line of best fit, determined using the Akaike Information Criterion (Table S8). Grey areas around lines indicate 95% confidence intervals. A separate analysis of needle, twig, bole, and root NSC for June only can be viewed in Fig. S3.  

``` {r PCA, echo=FALSE, results='asis', error=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=10,fig.height=5}

pcaplot<-pca12_plot+  theme(text = element_text(
        size = 15, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) + 
  geom_segment(aes(x=-0.15,xend=-0.24,y=0.067,yend=-0.09),size=0.1)+
  geom_segment(aes(x=-0.08,xend=-0.235,y=-0.17,yend=-0.09),size=0.1) +
  geom_text(aes(x=-0.4,y=-0.18),label="89°") 



scree2<-ggarrange(NULL,scree,NULL,ncol=3,widths = c(0.15,1.5,0.35))

pca_heat_scree<-ggarrange(scree2,pca_heat,nrow=2,heights=c(0.2,0.5))
phs<-ggarrange(pca_heat_scree,heights=0.2)

ggarrange(phs,pcaplot,nrow=1,labels=c("A","B"))
  
  
 
```
  
Figure 4. **$\psi_{pd}$ couples photosynthesis to growth.** During drought, carbon availability is not the limiting process influencing growth rate. Drought-induced reductions in cell turgor independently limits growth and photosynthesis, explaining both sink-source co-limitation and the lack of correlation between growth and photosynthetic rates. Results of the principal components analysis on carbon supply and demand variables reveals that water availability ($\psi_{pd}$) limits growth and photosynthesis and not carbon availability. PC1 explained 47.15% of the total variance in the data, and together PC1 and PC2 explain 74.73% of the total variance in the data. Along PC1, $\psi_{pd}$ becomes more negative, drive sink-source co-limitation. Sugar concentrations increase as starch is depleted to support the metabolic and osmotic needs of both species. Growth and starch concentrations vary the most along PC2, reflecting the temporal patterns of plant phenology and starch accumulation (Figure S6). In A, a scree plot showing the amount of variance each principal component accounts for, and the eigenvectors associated with each principal component are shown. Photosynthesis and growth contrast along all principal components except PC1 (water stress axis) and PC5 (which explained <10% of the total variance). This result stands in contrast to what theory and models would predict [@Chapin1990; @Korner2003; @Wiley2012a; @Franklin2020]. Based on theory, carbon demand drives carbon supply [@Korner2015] and starch accumulates inversely to growth [@Chapin1990; @Korner2003; @Wiley2012a]. Comparison between the inner product of $\vec{Photosynthesis}$ and $\vec{Growth}$ is indicated by $\theta$ = 89°; suggesting the two variables are orthogonal to each other. All variables (expect water potential, which is shown in absolute terms) are calculated as a percentage of the maximum observed for each tree. Each point indicates a specific observation where all variables overlapped (i.e. were observed for the same sampling month). Starch and sugar shown here are canopy averages only, due to the low sampling frequency of bole and root NSC measurements. A separate analysis across the entire growing season (NSC includes only needle and twig) can be viewed in Fig. 4.   
  
  
__Data Availability__  
SUMO data available here https://data.ess-dive.lbl.gov/data   
  
__Code Availability__  
All R code will be made publicly available at https://github.com/r-alex-thompson/SUMO.git following acceptance of this manuscript.  
  
__Acknowledgements__  
  The Los Alamos Survival–Mortality Experiment (SUMO) was funded by the US Department of Energy, Office of Science, Biological and Environmental Research.  RAT, AMT, and HDA were supported by the NSF Division of Integrative Organismal Systems, Integrative Ecological Physiology Program (IOS-1755345, IOS-1755346). RAT was also supported by the NSF Graduate Research Fellowship Program. HDA was also supported by the USDA National Institute of Food and Agriculture (NIFA), McIntire Stennis Project WNP00009 and Agriculture and Food Research Initiative award 2021-67013-33716.  
  
    
__Author Contributions__  
All authors contributed to interpreting the analyses and editing the paper. RAT wrote the manuscript, analyzed the data, and designed the figures. HDA and RAT developed the hypotheses. HDA, DDB, ADC, LTD, CG, AMA, AMT, and NGM collected the data. NGM designed and led the SUMO project. DDB designed and led the long-term MDB observations.  
  
__Competing Interests__  
  
__Additional Information__  
  
__Supplementary Figures__  
  
  
```{r echo=FALSE,results='asis',eval=TRUE,message=FALSE,warning=FALSE,error=FALSE,out.width="100%",include=TRUE,fig.align='center'}
j_agjune
```
Figure S1. Regression of growth, photosynthesis, and June starch concentrations for the needle, twig, bole, and root, against $\psi_{pd}$ for _J. monosperma_. Grey areas around lines indicate 95% confidence intervals. A separate analysis of NSC for needle and twig only across the entire growing season can be viewed in Fig. 1B.   
  
```{r echo=FALSE,results='asis',eval=TRUE,message=FALSE,warning=FALSE,error=FALSE,out.width="100%",include=TRUE,fig.align='center'}
p_agjune
```
Figure S2. Regression of growth, photosynthesis, and June starch concentrations for the needle, twig, bole, and root, against $\psi_{pd}$ for _P. edulis_. Grey areas around lines indicate 95% confidence intervals. A separate analysis of NSC for needle and twig only across the entire growing season can be viewed in Fig. 1C.   
  
```{r echo=FALSE, results='asis', error=FALSE, warning=FALSE, message=FALSE,out.width="100%", fig.align='center',fig.height=10}
nscypd<-ggarrange(jumo_nsc,pied_nsc,nrow=1,labels=c("A","B"),common.legend=TRUE,widths=0.2)
nscg<-ggarrange(jgn_plot,pgn_plot,nrow=1,labels=c("C","D"),legend="none",widths=0.2)
nsc_all<-ggarrange(nscypd,nscg,nrow=2,common.legend=TRUE,widths=0.2)
nsc_all
#nscplot<-ggarrange(nscypd,nsc_predicted,nrow=1,ncol=2,common.legend=TRUE)
```
Figure S3. Results of the regression of whole-tree average (needle, branch, bole, and root) sugar and starch (June only) against $\psi_{pd}$ and % of maximum growth. Grey areas around lines indicate 95% confidence intervals. A separate analysis of NSC for needle and twig only across the entire growing season can be viewed in Fig. 3.   
  
``` {r PCA june, echo=FALSE, results='asis', error=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.width=10,fig.height=5}

pcaplot_june<-pca12_plotjune+  theme(text = element_text(
        size = 15, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) 



scree2june<-ggarrange(NULL,scree_june,NULL,ncol=3,widths = c(0.15,1.5,0.35))

pca_heat_screejune<-ggarrange(scree2june,pca_heatjune,nrow=2,heights=c(0.2,0.5))
phsjune<-ggarrange(pca_heat_screejune,heights=0.2)

ggarrange(phsjune,pcaplot_june,nrow=1,labels=c("A","B"))
  
  
 
```
Figure S4. Results of the principal components analysis on carbon supply and demand variables including bole, root, twig, and needle NSC for June only. PC1 explained 59.9% of the total variance in the data, and together PC1 and PC2 explain 85% of the total variance in the data. As in Figure 4, growth and photosynthesis respond negatively to declining $\psi_{pd}$ along PC1. The orthogonal relationship between growth and photosynthesis observed in Figure 4 vanishes. We conclude this is likely due to the fact that all observation in this analysis are for a single month only, when growth and photosynthesis are highly correlated (see Figure 2B). A separate analysis across the entire growing season (NSC includes only needle and twig) can be viewed in Fig. 4.  
  
```{r echo=FALSE,results='asis',eval=TRUE,message=FALSE,warning=FALSE,error=FALSE,out.width="100%",include=TRUE,fig.align='center'}
ind_arr+  theme(text = element_text(
        size = 15, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) 
```
Figure S5. Results of the linear regression of % of maximum growth and photosynthesis against $\psi_{pd}$. For each individual tree, the maximum rate of growth and photosynthesis were identified and all subsequent measurements were expressed relative to that maximum. Points represent individual tree observations for each variable, while linear models (lines) were performed at the species level. Grey areas around lines indicate 95% confidence intervals.   
  
```{r echo=FALSE,results='asis',eval=TRUE,message=FALSE,warning=FALSE,error=FALSE,out.width="100%",include=TRUE,fig.align='center'}
nsc_time+  theme(text = element_text(
        size = 15, face = "italic"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
panel.background = element_blank(), axis.line = element_line(colour = "black")) + theme(
   strip.background = element_rect(
     color="white", fill="white", size=1.5, linetype="solid"
     )
   ) 
```
Figure S6. Average non-structural carbohydrate concentrations as a function of time. NSC, Sugar, and Starch concentrations were taken as the average species-level value for a given month, among all years and individuals.  
  
```{r echo=FALSE,results='asis',eval=TRUE,message=FALSE,warning=FALSE,error=FALSE,out.width="100%",include=TRUE,fig.align='center'}
pg_lin
```
Figure S7. When growth was limited, photosynthesis was also limited in both species at SUMO and MDB, though complete cessation was rare. Histograms showing the average % of time at different intervals of growth and photosynthesis (1992 - 2016 at MDB; 2011 - 2017 at SUMO) are shown. Points represent the average frequency of sink (circles) and source (triangles) limitation across all trees within each species, at each site. The % of maximum for both parameters was estimated using interpolations from the linear-log model fit to the original % of maximum data. We used a Kolmogorov-Smirnov test to evaluate the distribution of each parameter for each species and test for significant differences, which were not found (Table S3).  
  
<span style='font-size: 0.8em'>
```{r echo=FALSE,  eval=TRUE, message=FALSE,warning=FALSE,error=FALSE,out.width="100%", include=TRUE,fig.align='center'}
ag_var<-theme_vanilla(ag_var)
autofit(ag_var)
```
<span>
Table S1. Results of the linear-log model, comparing the response of % maximum growth and photosynthesis to changes in $\psi_{pd}$.  
  
<span style='font-size: 0.8em'>  
```{r echo=FALSE,  eval=TRUE, message=FALSE,warning=FALSE,error=FALSE,out.width="100%", include=TRUE,fig.align='center'}
ag_comparison<-theme_vanilla(ag_comparison)
autofit(ag_comparison)
```
<span>  
Table S2. Results of the ANOVA comparing the linear-log regression of growth and photosynthesis within and between species. Results indicate no significant difference between variables, within species, but within variable comparisons between species were significantly different.  
  
<span style='font-size: 0.8em'>
```{r echo=FALSE,  eval=TRUE, message=FALSE,warning=FALSE,error=FALSE, include=TRUE,fig.align='center',fig.width=2}
all_ks<- theme_vanilla(ks)
autofit(all_ks)
```
<span>  
Table S3. Results of the Kolmogorov-Smirnov test evaluating the distribution of growth and photosynthesis within species and sites. Here, the null hypothesis is that the distribution of the variables (growth and photosynthesis) is equivalent. A p-value less than $\alpha$ = 0.05 indicates the distribution is not equal. We show that in all cases, photosynthesis and growth occurred at a given % of maximum with equal frequency. Theory would suggest that if growth were more sensitive than photosynthesis to water limitation, these distributions would not be equal.  
  
<span style='font-size: 0.8em'>
```{r echo=FALSE,  eval=TRUE, message=FALSE,warning=FALSE,error=FALSE, include=TRUE,fig.align='center'}
pca_imp<-theme_vanilla(pca_imp)
autofit(pca_imp)
```  
<span>  
Table S4. Proportion of the variance and cumulative proportion of the variance explained by each principal component.  
  
<span style='font-size: 0.8em'>
```{r echo=FALSE,  eval=TRUE, message=FALSE,warning=FALSE,error=FALSE, include=TRUE,fig.align='center'}
pca_impjune<-theme_vanilla(pca_impjune)
autofit(pca_impjune)
```  
<span>  
Table S5. Proportion of the variance and cumulative proportion of the variance explained by each principal component for June data only.  
  
<span style='font-size: 0.8em'>  
```{r echo=FALSE,  eval=TRUE, message=FALSE,warning=FALSE,error=FALSE, include=TRUE,fig.align='center'}
ngcanopy_kab<-theme_vanilla(ngcanopy_kab)
autofit(ngcanopy_kab)
```  
<span>  
Table S6. Results of the regression between % of maximum growth against annual canopy (twig and needle) sugar and starch, respectively.  
  
<span style='font-size: 0.8em'>  
```{r echo=FALSE,  eval=TRUE, message=FALSE,warning=FALSE,error=FALSE, include=TRUE,fig.align='center'}
ng_kabjune<-theme_vanilla(ng_kabjune)
autofit(ng_kabjune)
```  
<span>  
Table S7. Results of the regression between % of maximum growth against June whole-tree sugar and starch, respectively.  
  
<span style='font-size: 0.8em'>
```{r echo=FALSE,  eval=TRUE, message=FALSE,warning=FALSE,error=FALSE, include=TRUE,fig.align='center'}
aiccanopy_polys<-theme_vanilla(aiccanopy_polys)
autofit(aiccanopy_polys)
```  
<span>  
Table S8. Results of the AIC test to find the best-fitting model when regressing annual canopy NSC and it's components against predawn water potential. Models with the lowest dAIC within each species and variable were used in the analysis.  
  
<span style='font-size: 0.8em'>
```{r echo=FALSE,  eval=TRUE, message=FALSE,warning=FALSE,error=FALSE, include=TRUE,fig.align='center'}
aicjune_polys<-theme_vanilla(aicjune_polys)
autofit(aicjune_polys)
```  
<span>
Table S9. Results of the AIC test to find the best-fitting model when regressing June whole-tree NSC and it's components against predawn water potential. Models with the lowest dAIC within each species and variable were used in the analysis.  
  
<span style='font-size: 0.8em'>  
```{r echo=FALSE,  eval=TRUE, message=FALSE,warning=FALSE,error=FALSE, include=TRUE,fig.align='center'}
canopy_aic<-theme_vanilla(canopy_aic)
autofit(canopy_aic)
```  
<span>  
Table S10. Results of the AIC test to find the best-fitting model when regressing annual canopy NSC and it's components against predawn water potential. Models with the lowest dAIC within each species and variable were used in the analysis.  
  
<span style='font-size: 0.8em'>
```{r echo=FALSE,  eval=TRUE, message=FALSE,warning=FALSE,error=FALSE, include=TRUE,fig.align='center'}
june_aic<-theme_vanilla(june_aic)
autofit(june_aic)
```  
<span>  
Table S11. Results of the AIC test to find the best-fitting model when regressing annual canopy NSC and it's components against predawn water potential. Models with the lowest dAIC within each species and variable were used in the analysis.  
  
<span style='font-size: 0.8em'>  
``` {r echo=FALSE,  eval=TRUE, message=FALSE,warning=FALSE,error=FALSE, include=TRUE,fig.align='center'}
gaic<-theme_vanilla(gaic)
autofit(gaic)
```
<span>  
Table S12. Results of the AIC test to find the best-fitting model when regressing % of maximum growth against predawn water potential. Models with the lowest dAIC within each species and variable were used in the analysis.  
  
<span style='font-size: 0.8em'>  
``` {r echo=FALSE,  eval=TRUE, message=FALSE,warning=FALSE,error=FALSE, include=TRUE,fig.align='center'}
photoaic<-theme_vanilla(photoaic)
autofit(photoaic)
```
<span>  
Table S13. Results of the AIC test to find the best-fitting model when regressing % of maximum photosynthesis against predawn water potential. Although the best fitting model was a regression with an additive polynomial function, we could not determine the x-intercept from this model given the convex shape of the curve ($_{min}f(x)=x+x^2>0$). Any model with a dAIC < 7 is widely considered a valid model in the statistical literature and we therefore used the linear-logarithmic model (i.e. Log) in our analysis.  
  
<span style='font-size: 0.8em'>  
``` {r echo=FALSE,  eval=TRUE, message=FALSE,warning=FALSE,error=FALSE, include=TRUE,fig.align='center'}
mod_tab<-theme_vanilla(mod_tab)
autofit(mod_tab)
```
<span>
Table S14. Effect of model choice on points of growth cessation and stomatal closure for both species. For all models (excepting polynomial), the x-intercept of the model was used to determine cessation points of photosynthesis and growth, respectively. Because the polynomial model has no x-intercept (it's minimum > 0), we used the inflection point of the curve.  
  
  
__References__  









